<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Portfolio</title>
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* RESET & BASICS */
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #1e293b; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        
        /* HEADER FIX */
        .glass-header { 
            position: sticky; top: 0; z-index: 40;
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); 
            border-bottom: 1px solid #e2e8f0;
            /* Allow clicks to pass through empty space */
            pointer-events: none;
        }
        /* Make buttons inside header clickable */
        .glass-header button, .glass-header .logo-area { pointer-events: auto; }

        /* UI ELEMENTS */
        .card { background: #fff; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; transition: transform 0.1s; }
        .input-std { width: 100%; padding: 12px 16px; border: 1px solid #cbd5e1; border-radius: 12px; background: #f8fafc; font-size: 16px; outline: none; }
        .input-std:focus { border-color: #4f46e5; background: #fff; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .btn-press:active { transform: scale(0.95); }
        
        /* NAV */
        .nav-item { padding: 12px 16px; border-radius: 12px; font-weight: 600; color: #64748b; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s; }
        .nav-item.active { background-color: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        
        /* TABLES */
        .clean-table { width: 100%; border-collapse: collapse; }
        .clean-table th { text-align: left; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; padding-bottom: 12px; border-bottom: 1px solid #e2e8f0; }
        .clean-table td { padding: 14px 0; border-bottom: 1px solid #f1f5f9; font-size: 14px; color: #334155; font-weight: 500; }
        .clean-table tr:last-child td { border-bottom: none; }

        /* CALENDAR */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-day { min-height: 80px; background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 4px; display: flex; flex-direction: column; }
        .cal-day.today { border: 2px solid #f59e0b; background: #fffbeb; }
        .bill-pill { font-size: 9px; padding: 2px 4px; background: #eff6ff; color: #1e40af; border-radius: 4px; margin-top: 2px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-left: 3px solid #3b82f6; }
        .bill-pill.adjusted { border-left-color: #f59e0b; background: #fff7ed; color: #9a3412; }

        /* UTILS */
        .privacy-blur { filter: blur(6px); transition: 0.2s; user-select: none; }
        .chart-box { position: relative; height: 260px; width: 100%; }
        .hidden { display: none !important; }
        
        /* FAB */
        .fab { position: fixed; bottom: 25px; right: 20px; width: 56px; height: 56px; background: #4f46e5; color: white; border-radius: 50%; box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.5); display: flex; align-items: center; justify-content: center; font-size: 24px; z-index: 50; transition: transform 0.2s; }
        .fab:active { transform: scale(0.9); }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen overflow-hidden">

    <div id="sidebar" class="w-full md:w-72 bg-[#0f172a] flex flex-col justify-between z-50 hidden md:flex h-full fixed md:relative shadow-2xl transition-all">
        <div class="p-8">
            <div class="flex items-center gap-4 mb-10">
                <img src="icon.png" class="w-12 h-12 rounded-xl shadow-lg" onerror="this.style.display='none'">
                <h1 class="font-bold text-xl text-white leading-tight">Finance<br>Portfolio</h1>
            </div>
            
            <div class="mb-8">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 block">Period</label>
                <input type="month" id="monthPicker" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl font-bold text-white focus:border-indigo-500 outline-none text-center">
            </div>

            <nav class="space-y-2">
                <div onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item active"><i class="fas fa-chart-pie w-5"></i> Dashboard</div>
                <div onclick="switchView('reports')" id="nav-reports" class="nav-item"><i class="fas fa-chart-line w-5"></i> Reports</div>
                <div onclick="switchView('calendar')" id="nav-calendar" class="nav-item"><i class="fas fa-calendar-day w-5"></i> Calendar</div>
                <div onclick="switchView('wealth')" id="nav-wealth" class="nav-item"><i class="fas fa-vault w-5"></i> Net Worth</div>
                <div onclick="switchView('settings')" id="nav-settings" class="nav-item"><i class="fas fa-sliders w-5"></i> Settings</div>
            </nav>
        </div>
        
        <div class="p-6 bg-slate-900 border-t border-slate-800 space-y-3">
            <button onclick="togglePrivacy()" class="w-full py-2 text-xs font-bold text-slate-400 hover:text-white flex items-center gap-2 rounded hover:bg-slate-800 transition"><i id="privIcon" class="fas fa-eye"></i> Privacy Mode</button>
            <div class="flex gap-2">
                <button onclick="exportData()" class="flex-1 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-bold text-xs transition">Backup</button>
                <button onclick="resetData()" class="flex-1 py-3 bg-rose-900/30 text-rose-500 hover:bg-rose-900/50 rounded-xl font-bold text-xs transition">Reset</button>
            </div>
        </div>
    </div>

    <div class="flex-1 flex flex-col h-full overflow-hidden relative">
        
        <div class="md:hidden glass-header px-5 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3 logo-area">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-md"><i class="fas fa-briefcase"></i></div>
                <h1 class="font-bold text-lg text-slate-800">Portfolio</h1>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="togglePrivacy()" class="w-10 h-10 bg-white border border-slate-200 text-slate-600 rounded-full flex items-center justify-center active:scale-90 transition"><i class="fas fa-eye text-sm"></i></button>
                <button onclick="toggleMenu()" class="w-10 h-10 bg-slate-800 text-white rounded-full flex items-center justify-center active:scale-90 transition shadow-lg"><i class="fas fa-bars text-sm"></i></button>
            </div>
        </div>

        <button onclick="document.getElementById('txCard').scrollIntoView({behavior:'smooth'})" class="fab md:hidden"><i class="fas fa-plus"></i></button>

        <div class="flex-1 overflow-y-auto p-5 md:p-10 pb-32">
            
            <div id="view-dashboard" class="view-section fade-in">
                <div class="card p-6 mb-8 border-l-4 border-indigo-600">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">Total Earned <span id="yearLabel"></span></p>
                            <h2 class="text-3xl font-extrabold text-slate-800 privacy-target" id="kpiYTD">£0.00</h2>
                        </div>
                        <div class="text-right cursor-pointer" onclick="editSalary()">
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">Annual Salary <i class="fas fa-pen text-xs ml-1"></i></p>
                            <h2 class="text-3xl font-extrabold text-indigo-600 privacy-target" id="kpiSalary">£0.00</h2>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card p-6"><p class="text-xs text-slate-400 font-bold uppercase mb-1">Income</p><h3 class="text-2xl font-bold text-emerald-600 privacy-target" id="kpiInc">£0.00</h3></div>
                    <div class="card p-6"><p class="text-xs text-slate-400 font-bold uppercase mb-1">Expenses</p><h3 class="text-2xl font-bold text-rose-600 privacy-target" id="kpiExp">£0.00</h3></div>
                    <div class="card p-6"><p class="text-xs text-slate-400 font-bold uppercase mb-1">Net Flow</p><h3 class="text-2xl font-bold text-indigo-600 privacy-target" id="kpiNet">£0.00</h3></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="card p-6"><h3 class="font-bold text-lg text-slate-800 mb-4">Cash Flow</h3><div class="chart-box"><canvas id="chartTrend"></canvas></div></div>
                    <div class="card p-6"><h3 class="font-bold text-lg text-slate-800 mb-4">Spending</h3><div class="chart-box"><canvas id="chartSpend"></canvas></div></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="card p-6 h-fit" id="txCard">
                        <div class="flex justify-between items-center mb-6"><h3 class="font-bold text-lg text-slate-800" id="txTitle">Add Transaction</h3><button id="txCancel" onclick="cancelTx()" class="hidden text-xs text-rose-500 font-bold">Cancel</button></div>
                        <form id="formTx" class="space-y-4">
                            <div class="grid grid-cols-2 gap-2 p-1 bg-slate-100 rounded-xl">
                                <button type="button" onclick="setTxType('expense')" id="btnExp" class="py-3 rounded-lg text-sm font-bold bg-white text-rose-600 shadow-sm transition">Expense</button>
                                <button type="button" onclick="setTxType('income')" id="btnInc" class="py-3 rounded-lg text-sm font-bold text-slate-400 transition">Income</button>
                            </div>
                            <input type="text" id="txDesc" placeholder="Description" class="input-std" required>
                            <div class="flex gap-3">
                                <input type="number" id="txAmt" placeholder="0.00" step="0.01" inputmode="decimal" class="input-std w-1/2" required>
                                <select id="txCat" class="input-std w-1/2 appearance-none bg-white"></select>
                            </div>
                            <div id="extraOptions" class="space-y-3 pt-2">
                                <label class="flex items-center gap-3 p-3 border border-slate-100 rounded-xl cursor-pointer"><input type="checkbox" id="isDebt" class="w-5 h-5 text-indigo-600"> <span class="text-sm font-bold text-slate-600">Debt Payment?</span></label>
                                <select id="debtPicker" class="input-std hidden"></select>
                            </div>
                            <button type="submit" class="w-full py-4 rounded-xl font-bold text-white bg-slate-900 shadow-lg hover:bg-slate-800 transition">Save Transaction</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="card p-6 min-h-[400px]">
                            <h3 class="font-bold text-lg text-slate-800 mb-6">Recent History</h3>
                            <div class="overflow-x-auto">
                                <table class="clean-table">
                                    <thead><tr><th>Description</th><th class="text-right">Amount</th><th class="text-right">Action</th></tr></thead>
                                    <tbody id="listTx"></tbody>
                                </table>
                                <div id="emptyTx" class="hidden py-12 text-center text-slate-400 text-sm">No transactions this month.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-reports" class="view-section hidden fade-in">
                <div class="mb-8"><h2 class="text-2xl font-bold text-slate-800">Monthly Reports</h2></div>
                <div class="card p-6 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="clean-table min-w-[600px]">
                            <thead><tr><th>Month</th><th class="text-right text-emerald-600">Income</th><th class="text-right text-rose-600">Expenses</th><th class="text-right text-indigo-600">Net</th><th class="text-right">Rate</th></tr></thead>
                            <tbody id="listReports"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-calendar" class="view-section hidden fade-in">
                <div class="flex justify-between items-end mb-8">
                    <div><h2 class="text-2xl font-bold text-slate-800">Bill Calendar</h2><p class="text-slate-500 text-sm mt-1">Total Bills: <span id="calTotal" class="font-bold text-indigo-600">£0.00</span></p></div>
                    <button onclick="switchView('settings')" class="text-xs bg-white border border-slate-200 px-4 py-2 rounded-full font-bold shadow-sm">Manage</button>
                </div>
                <div class="card p-4">
                    <div class="grid grid-cols-7 gap-2 mb-2 text-center"><div class="text-[10px] font-bold text-slate-400">M</div><div class="text-[10px] font-bold text-slate-400">T</div><div class="text-[10px] font-bold text-slate-400">W</div><div class="text-[10px] font-bold text-slate-400">T</div><div class="text-[10px] font-bold text-slate-400">F</div><div class="text-[10px] font-bold text-slate-400">S</div><div class="text-[10px] font-bold text-slate-400">S</div></div>
                    <div id="calGrid" class="calendar-grid"></div>
                </div>
            </div>

            <div id="view-wealth" class="view-section hidden fade-in">
                <div class="card bg-slate-900 text-white p-8 mb-8">
                    <div class="flex justify-between items-end">
                        <div><p class="text-slate-400 font-bold uppercase text-[10px] tracking-widest mb-1">Net Worth</p><h1 class="text-5xl font-extrabold tracking-tight privacy-target" id="wealthTotal">£0.00</h1></div>
                        <div class="text-right"><p class="text-[10px] text-slate-400 uppercase font-bold tracking-widest mb-1">Assets / Debts</p><p class="text-sm font-bold text-emerald-400 privacy-target" id="wealthAssets">£0</p><p class="text-sm font-bold text-rose-400 privacy-target" id="wealthDebts">£0</p></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div class="card p-6"><div class="flex justify-between mb-4"><h3 class="font-bold text-lg">Assets</h3><button onclick="openModal('asset')" class="text-xs bg-slate-900 text-white px-3 py-1 rounded-lg">Add</button></div><ul id="listAssets" class="space-y-2"></ul></div>
                        <div class="card p-6 border-l-4 border-rose-500"><div class="flex justify-between mb-4"><h3 class="font-bold text-lg">Liabilities</h3><button onclick="openModal('debt')" class="text-xs bg-rose-600 text-white px-3 py-1 rounded-lg">Add</button></div><ul id="listDebts" class="space-y-2"></ul></div>
                    </div>
                    <div class="card p-6 flex flex-col items-center"><h3 class="font-bold text-lg w-full mb-4">Allocation</h3><div class="chart-box"><canvas id="chartWealth"></canvas></div></div>
                </div>
            </div>

            <div id="view-settings" class="view-section hidden fade-in">
                <div class="card p-8 max-w-2xl mx-auto space-y-8">
                    <h2 class="text-2xl font-bold text-slate-800">Settings</h2>
                    
                    <div><h3 class="font-bold text-slate-800 mb-4">Recurring Bills</h3>
                        <form id="formBill" class="flex gap-2 mb-4"><input type="number" id="billDay" placeholder="Day" class="input-std w-20 text-center" min="1" max="31" required><input type="text" id="billName" placeholder="Name" class="input-std flex-1" required><input type="number" id="billAmt" placeholder="£" class="input-std w-24" step="0.01" required><button type="submit" class="bg-slate-900 text-white w-12 rounded-xl"><i class="fas fa-plus"></i></button></form>
                        <ul id="listBills" class="space-y-2"></ul>
                    </div>

                    <div><h3 class="font-bold text-slate-800 mb-4">Budgets</h3>
                        <form id="formBudget" class="flex gap-2 mb-4"><select id="budgCat" class="input-std flex-1"></select><input type="number" id="budgLim" placeholder="Limit" class="input-std w-24" step="0.01" required><button type="submit" class="bg-emerald-600 text-white w-12 rounded-xl"><i class="fas fa-plus"></i></button></form>
                        <ul id="listBudgets" class="space-y-2"></ul>
                    </div>

                    <div class="pt-8 border-t border-slate-100"><button onclick="resetData()" class="w-full py-3 text-rose-600 font-bold hover:bg-rose-50 rounded-xl transition">Reset All App Data</button></div>
                </div>
            </div>
            
            <div id="modalOverlay" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
                <div class="card p-6 w-full max-w-sm">
                    <h3 class="font-bold text-xl mb-4" id="modalTitle">Add Item</h3>
                    <form id="formWealth" class="space-y-4">
                        <input type="hidden" id="wealthType">
                        <input type="text" id="wealthName" placeholder="Name" class="input-std" required>
                        <input type="number" id="wealthVal" placeholder="Value" step="0.01" class="input-std" required>
                        <div id="wealthCatWrapper"><label class="text-[10px] font-bold text-slate-400 uppercase">Category</label><select id="wealthCat" class="input-std mt-1"><option>Savings</option><option>Investment</option><option>Property</option><option>Pension</option><option>Crypto</option></select></div>
                        <div class="flex gap-3 pt-2"><button type="button" onclick="closeModal()" class="flex-1 py-3 bg-slate-100 font-bold rounded-xl text-slate-600">Cancel</button><button type="submit" class="flex-1 py-3 bg-indigo-600 font-bold rounded-xl text-white">Save</button></div>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- DATA LAYER ---
        const DEFAULTS = { categories: ['Housing','Food','Transport','Utilities','Entertainment','Health','Savings','Debt'], transactions: {}, assets: [], debts: [], recurring: [], budgets: {}, goals: [], billLog: [], annualIncome: 0 };
        let db = JSON.parse(localStorage.getItem('infinityDB')) || DEFAULTS;

        // SANITIZER
        if(Array.isArray(db.transactions)) db.transactions = {}; // Fix crash from old array format
        ['assets','debts','recurring','goals','categories'].forEach(k => { if(!Array.isArray(db[k])) db[k]=[]; });
        
        // GLOBALS
        let privacy = localStorage.getItem('infinityPrivacy') === 'true';
        let txType = 'expense';
        let editId = null;
        let charts = {}; // Store chart instances
        const monthPicker = document.getElementById('monthPicker');
        const now = new Date();
        monthPicker.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

        // HELPERS
        const math = (v) => parseFloat(Number(v||0).toFixed(2));
        const fmt = (n) => parseFloat(n).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const save = () => { localStorage.setItem('infinityDB', JSON.stringify(db)); render(); };
        const getCatColor = (c) => { 
            const m = {'Debt':'#ef4444','Liabilities':'#ef4444','Housing':'#3b82f6','Food':'#f59e0b','Transport':'#06b6d4','Utilities':'#eab308','Entertainment':'#8b5cf6','Health':'#10b981','Savings':'#6366f1'};
            return m[c] || '#94a3b8';
        };

        // --- CORE VIEWS ---
        function switchView(id) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            document.getElementById(`view-${id}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById(`nav-${id}`).classList.add('active');
            
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');
            
            // Force redraw charts if visible
            if(id === 'dashboard' || id === 'wealth') setTimeout(render, 50);
        }

        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('hidden');
            document.getElementById('sidebar').classList.toggle('fixed');
            document.getElementById('sidebar').classList.toggle('inset-0');
        }

        // --- RENDERERS ---
        function render() {
            renderDropdowns();
            renderDashboard();
            renderReports();
            renderCalendar();
            renderWealth();
            renderSettings();
            updatePrivacy();
        }

        function renderDashboard() {
            const k = monthPicker.value;
            const data = db.transactions[k] || [];
            let inc=0, exp=0, cats={};
            const list = document.getElementById('listTx');
            list.innerHTML = '';
            
            data.forEach((t, i) => {
                const v = math(t.amount);
                if(t.type==='income') inc+=v; else { exp+=v; cats[t.category]=(cats[t.category]||0)+v; }
                
                // History List (Top is newest)
                list.insertAdjacentHTML('afterbegin', `
                    <tr class="hover:bg-slate-50 transition border-b border-slate-50 last:border-0">
                        <td class="py-3"><div class="font-bold text-slate-700">${t.desc}</div><div class="text-xs text-slate-400">${t.category}</div></td>
                        <td class="text-right font-bold ${t.type==='income'?'text-emerald-500':'text-slate-700'} privacy-target">${t.type==='income'?'+':'-'}£${fmt(v)}</td>
                        <td class="text-right"><button onclick="editTx(${i})" class="text-indigo-500 px-2"><i class="fas fa-pen"></i></button><button onclick="delTx(${i})" class="text-rose-500 px-2"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `);
            });
            
            document.getElementById('emptyTx').classList.toggle('hidden', data.length > 0);
            document.getElementById('kpiInc').innerText = `£${fmt(inc)}`;
            document.getElementById('kpiExp').innerText = `£${fmt(exp)}`;
            document.getElementById('kpiNet').innerText = `£${fmt(inc-exp)}`;
            
            // Year Salary
            const yr = k.split('-')[0];
            let ytd = 0;
            Object.keys(db.transactions).forEach(mk => { if(mk.startsWith(yr)) db.transactions[mk].forEach(t => { if(t.type==='income') ytd += math(t.amount); }); });
            document.getElementById('kpiYTD').innerText = `£${fmt(ytd)}`;
            document.getElementById('kpiSalary').innerText = `£${fmt(db.annualIncome)}`;
            document.getElementById('yearLabel').innerText = yr;

            drawChart('spendingChart', 'doughnut', { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: Object.keys(cats).map(getCatColor), borderWidth:0 }] });
            
            // Trend
            const l=[], dI=[], dE=[];
            let d = new Date(); d.setMonth(d.getMonth()-5);
            for(let i=0; i<6; i++){
                const mk = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                l.push(d.toLocaleString('default',{month:'short'}));
                const t = db.transactions[mk]||[];
                let _i=0, _e=0;
                t.forEach(x => { if(x.type==='income') _i+=x.amount; else _e+=x.amount; });
                dI.push(_i); dE.push(_e);
                d.setMonth(d.getMonth()+1);
            }
            drawChart('trendChart', 'bar', { labels: l, datasets: [{ label:'In', data:dI, backgroundColor:'#10b981', borderRadius:4 }, { label:'Out', data:dE, backgroundColor:'#f43f5e', borderRadius:4 }] });
        }

        function renderReports() {
            const t = document.getElementById('listReports'); t.innerHTML='';
            const m = Object.keys(db.transactions).sort().reverse();
            const mn = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            
            if(m.length===0) { t.innerHTML='<tr><td colspan="5" class="text-center py-8 text-slate-400">No data</td></tr>'; return; }
            
            m.forEach(k => {
                const tx = db.transactions[k];
                let i=0, e=0;
                tx.forEach(x => { if(x.type==='income') i+=x.amount; else e+=x.amount; });
                const rate = i>0 ? Math.round(((i-e)/i)*100) : 0;
                const p = k.split('-');
                const label = p.length===2 ? `${mn[parseInt(p[1])-1]} ${p[0]}` : k;
                t.innerHTML += `<tr class="hover:bg-slate-50 transition border-b border-slate-50"><td class="font-bold text-slate-700 py-3">${label}</td><td class="text-right text-emerald-600">£${fmt(i)}</td><td class="text-right text-rose-600">£${fmt(e)}</td><td class="text-right text-indigo-600">£${fmt(i-e)}</td><td class="text-right pr-2 text-slate-400">${rate}%</td></tr>`;
            });
        }

        function renderCalendar() {
            const g = document.getElementById('calGrid'); g.innerHTML = '';
            const [y, m] = monthPicker.value.split('-').map(Number);
            const fd = new Date(y, m-1, 1).getDay();
            const pad = fd===0?6:fd-1;
            const dim = new Date(y, m, 0).getDate();
            const now = new Date();

            for(let i=0; i<pad; i++) g.innerHTML += `<div class="cal-day bg-slate-50/50 border-0"></div>`;
            
            let tot = 0;
            for(let i=1; i<=dim; i++) {
                let pills = '';
                let bills = db.recurring.filter(b => b.day === i);
                if(i===dim) { db.recurring.filter(b=>b.day>dim).forEach(b => { b.adj=true; bills.push(b); }); }
                
                bills.forEach(b => { 
                    tot += b.amount;
                    pills += `<div class="bill-pill ${b.adj?'adjusted':''}">${b.adj?'(Adj) ':''}${b.desc}: £${Math.round(b.amount)}</div>`; 
                    delete b.adj; 
                });
                const isToday = (now.getFullYear()===y && now.getMonth()+1===m && now.getDate()===i);
                g.innerHTML += `<div class="cal-day ${isToday?'today':''}"><div class="text-[10px] font-bold text-slate-400 mb-1">${i}</div><div class="flex flex-col gap-1 overflow-hidden">${pills}</div></div>`;
            }
            document.getElementById('calTotal').innerText = `£${fmt(tot)}`;
        }

        function renderWealth() {
            const la=document.getElementById('listAssets'), ld=document.getElementById('listDebts');
            la.innerHTML=''; ld.innerHTML='';
            let ta=0, td=0, types={};
            
            db.assets.forEach((a,i) => { ta+=a.value; types[a.type]=(types[a.type]||0)+a.value; la.innerHTML+=`<li><div class="flex justify-between p-3 bg-slate-50 rounded-xl"><span>${a.name}</span><span>£${fmt(a.value)} <button onclick="delWealth('asset',${i})" class="text-rose-500 ml-2">×</button></span></div></li>`; });
            db.debts.forEach((d,i) => { td+=d.value; ld.innerHTML+=`<li><div class="flex justify-between p-3 bg-slate-50 rounded-xl"><span>${d.name}</span><div class="text-rose-600 font-bold">£${fmt(d.value)} <button onclick="delWealth('debt',${i})" class="text-slate-400 ml-2">×</button></div></div></li>`; });
            if(td>0) types['Debt'] = td;
            
            document.getElementById('wealthTotal').innerText = `£${fmt(ta-td)}`;
            document.getElementById('wealthAssets').innerText = `£${fmt(ta)}`;
            document.getElementById('wealthDebts').innerText = `£${fmt(td)}`;
            
            drawChart('chartWealth', 'doughnut', { labels: Object.keys(types), datasets: [{ data: Object.values(types), backgroundColor: Object.keys(types).map(getCatColor), borderWidth:0 }] });
        }

        function renderSettings() {
            const lb = document.getElementById('listBills'); lb.innerHTML='';
            db.recurring.forEach((b,i) => lb.innerHTML += `<li class="flex justify-between p-3 bg-slate-50 rounded-xl text-sm border border-slate-100"><span>Day ${b.day}: ${b.desc}</span><span>£${fmt(b.amount)} <button onclick="delBill(${i})" class="text-rose-500 ml-2">×</button></span></li>`);
            
            const lbud = document.getElementById('listBudgets'); lbud.innerHTML='';
            Object.keys(db.budgets).forEach(c => lbud.innerHTML += `<li class="flex justify-between p-3 bg-slate-50 rounded-xl text-sm"><span>${c}</span><span>£${fmt(db.budgets[c])} <button onclick="delBudget('${c}')" class="text-rose-500 ml-2">×</button></span></li>`);
        }

        function renderDropdowns() {
            let h = `<optgroup label="Categories">` + db.categories.map(c=>`<option value="${c}">${c}</option>`).join('') + `</optgroup>`;
            if(db.assets.length) h += `<optgroup label="Assets">` + db.assets.map(a=>`<option value="${a.name}">[Asset] ${a.name}</option>`).join('') + `</optgroup>`;
            document.getElementById('txCat').innerHTML = h;
            document.getElementById('budgCat').innerHTML = h;
            const d = document.getElementById('debtPicker'); d.innerHTML = '';
            db.debts.forEach((db, i) => { d.innerHTML += `<option value="${i}">${db.name} (£${fmt(db.value)})</option>`; });
        }

        // --- ACTIONS ---
        function setTxType(t) { 
            currentTxType = t; 
            document.getElementById('btnExp').className = t==='expense' ? 'flex-1 py-3 rounded-lg text-sm font-bold bg-white text-rose-600 shadow-sm transition' : 'flex-1 py-3 rounded-lg text-sm font-bold text-slate-400 transition';
            document.getElementById('btnInc').className = t==='income' ? 'flex-1 py-3 rounded-lg text-sm font-bold bg-white text-emerald-600 shadow-sm transition' : 'flex-1 py-3 rounded-lg text-sm font-bold text-slate-400 transition';
            document.getElementById('extraOptions').classList.toggle('hidden', t==='income');
        }

        // --- CHART ENGINE ---
        function drawChart(id, type, data) {
            const ctx = document.getElementById(id).getContext('2d');
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(ctx, {
                type: type, 
                data: data, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '70%', 
                    scales: type==='bar'?{x:{grid:{display:false}},y:{grid:{display:false},ticks:{callback:v=>Intl.NumberFormat('en',{notation:"compact"}).format(v)}}}:{display:false},
                    plugins: { legend: { display: false }, datalabels: { display: type==='doughnut', color:'#fff', formatter:(v,c)=>c.chart.data.labels[c.dataIndex] } } 
                }
            });
        }

        // --- EVENT HANDLERS ---
        document.getElementById('formTx').onsubmit = e => { e.preventDefault(); 
            const k = monthPicker.value; if(!db.transactions[k]) db.transactions[k] = [];
            const t = { desc: document.getElementById('txDesc').value, amount: math(document.getElementById('txAmt').value), category: document.getElementById('txCat').value, type: currentTxType };
            if(editId!==null) db.transactions[k][editId] = t; else db.transactions[k].push(t);
            // Debt Logic
            if(currentTxType==='expense' && document.getElementById('isDebt').checked) {
                const dIdx = document.getElementById('debtPicker').value;
                if(db.debts[dIdx]) db.debts[dIdx].value = Math.max(0, db.debts[dIdx].value - t.amount);
            }
            editId=null; document.getElementById('formTx').reset(); document.getElementById('txCancel').classList.add('hidden'); document.getElementById('txTitle').innerText="Add Transaction";
            save();
        };

        document.getElementById('formBill').onsubmit = e => { e.preventDefault(); db.recurring.push({day:parseInt(document.getElementById('billDay').value), desc:document.getElementById('billName').value, amount:math(document.getElementById('billAmt').value)}); document.getElementById('formBill').reset(); save(); };
        document.getElementById('formBudget').onsubmit = e => { e.preventDefault(); db.budgets[document.getElementById('budgCat').value] = math(document.getElementById('budgLim').value); document.getElementById('formBudget').reset(); save(); };
        document.getElementById('formWealth').onsubmit = e => { e.preventDefault(); const t=document.getElementById('wealthType').value; const o={name:document.getElementById('wealthName').value, value:math(document.getElementById('wealthVal').value), type:document.getElementById('wealthCat').value}; if(t==='asset') db.assets.push(o); else db.debts.push(o); closeModal(); save(); };
        document.getElementById('catForm').onsubmit = e => { e.preventDefault(); db.categories.push(document.getElementById('newCatName').value); save(); };

        document.getElementById('isDebt').addEventListener('change', e => document.getElementById('debtPicker').classList.toggle('hidden', !e.target.checked));
        monthPicker.addEventListener('change', render);

        // --- GLOBAL FUNCS ---
        function editTx(i) { const t=db.transactions[monthPicker.value][i]; document.getElementById('txDesc').value=t.desc; document.getElementById('txAmt').value=t.amount; document.getElementById('txCat').value=t.category; setTxType(t.type); editId=i; document.getElementById('txCancel').classList.remove('hidden'); document.getElementById('txTitle').innerText="Edit Item"; document.getElementById('txCard').scrollIntoView({behavior:'smooth'}); }
        function cancelTx() { editId=null; document.getElementById('formTx').reset(); document.getElementById('txCancel').classList.add('hidden'); document.getElementById('txTitle').innerText="Add Transaction"; }
        function delTx(i) { db.transactions[monthPicker.value].splice(i,1); save(); }
        function delBill(i) { db.recurring.splice(i,1); save(); }
        function delWealth(t,i) { if(t==='asset') db.assets.splice(i,1); else db.debts.splice(i,1); save(); }
        function delBudget(c) { delete db.budgets[c]; save(); }
        function openModal(t) { document.getElementById('wealthType').value=t; document.getElementById('modalTitle').innerText = t==='asset'?'Add Asset':'Add Liability'; document.getElementById('wealthCatWrapper').classList.toggle('hidden', t==='debt'); document.getElementById('modalOverlay').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modalOverlay').classList.add('hidden'); }
        function editAnnualIncome() { const v=prompt("Annual Salary", db.annualIncome); if(v){db.annualIncome=math(v); save();} }
        function togglePrivacy() { privacy=!privacy; localStorage.setItem('infinityPrivacy', privacy); updatePrivacy(); }
        function updatePrivacy() { document.querySelectorAll('.privacy-target').forEach(e=>e.classList.toggle('privacy-blur', privacy)); }
        function exportData() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(db)); a.download="backup.json"; a.click(); }
        function resetData() { if(confirm("Delete all data?")){ localStorage.removeItem('infinityDB'); location.reload(); } }
        
        function checkBills() {
            const now = new Date(); const d = now.getDate(); const k = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            const lastDay = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
            db.recurring.forEach(b => { if(b.day===d || (d===lastDay && b.day>d)) { const pid=`${b.desc}-${k}`; if(!db.billLog.includes(pid)) { if(!db.transactions[k]) db.transactions[k]=[]; db.transactions[k].push({desc:b.desc, amount:b.amount, category:"Bills", type:"expense"}); db.billLog.push(pid); } } });
            localStorage.setItem('infinityDB', JSON.stringify(db));
        }

        // INIT
        checkBills();
        render();
    </script>
</body>
</html>
