<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Portfolio v7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .card { background-color: #1e293b; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn { transition: all 0.2s; }
        .btn:active { transform: scale(0.95); }
        input, select { background-color: #334155; border: none; color: white; padding: 0.5rem; border-radius: 6px; width: 100%; }
        input:focus, select:focus { outline: 2px solid #3b82f6; }
    </style>
</head>
<body class="p-4 md:p-8 max-w-7xl mx-auto">

    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <div>
            <h1 class="text-3xl font-bold text-white"><i class="fas fa-wallet text-blue-500 mr-2"></i>Finance Portfolio</h1>
            <p class="text-slate-400 text-sm">Centralized Cloud System</p>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleSettings()" class="btn bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded text-white">
                <i class="fas fa-cog"></i>
            </button>
            <button onclick="syncData()" id="syncBtn" class="btn bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded text-white font-bold flex items-center gap-2">
                <i class="fas fa-sync-alt" id="syncIcon"></i> <span id="syncText">Sync Now</span>
            </button>
        </div>
    </div>

    <div id="settingsPanel" class="hidden mb-6 card border-l-4 border-blue-500">
        <h3 class="font-bold text-lg mb-2">Cloud Connection</h3>
        <p class="text-sm text-slate-400 mb-2">Paste your Google Script URL here:</p>
        <input type="text" id="cloudUrlInput" placeholder="https://script.google.com/..." class="mb-2">
        <button onclick="saveSettings()" class="bg-green-600 text-white px-4 py-1 rounded text-sm mt-2">Save URL</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="card">
            <h3 class="text-slate-400 text-sm font-bold uppercase mb-2">Annual Income Target</h3>
            <div class="flex items-center gap-2">
                <span class="text-2xl font-bold text-green-400">Â£</span>
                <input type="number" id="annualIncomeInput" value="27000" onchange="updateIncomeTarget(this.value)" class="text-2xl font-bold bg-transparent border-b border-slate-600 focus:border-green-500 w-full p-0">
            </div>
            <p class="text-xs text-slate-500 mt-2">Auto-saves on change</p>
        </div>

        <div class="card">
            <h3 class="text-slate-400 text-sm font-bold uppercase mb-2">This Month's Spend</h3>
            <div class="text-3xl font-bold text-red-400" id="monthSpendDisplay">Â£0.00</div>
            <p class="text-xs text-slate-500 mt-1" id="monthNameDisplay">Current Month</p>
        </div>

        <div class="card">
            <h3 class="text-slate-400 text-sm font-bold uppercase mb-2">Net Wealth</h3>
            <div class="text-3xl font-bold text-blue-400" id="netWealthDisplay">Â£0.00</div>
            <div class="flex justify-between text-xs mt-2">
                <span class="text-green-500">Assets: <span id="totalAssets">Â£0</span></span>
                <span class="text-red-500">Debts: <span id="totalDebts">Â£0</span></span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <div class="card">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-exchange-alt text-yellow-500"></i> New Transaction</h2>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <input type="date" id="tDate">
                <select id="tType">
                    <option value="expense">Expense</option>
                    <option value="income">Income</option>
                </select>
            </div>
            <input type="text" id="tDesc" placeholder="Description (e.g., Tesco, Fuel)" class="mb-3">
            <div class="grid grid-cols-2 gap-3 mb-3">
                <input type="number" id="tAmount" placeholder="Amount (0.00)" step="0.01">
                <select id="tCategory">
                    <option value="Food">Food</option>
                    <option value="Bills">Bills</option>
                    <option value="Transport">Transport</option>
                    <option value="Entertainment">Entertainment</option>
                    <option value="Housing">Housing</option>
                    <option value="Health">Health</option>
                    <option value="Savings">Savings</option>
                    <option value="Debt">Debt</option>
                    <option value="Investments">Investments</option>
                    <option value="Subscription">Subscription</option>
                    <option value="Payslip">Payslip</option>
                    <option value="Tech">Tech</option>
                    <option value="Eating/Drinking Out">Eating Out</option>
                    <option value="Bday/Xmas">Gifts</option>
                </select>
            </div>
            <button onclick="addTransaction()" class="btn w-full bg-blue-600 py-2 rounded font-bold">Add Transaction</button>

            <h3 class="font-bold mt-6 mb-2 text-sm text-slate-400">Recent Activity</h3>
            <div id="transactionList" class="space-y-2 max-h-64 overflow-y-auto pr-2">
                </div>
        </div>

        <div class="card">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-landmark text-purple-500"></i> Assets & Debts</h2>
            
            <div class="flex gap-2 mb-3">
                <input type="text" id="wName" placeholder="Name (e.g. Monzo Loan)">
                <input type="number" id="wValue" placeholder="Value">
            </div>
            <div class="flex gap-2 mb-3">
                <select id="wType">
                    <option value="asset">Asset (Savings/House)</option>
                    <option value="debt">Debt (Loan/Credit Card)</option>
                </select>
                <button onclick="addWealthItem()" class="btn bg-purple-600 px-4 rounded font-bold">+</button>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-4">
                <div>
                    <h4 class="text-green-500 font-bold text-sm mb-2">Assets</h4>
                    <ul id="assetList" class="text-sm space-y-1"></ul>
                </div>
                <div>
                    <h4 class="text-red-500 font-bold text-sm mb-2">Debts</h4>
                    <ul id="debtList" class="text-sm space-y-1"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STRUCTURE ---
        let db = {
            transactions: {},
            wealth: { assets: [], debts: [] },
            bills: [],
            annualIncome: 27000,
            cloudURL: localStorage.getItem('finance_cloud_url') || ""
        };

        // Initialize
        window.onload = function() {
            document.getElementById('tDate').valueAsDate = new Date();
            document.getElementById('cloudUrlInput').value = db.cloudURL;
            renderAll();
            // Try to sync on load if URL exists
            if(db.cloudURL) syncData(); 
        };

        // --- CORE FUNCTIONS ---

        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('hidden');
        }

        function saveSettings() {
            const url = document.getElementById('cloudUrlInput').value.trim();
            if(url) {
                db.cloudURL = url;
                localStorage.setItem('finance_cloud_url', url);
                alert("URL Saved! Try syncing now.");
                toggleSettings();
            }
        }

        function updateIncomeTarget(val) {
            db.annualIncome = parseFloat(val) || 0;
            // Note: We don't auto-sync here to save bandwidth, user must click Sync
        }

        function addTransaction() {
            const date = document.getElementById('tDate').value;
            const desc = document.getElementById('tDesc').value;
            const amount = parseFloat(document.getElementById('tAmount').value);
            const type = document.getElementById('tType').value; // income or expense
            const cat = document.getElementById('tCategory').value;

            if (!desc || isNaN(amount)) return alert("Please enter description and amount");

            const monthKey = date.substring(0, 7); // "2026-01"
            if (!db.transactions[monthKey]) db.transactions[monthKey] = [];

            const newTx = {
                id: Date.now().toString(36),
                date: date,
                desc: desc,
                amount: amount,
                type: type,
                category: cat,
                updatedAt: Date.now()
            };

            db.transactions[monthKey].unshift(newTx);
            renderAll();
            
            // Clear inputs
            document.getElementById('tDesc').value = '';
            document.getElementById('tAmount').value = '';
        }

        function addWealthItem() {
            const name = document.getElementById('wName').value;
            const val = parseFloat(document.getElementById('wValue').value);
            const type = document.getElementById('wType').value; // asset or debt

            if (!name || isNaN(val)) return;

            const item = { name: name, value: val, type: type, id: Date.now().toString() };

            if (type === 'asset') db.wealth.assets.push(item);
            else db.wealth.debts.push(item);

            renderAll();
            document.getElementById('wName').value = '';
            document.getElementById('wValue').value = '';
        }

        function deleteWealth(type, index) {
            if(type === 'asset') db.wealth.assets.splice(index, 1);
            else db.wealth.debts.splice(index, 1);
            renderAll();
        }

        // --- RENDERING UI ---

        function renderAll() {
            // 1. Annual Income (The Fix is also handled in Sync, but we render local state here)
            document.getElementById('annualIncomeInput').value = db.annualIncome;

            // 2. Current Month Spend
            const currentMonth = new Date().toISOString().substring(0, 7);
            const monthTx = db.transactions[currentMonth] || [];
            
            let totalSpend = 0;
            let txHtml = '';

            monthTx.forEach(tx => {
                if (tx.type === 'expense') totalSpend += tx.amount;
                
                // Build list HTML
                const icon = tx.type === 'income' ? '<i class="fas fa-arrow-down text-green-500"></i>' : '<i class="fas fa-arrow-up text-red-500"></i>';
                const color = tx.type === 'income' ? 'text-green-400' : 'text-slate-200';
                
                txHtml += `
                    <div class="flex justify-between items-center bg-slate-800 p-2 rounded border-l-4 ${tx.type === 'income' ? 'border-green-500' : 'border-red-500'}">
                        <div class="flex items-center gap-2">
                            ${icon}
                            <div>
                                <div class="font-bold text-sm ${color}">${tx.desc}</div>
                                <div class="text-xs text-slate-500">${tx.date} â€¢ ${tx.category}</div>
                            </div>
                        </div>
                        <div class="font-bold ${color}">Â£${tx.amount.toFixed(2)}</div>
                    </div>
                `;
            });

            document.getElementById('monthSpendDisplay').innerText = `Â£${totalSpend.toFixed(2)}`;
            document.getElementById('monthNameDisplay').innerText = `Total Expenses in ${currentMonth}`;
            document.getElementById('transactionList').innerHTML = txHtml;

            // 3. Wealth
            let assetsTotal = 0;
            let debtsTotal = 0;
            
            document.getElementById('assetList').innerHTML = db.wealth.assets.map((a, i) => {
                assetsTotal += a.value;
                return `<li class="flex justify-between bg-slate-800 p-1 px-2 rounded"><span>${a.name}</span> <span class="text-green-400">Â£${a.value} <i onclick="deleteWealth('asset', ${i})" class="fas fa-times text-slate-600 cursor-pointer ml-2"></i></span></li>`;
            }).join('');

            document.getElementById('debtList').innerHTML = db.wealth.debts.map((d, i) => {
                debtsTotal += d.value;
                return `<li class="flex justify-between bg-slate-800 p-1 px-2 rounded"><span>${d.name}</span> <span class="text-red-400">Â£${d.value} <i onclick="deleteWealth('debt', ${i})" class="fas fa-times text-slate-600 cursor-pointer ml-2"></i></span></li>`;
            }).join('');

            document.getElementById('totalAssets').innerText = `Â£${assetsTotal.toFixed(0)}`;
            document.getElementById('totalDebts').innerText = `Â£${debtsTotal.toFixed(0)}`;
            
            const netWorth = assetsTotal - debtsTotal;
            document.getElementById('netWealthDisplay').innerText = `Â£${netWorth.toFixed(2)}`;
        }

        // --- CLOUD SYNC ENGINE (THE IMPORTANT PART) ---

        async function syncData() {
            if (!db.cloudURL) return alert("Please set Cloud URL in settings first!");
            
            const btn = document.getElementById('syncBtn');
            const icon = document.getElementById('syncIcon');
            const txt = document.getElementById('syncText');
            
            // UI Loading State
            btn.classList.remove('bg-blue-600', 'bg-green-600', 'bg-red-600');
            btn.classList.add('bg-yellow-500');
            icon.classList.add('fa-spin');
            txt.innerText = "Syncing...";

            try {
                // 1. PULL (GET)
                const response = await fetch(db.cloudURL + "?t=" + Date.now());
                const cloudData = await response.json();

                if (cloudData.status === "new" || cloudData.transactions) {
                    // MERGE DATA
                    // We prioritize Cloud data, but if we have local changes, simple apps usually just overwrite local with cloud 
                    // or define a "master". Here we will Load Cloud -> Apply to UI.
                    
                    if(cloudData.transactions) db.transactions = cloudData.transactions;
                    if(cloudData.wealth) db.wealth = cloudData.wealth;
                    if(cloudData.bills) db.bills = cloudData.bills;

                    // --- ðŸš¨ THE FIX FOR ANNUAL INCOME ðŸš¨ ---
                    if (cloudData.annualIncome !== undefined && cloudData.annualIncome !== null) {
                        db.annualIncome = cloudData.annualIncome;
                    }
                    // ---------------------------------------

                    renderAll(); // Update UI with Cloud Data

                    // 2. PUSH (POST) - Immediately save back to ensure consistency
                    // (This effectively saves any local changes you might have made before clicking sync)
                    await fetch(db.cloudURL, {
                        method: 'POST',
                        body: JSON.stringify(db)
                    });

                    // Success State
                    btn.classList.remove('bg-yellow-500');
                    btn.classList.add('bg-green-600');
                    icon.classList.remove('fa-spin');
                    txt.innerText = "Synced";
                    
                    setTimeout(() => {
                        btn.classList.remove('bg-green-600');
                        btn.classList.add('bg-blue-600');
                        txt.innerText = "Sync Now";
                    }, 2000);

                } else {
                    throw new Error("Invalid Cloud Data");
                }

            } catch (err) {
                console.error(err);
                btn.classList.remove('bg-yellow-500');
                btn.classList.add('bg-red-600');
                icon.classList.remove('fa-spin');
                txt.innerText = "Error";
                alert("Sync Failed: " + err.message);
            }
        }
    </script>
</body>
</html>
