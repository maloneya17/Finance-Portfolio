<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Web</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* WEB LAYOUT ENGINE */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            color: #1e293b; 
            display: flex; /* Creates the Left/Right Split */
            height: 100vh; 
            overflow: hidden; 
        }
        
        /* SIDEBAR (The Tabs) */
        #sidebar {
            width: 280px; 
            background-color: #0f172a; 
            color: white;
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
            padding: 30px;
            flex-shrink: 0; /* Prevents shrinking */
        }

        /* MAIN CONTENT */
        #main-content {
            flex-grow: 1; /* Takes remaining space */
            overflow-y: auto; /* Allows scrolling inside content only */
            padding: 40px;
            background-color: #f1f5f9;
        }

        /* NAVIGATION TABS */
        .nav-item {
            display: flex; 
            align-items: center; 
            gap: 12px;
            padding: 14px 16px; 
            border-radius: 12px; 
            font-weight: 600; 
            color: #94a3b8; 
            cursor: pointer; 
            transition: all 0.2s;
            margin-bottom: 4px;
        }
        .nav-item:hover { background-color: #1e293b; color: white; }
        .nav-item.active { background-color: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .nav-item i { width: 24px; text-align: center; }

        /* UI CARDS */
        .card { background: white; border-radius: 20px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; margin-bottom: 24px; }
        .input-std { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 14px; outline: none; }
        .input-std:focus { border-color: #4f46e5; ring: 2px solid #e0e7ff; }

        /* STATUS DOT */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #64748b; display: inline-block; margin-right: 8px; }
        .status-dot.online { background: #10b981; box-shadow: 0 0 0 4px rgba(16,185,129,0.2); }

        /* UTILS */
        .hidden { display: none !important; }
        .chart-box { height: 300px; width: 100%; position: relative; }
        .bill-pill { font-size: 10px; padding: 4px 8px; background: #eef2ff; color: #4338ca; border-radius: 6px; margin-top: 4px; font-weight: 700; border-left: 3px solid #4f46e5; }
        
        /* CALENDAR */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .cal-day { min-height: 100px; background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 8px; }
        .cal-day.today { border: 2px solid #f59e0b; background: #fffbeb; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div>
            <div class="flex items-center gap-3 mb-10">
                <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center shadow-lg"><i class="fas fa-wallet text-white"></i></div>
                <div>
                    <h1 class="font-bold text-lg leading-tight">Finance<br>Portfolio</h1>
                    <div class="text-[10px] text-slate-400 flex items-center mt-1"><div class="status-dot" id="dot"></div> <span id="statusText">Local</span></div>
                </div>
            </div>

            <div class="mb-8">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 block">Timeframe</label>
                <input type="month" id="monthPicker" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl font-bold text-white outline-none">
            </div>

            <nav>
                <div onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item active"><i class="fas fa-chart-pie"></i> Dashboard</div>
                <div onclick="switchView('reports')" id="nav-reports" class="nav-item"><i class="fas fa-chart-line"></i> Reports</div>
                <div onclick="switchView('calendar')" id="nav-calendar" class="nav-item"><i class="fas fa-calendar-day"></i> Calendar</div>
                <div onclick="switchView('wealth')" id="nav-wealth" class="nav-item"><i class="fas fa-vault"></i> Net Worth</div>
                <div onclick="switchView('settings')" id="nav-settings" class="nav-item"><i class="fas fa-sliders-h"></i> Settings</div>
            </nav>
        </div>

        <div class="pt-6 border-t border-slate-800">
            <button onclick="manualSync()" id="syncBtn" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold text-sm transition mb-3">Sync Cloud</button>
            <div class="flex gap-2">
                <button onclick="exportData()" class="flex-1 py-2 bg-slate-800 text-slate-300 text-xs font-bold rounded-lg hover:bg-slate-700">Backup</button>
                <button onclick="resetData()" class="flex-1 py-2 bg-rose-900/30 text-rose-400 text-xs font-bold rounded-lg hover:bg-rose-900/50">Reset</button>
            </div>
        </div>
    </div>

    <div id="main-content">
        
        <div id="view-dashboard" class="view-section">
            <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
            
            <div class="grid grid-cols-4 gap-6 mb-8">
                <div class="card !mb-0 border-l-4 border-emerald-500">
                    <p class="text-xs text-slate-400 font-bold uppercase">Income</p>
                    <h3 class="text-2xl font-bold text-emerald-600" id="kpiInc">£0.00</h3>
                </div>
                <div class="card !mb-0 border-l-4 border-rose-500">
                    <p class="text-xs text-slate-400 font-bold uppercase">Expenses</p>
                    <h3 class="text-2xl font-bold text-rose-600" id="kpiExp">£0.00</h3>
                </div>
                <div class="card !mb-0 border-l-4 border-indigo-500">
                    <p class="text-xs text-slate-400 font-bold uppercase">Net Flow</p>
                    <h3 class="text-2xl font-bold text-indigo-600" id="kpiNet">£0.00</h3>
                </div>
                <div class="card !mb-0 bg-slate-900 text-white border-none">
                    <p class="text-xs text-slate-400 font-bold uppercase">YTD Income</p>
                    <h3 class="text-2xl font-bold text-white" id="kpiYTD">£0.00</h3>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-8">
                <div class="card h-fit">
                    <h3 class="font-bold text-lg mb-4">Add Transaction</h3>
                    <form id="formTx" class="space-y-4">
                        <div class="flex gap-2">
                            <button type="button" onclick="setTxType('expense')" id="btnExp" class="flex-1 py-2 bg-rose-100 text-rose-600 rounded-lg font-bold text-sm">Expense</button>
                            <button type="button" onclick="setTxType('income')" id="btnInc" class="flex-1 py-2 text-slate-400 rounded-lg font-bold text-sm">Income</button>
                        </div>
                        <input type="text" id="txDesc" placeholder="Description" class="input-std" required>
                        <div class="flex gap-2">
                            <input type="number" id="txAmt" placeholder="0.00" step="0.01" class="input-std w-1/2" required>
                            <select id="txCat" class="input-std w-1/2 bg-white"></select>
                        </div>
                        <button type="submit" class="w-full py-3 bg-slate-900 text-white rounded-lg font-bold text-sm hover:bg-slate-800">Save</button>
                    </form>
                </div>

                <div class="col-span-2 space-y-6">
                    <div class="card">
                        <h3 class="font-bold text-lg mb-4">Cash Flow Analysis</h3>
                        <div class="chart-box"><canvas id="chartTrend"></canvas></div>
                    </div>
                    <div class="card">
                        <h3 class="font-bold text-lg mb-4">Recent History</h3>
                        <table class="w-full text-left border-collapse">
                            <thead><tr class="text-xs text-slate-400 uppercase border-b border-slate-100">
                                <th class="py-2">Description</th><th class="py-2 text-right">Amount</th><th class="py-2 text-right">Action</th>
                            </tr></thead>
                            <tbody id="listTx" class="text-sm"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-reports" class="view-section hidden">
            <h2 class="text-2xl font-bold mb-6">Monthly Reports</h2>
            <div class="card">
                <table class="w-full text-left">
                    <thead><tr class="text-xs text-slate-400 uppercase border-b border-slate-100">
                        <th class="py-3">Month</th>
                        <th class="py-3 text-right text-emerald-600">Income</th>
                        <th class="py-3 text-right text-rose-600">Expenses</th>
                        <th class="py-3 text-right text-indigo-600">Net</th>
                        <th class="py-3 text-right">Rate</th>
                    </tr></thead>
                    <tbody id="listReports" class="text-sm font-semibold text-slate-700"></tbody>
                </table>
            </div>
        </div>

        <div id="view-calendar" class="view-section hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Bill Calendar</h2>
                <p class="text-slate-500 font-bold">Total: <span id="calTotal" class="text-indigo-600">£0.00</span></p>
            </div>
            <div class="card p-6">
                <div class="grid grid-cols-7 gap-2 mb-4 text-center">
                    <div class="text-xs font-bold text-slate-400 uppercase">Mon</div>
                    <div class="text-xs font-bold text-slate-400 uppercase">Tue</div>
                    <div class="text-xs font-bold text-slate-400 uppercase">Wed</div>
                    <div class="text-xs font-bold text-slate-400 uppercase">Thu</div>
                    <div class="text-xs font-bold text-slate-400 uppercase">Fri</div>
                    <div class="text-xs font-bold text-slate-400 uppercase">Sat</div>
                    <div class="text-xs font-bold text-slate-400 uppercase">Sun</div>
                </div>
                <div id="calGrid" class="cal-grid"></div>
            </div>
        </div>

        <div id="view-wealth" class="view-section hidden">
            <h2 class="text-2xl font-bold mb-6">Net Worth</h2>
            <div class="grid grid-cols-3 gap-8">
                <div class="card bg-slate-900 text-white p-8">
                    <p class="text-xs text-slate-400 font-bold uppercase mb-2">Total Net Worth</p>
                    <h1 class="text-5xl font-extrabold" id="wealthTotal">£0.00</h1>
                </div>
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">Assets</h3>
                    <form id="formWealth" class="flex gap-2 mb-4">
                        <input type="text" id="wName" placeholder="Name" class="input-std flex-1" required>
                        <input type="number" id="wVal" placeholder="£" class="input-std w-24" required>
                        <button type="submit" onclick="addAsset()" class="bg-emerald-600 text-white w-10 rounded-lg"><i class="fas fa-plus"></i></button>
                    </form>
                    <ul id="listAssets" class="space-y-2 text-sm"></ul>
                </div>
                <div class="card border-l-4 border-rose-500">
                    <h3 class="font-bold text-lg mb-4">Liabilities</h3>
                    <form id="formDebt" class="flex gap-2 mb-4">
                        <input type="text" id="dName" placeholder="Name" class="input-std flex-1" required>
                        <input type="number" id="dVal" placeholder="£" class="input-std w-24" required>
                        <button type="submit" onclick="addDebt()" class="bg-rose-600 text-white w-10 rounded-lg"><i class="fas fa-plus"></i></button>
                    </form>
                    <ul id="listDebts" class="space-y-2 text-sm"></ul>
                </div>
            </div>
        </div>

        <div id="view-settings" class="view-section hidden">
            <h2 class="text-2xl font-bold mb-6">Settings</h2>
            <div class="grid grid-cols-2 gap-8 max-w-4xl">
                <div class="card">
                    <h3 class="font-bold text-lg mb-4 text-indigo-600">Cloud Sync</h3>
                    <p class="text-xs text-slate-500 mb-4">Paste your Google Web App URL (must end in /exec)</p>
                    <form id="formCloud" class="flex gap-2">
                        <input type="text" id="cloudInput" placeholder="https://script.google.com/..." class="input-std" required>
                        <button type="submit" class="bg-indigo-600 text-white px-4 rounded-lg font-bold text-sm">Link</button>
                    </form>
                </div>
                <div class="card">
                    <h3 class="font-bold text-lg mb-4">Recurring Bills</h3>
                    <form id="formBill" class="flex gap-2 mb-4">
                        <input type="number" id="billDay" placeholder="Day" class="input-std w-16" min="1" max="31" required>
                        <input type="text" id="billName" placeholder="Bill Name" class="input-std flex-1" required>
                        <input type="number" id="billAmt" placeholder="£" class="input-std w-20" required>
                        <button type="submit" class="bg-slate-900 text-white w-10 rounded-lg"><i class="fas fa-plus"></i></button>
                    </form>
                    <ul id="listBills" class="space-y-2 text-sm"></ul>
                </div>
            </div>
        </div>

    </div>

    <script>
        // 1. DATABASE
        const DEFAULTS = { categories: ['Housing','Food','Transport','Utilities','Entertainment','Health','Savings','Debt'], transactions: {}, assets: [], debts: [], recurring: [], annualIncome: 0 };
        let db = JSON.parse(localStorage.getItem('infinityDB')) || DEFAULTS;
        let cloudUrl = localStorage.getItem('infinityCloudUrl') || "";
        let currentTxType = 'expense';
        let trendChart;

        // 2. CORE FUNCTIONS
        const math = (v) => parseFloat(Number(v || 0).toFixed(2));
        const fmt = (n) => parseFloat(n).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const save = () => { localStorage.setItem('infinityDB', JSON.stringify(db)); if(cloudUrl) saveToCloud(); render(); };

        function switchView(view) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById(`nav-${view}`).classList.add('active');
            if(view === 'dashboard') setTimeout(renderDashboard, 50); // Redraw charts
        }

        // 3. RENDERERS
        function render() {
            renderDashboard();
            renderReports();
            renderCalendar();
            renderWealth();
            renderSettings();
            updateCloudStatus();
        }

        function renderDashboard() {
            const k = document.getElementById('monthPicker').value;
            const data = db.transactions[k] || [];
            let inc=0, exp=0, ytd=0;
            const list = document.getElementById('listTx'); list.innerHTML = '';

            data.forEach((t, i) => {
                const v = math(t.amount);
                if(t.type === 'income') inc += v; else exp += v;
                list.insertAdjacentHTML('afterbegin', `<tr class="border-b border-slate-50 hover:bg-slate-50"><td class="py-2 font-bold text-slate-700">${t.desc}<br><span class="text-[10px] text-slate-400 font-normal uppercase">${t.category}</span></td><td class="text-right ${t.type==='income'?'text-emerald-600':'text-slate-700'}">£${fmt(v)}</td><td class="text-right"><button onclick="delTx(${i})" class="text-rose-400 hover:text-rose-600"><i class="fas fa-trash-alt"></i></button></td></tr>`);
            });

            document.getElementById('kpiInc').innerText = `£${fmt(inc)}`;
            document.getElementById('kpiExp').innerText = `£${fmt(exp)}`;
            document.getElementById('kpiNet').innerText = `£${fmt(inc-exp)}`;

            // YTD
            const yr = k.split('-')[0];
            Object.keys(db.transactions).forEach(mk => { if(mk.startsWith(yr)) db.transactions[mk].forEach(t => { if(t.type==='income') ytd += math(t.amount); }); });
            document.getElementById('kpiYTD').innerText = `£${fmt(ytd)}`;

            // Chart
            const ctx = document.getElementById('chartTrend').getContext('2d');
            if(trendChart) trendChart.destroy();
            const l=[], dI=[], dE=[];
            let d = new Date(); d.setMonth(d.getMonth()-5);
            for(let i=0; i<6; i++){
                const mk = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                l.push(d.toLocaleString('default',{month:'short'}));
                let _i=0, _e=0; (db.transactions[mk]||[]).forEach(t=>{if(t.type==='income')_i+=t.amount;else _e+=t.amount});
                dI.push(_i); dE.push(_e); d.setMonth(d.getMonth()+1);
            }
            trendChart = new Chart(ctx, { type: 'bar', data: { labels: l, datasets: [{label:'In', data:dI, backgroundColor:'#10b981', borderRadius:4}, {label:'Out', data:dE, backgroundColor:'#f43f5e', borderRadius:4}] }, options: { responsive: true, maintainAspectRatio: false, scales: { x:{grid:{display:false}}, y:{display:false} }, plugins:{legend:{display:false}} } });
        }

        function renderReports() {
            const t = document.getElementById('listReports'); t.innerHTML = '';
            const m = Object.keys(db.transactions).sort().reverse();
            m.forEach(k => {
                const tx = db.transactions[k];
                let i=0, e=0; tx.forEach(x => { if(x.type==='income') i+=x.amount; else e+=x.amount; });
                t.innerHTML += `<tr class="border-b border-slate-100 hover:bg-slate-50"><td class="py-3 font-bold">${k}</td><td class="text-right text-emerald-600">£${fmt(i)}</td><td class="text-right text-rose-600">£${fmt(e)}</td><td class="text-right text-indigo-600 font-bold">£${fmt(i-e)}</td><td class="text-right text-slate-400">${i>0?Math.round(((i-e)/i)*100):0}%</td></tr>`;
            });
        }

        function renderCalendar() {
            const g = document.getElementById('calGrid'); g.innerHTML = '';
            const [y, m] = document.getElementById('monthPicker').value.split('-').map(Number);
            const pad = (new Date(y, m-1, 1).getDay() + 6) % 7; // Mon start
            const dim = new Date(y, m, 0).getDate();
            
            for(let i=0; i<pad; i++) g.innerHTML += `<div></div>`;
            for(let i=1; i<=dim; i++) {
                let pills = '';
                db.recurring.filter(b => b.day === i).forEach(b => pills += `<div class="bill-pill">${b.desc}</div>`);
                g.innerHTML += `<div class="cal-day bg-white border border-slate-100 rounded-lg p-2 min-h-[80px]"><div class="text-xs font-bold text-slate-400">${i}</div>${pills}</div>`;
            }
            const tot = db.recurring.reduce((s, b) => s + b.amount, 0);
            document.getElementById('calTotal').innerText = `£${fmt(tot)}`;
        }

        function renderWealth() {
            const la=document.getElementById('listAssets'), ld=document.getElementById('listDebts'); la.innerHTML=''; ld.innerHTML='';
            let ta=0, td=0;
            db.assets.forEach((a,i) => { ta+=a.value; la.innerHTML+=`<li class="flex justify-between p-3 bg-slate-50 rounded-lg"><span>${a.name}</span><span>£${fmt(a.value)} <button onclick="delWealth('asset',${i})" class="text-rose-500 ml-2">×</button></span></li>`; });
            db.debts.forEach((d,i) => { td+=d.value; ld.innerHTML+=`<li class="flex justify-between p-3 bg-slate-50 rounded-lg"><span>${d.name}</span><span>£${fmt(d.value)} <button onclick="delWealth('debt',${i})" class="text-rose-500 ml-2">×</button></span></li>`; });
            document.getElementById('wealthTotal').innerText = `£${fmt(ta-td)}`;
        }

        function renderSettings() {
            const lb = document.getElementById('listBills'); lb.innerHTML='';
            db.recurring.forEach((b,i) => lb.innerHTML += `<li class="flex justify-between p-3 bg-slate-50 rounded-lg border border-slate-200"><span>Day ${b.day}: ${b.desc}</span><span>£${fmt(b.amount)} <button onclick="delBill(${i})" class="text-rose-500 ml-2">×</button></span></li>`);
            
            const sel = document.getElementById('txCat'); sel.innerHTML = '';
            db.categories.forEach(c => sel.innerHTML += `<option>${c}</option>`);
        }

        // 4. CLOUD LOGIC
        function updateCloudStatus() {
            const dot = document.getElementById('dot');
            const txt = document.getElementById('statusText');
            if(cloudUrl) { dot.classList.add('online'); txt.innerText = "Cloud Active"; }
            else { dot.classList.remove('online'); txt.innerText = "Local Storage"; }
        }

        document.getElementById('formCloud').onsubmit = async e => {
            e.preventDefault();
            const url = document.getElementById('cloudUrlInput').value;
            try {
                const res = await fetch(url);
                if(res.ok) {
                    cloudUrl = url; localStorage.setItem('infinityCloudUrl', url);
                    const d = await res.json();
                    if(d && d.categories) { if(confirm("Cloud data found. Load it?")) { db=d; save(); } }
                    else saveToCloud();
                    alert("Linked!"); render();
                } else throw new Error();
            } catch(e) { alert("Connection Failed. Check URL."); }
        };

        async function saveToCloud() {
            if(cloudUrl) await fetch(cloudUrl, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify(db) });
        }

        // 5. HANDLERS
        function setTxType(t) { currentTxType = t; document.getElementById('btnExp').className = t==='expense' ? 'flex-1 py-2 bg-rose-100 text-rose-600 rounded-lg font-bold text-sm' : 'flex-1 py-2 text-slate-400 rounded-lg font-bold text-sm'; document.getElementById('btnInc').className = t==='income' ? 'flex-1 py-2 bg-emerald-100 text-emerald-600 rounded-lg font-bold text-sm' : 'flex-1 py-2 text-slate-400 rounded-lg font-bold text-sm'; }
        
        document.getElementById('formTx').onsubmit = e => { e.preventDefault(); const k=document.getElementById('monthPicker').value; if(!db.transactions[k]) db.transactions[k]=[]; db.transactions[k].push({ desc: document.getElementById('txDesc').value, amount: math(document.getElementById('txAmt').value), category: document.getElementById('txCat').value, type: currentTxType }); document.getElementById('formTx').reset(); save(); };
        document.getElementById('formBill').onsubmit = e => { e.preventDefault(); db.recurring.push({ day:parseInt(document.getElementById('billDay').value), desc:document.getElementById('billDesc').value, amount:math(document.getElementById('billAmt').value) }); document.getElementById('formBill').reset(); save(); };
        
        function addAsset() { e.preventDefault(); db.assets.push({name:document.getElementById('wName').value, value:math(document.getElementById('wVal').value), type:'Asset'}); save(); }
        function addDebt() { e.preventDefault(); db.debts.push({name:document.getElementById('dName').value, value:math(document.getElementById('dVal').value), type:'Debt'}); save(); }
        
        window.delTx = (i) => { db.transactions[document.getElementById('monthPicker').value].splice(i,1); save(); };
        window.delBill = (i) => { db.recurring.splice(i,1); save(); };
        window.delWealth = (t,i) => { if(t==='asset') db.assets.splice(i,1); else db.debts.splice(i,1); save(); };
        window.manualSync = () => { if(cloudUrl){ saveToCloud(); alert("Synced"); } else alert("Link Cloud First"); };
        window.exportData = () => { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(db)); a.download="backup.json"; a.click(); };
        window.resetData = () => { if(confirm("Clear All?")) { localStorage.removeItem('infinityDB'); location.reload(); } };

        // INIT
        const n = new Date(); document.getElementById('monthPicker').value = `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}`;
        document.getElementById('monthPicker').addEventListener('change', render);
        render();
    </script>
</body>
</html>
