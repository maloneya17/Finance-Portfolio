<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Finance Portfolio</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f3f4f6; color: #1e293b; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); }
        .mobile-header-fix { padding-top: max(1rem, env(safe-area-inset-top)); }
        .card { background: #ffffff; border-radius: 20px; border: 1px solid #f1f5f9; box-shadow: 0 10px 30px -10px rgba(79, 70, 229, 0.05); transition: all 0.3s ease; }
        .sidebar-gradient { background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%); color: white; }
        .nav-item { padding: 12px 16px; border-radius: 12px; font-weight: 500; color: #94a3b8; display: flex; align-items: center; gap: 12px; transition: 0.2s; cursor: pointer; }
        .nav-item:hover { background-color: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background-color: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .input-box { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; outline: none; transition: 0.2s; background: #f8fafc; font-size: 14px; }
        .input-box:focus { border-color: #4f46e5; background: white; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .cal-day { min-height: 80px; border-radius: 8px; background: white; border: 1px solid #f1f5f9; padding: 4px; display: flex; flex-direction: column; gap: 2px; }
        .cal-day.today { border: 2px solid #f59e0b; background-color: #fffbeb; }
        .bill-pill { font-size: 9px; padding: 2px 4px; border-radius: 4px; background: #eff6ff; color: #1e40af; font-weight: 600; border-left: 2px solid #3b82f6; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bill-pill.adjusted { border-left-color: #f59e0b; background: #fff7ed; color: #9a3412; }
        .editing-mode { border: 2px solid #f59e0b !important; background-color: #fffbeb !important; }
        .badge-auto { background-color: #e0e7ff; color: #4338ca; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; border: 1px solid #c7d2fe; display: inline-flex; align-items: center; gap: 4px; }
        .badge-sync { background-color: #dcfce7; color: #15803d; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; border: 1px solid #86efac; display: inline-flex; align-items: center; gap: 4px; }
        #cloudLoader { position: fixed; top: 20px; right: 20px; z-index: 100; display: flex; align-items: center; gap: 10px; background: white; padding: 10px 20px; border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); font-size: 12px; font-weight: bold; color: #4f46e5; transition: 0.3s; transform: translateY(-100px); }
        #cloudLoader.show { transform: translateY(0); }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden bg-[#f8fafc]">

    <div id="cloudLoader"><i class="fas fa-circle-notch fa-spin"></i> Syncing...</div>

    <div id="sidebar" class="w-full md:w-72 sidebar-gradient flex flex-col justify-between z-20 hidden md:flex h-full fixed md:relative shadow-2xl">
        <div class="p-6">
            <div class="flex items-center gap-3 mb-10">
                <div class="w-10 h-10 bg-indigo-500 rounded-xl flex items-center justify-center text-white text-xl shadow-lg shadow-indigo-500/50"><i class="fas fa-briefcase"></i></div>
                <div><h1 class="font-bold text-lg text-white tracking-tight leading-tight">Finance<br>Portfolio</h1></div>
                <button onclick="toggleMobileMenu()" class="md:hidden ml-auto text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="mb-8">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 block pl-2">Timeline</label>
                <input type="month" id="monthPicker" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-xl font-bold text-white focus:border-indigo-500 cursor-pointer outline-none">
            </div>
            <nav class="space-y-2">
                <div onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item active"><i class="fas fa-chart-pie w-5"></i> Dashboard</div>
                <div onclick="switchView('reports')" id="nav-reports" class="nav-item"><i class="fas fa-chart-line w-5"></i> Yearly Reports</div>
                <div onclick="switchView('calendar')" id="nav-calendar" class="nav-item"><i class="fas fa-calendar-day w-5"></i> Bills Calendar</div>
                <div onclick="switchView('wealth')" id="nav-wealth" class="nav-item"><i class="fas fa-vault w-5"></i> Portfolio & FIRE</div>
                <div onclick="switchView('settings')" id="nav-settings" class="nav-item"><i class="fas fa-sliders w-5"></i> Configuration</div>
            </nav>
        </div>
        <div class="p-6 bg-slate-900/50 border-t border-slate-800 space-y-3">
            <div id="cloudStatus" class="text-xs text-slate-400 flex items-center gap-2 mb-2"><i class="fas fa-hdd"></i> Local Mode</div>
            <button onclick="manualSync()" id="manualSyncBtn" class="text-xs text-indigo-300 hover:text-white font-bold flex items-center gap-2 mb-2 w-full p-2 rounded hover:bg-slate-800 transition hidden">
                <i class="fas fa-sync"></i> Sync Now
            </button>
            <button onclick="exportToCSV()" class="text-xs text-emerald-400 hover:text-emerald-300 font-medium flex items-center gap-3 w-full p-2 rounded hover:bg-slate-800 transition"><i class="fas fa-file-csv"></i> Export to Excel</button>
            <div class="flex gap-2">
                <button onclick="exportData()" class="text-xs text-slate-400 hover:text-white font-medium flex items-center gap-2 flex-1 p-2 rounded hover:bg-slate-800 transition"><i class="fas fa-download"></i> Backup</button>
                <label class="text-xs text-slate-400 hover:text-white font-medium flex items-center gap-2 flex-1 p-2 rounded hover:bg-slate-800 transition cursor-pointer"><i class="fas fa-upload"></i> Restore<input type="file" class="hidden" onchange="importData(this)"></label>
            </div>
        </div>
    </div>

    <div class="flex-1 flex flex-col h-full overflow-hidden relative">
        <div class="md:hidden mobile-header-fix px-4 py-3 bg-white border-b flex justify-between items-center shadow-sm z-10">
            <div class="flex items-center gap-2"><div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white text-sm"><i class="fas fa-briefcase"></i></div><h1 class="font-bold text-gray-800">Portfolio</h1></div>
            <div class="flex items-center gap-3"><button onclick="manualSync()" class="text-indigo-600 p-2 hidden" id="mobileSyncBtn"><i class="fas fa-sync"></i></button><button onclick="toggleMobileMenu()" class="text-gray-600 p-2"><i class="fas fa-bars text-xl"></i></button></div>
        </div>

        <div class="flex-1 overflow-y-auto custom-scroll p-4 md:p-10 pb-24">
            <div id="view-dashboard" class="view-section">
                <div id="notificationArea" class="space-y-2 mb-6">
                    <div id="autoPayNotification" class="hidden p-4 bg-indigo-50 border border-indigo-100 rounded-xl flex items-center gap-3 shadow-sm"><div class="w-8 h-8 bg-indigo-500 rounded-full flex items-center justify-center text-white"><i class="fas fa-robot"></i></div><div><h4 class="font-bold text-indigo-900 text-sm">Auto-Pilot</h4><p class="text-xs text-indigo-700" id="autoPayText">Bills logged.</p></div></div>
                    <div id="assetSyncNotification" class="hidden p-4 bg-emerald-50 border border-emerald-100 rounded-xl flex items-center gap-3 shadow-sm"><div class="w-8 h-8 bg-emerald-500 rounded-full flex items-center justify-center text-white"><i class="fas fa-sync"></i></div><div><h4 class="font-bold text-emerald-900 text-sm">Asset Synced</h4><p class="text-xs text-emerald-700" id="assetSyncText">Value updated.</p></div></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="card p-6 border-l-4 border-emerald-500"><div><p class="text-xs text-slate-500 font-bold uppercase tracking-wider">Income</p><h2 class="text-2xl font-bold text-slate-800 mt-2" id="kpiIncome">Â£0.00</h2></div></div>
                    <div class="card p-6 border-l-4 border-rose-500"><div><p class="text-xs text-slate-500 font-bold uppercase tracking-wider">Expenses</p><h2 class="text-2xl font-bold text-slate-800 mt-2" id="kpiExpense">Â£0.00</h2></div></div>
                    <div class="card p-6 border-l-4 border-indigo-500"><div><p class="text-xs text-slate-500 font-bold uppercase tracking-wider">Net Cash Flow</p><h2 class="text-2xl font-bold text-slate-800 mt-2" id="kpiBalance">Â£0.00</h2></div></div>
                    <div class="card p-6 bg-gradient-to-br from-indigo-600 to-purple-600 text-white border-none"><p class="text-xs text-indigo-100 font-bold uppercase tracking-wider">Top Category</p><h2 class="text-xl font-bold mt-2 truncate" id="kpiTopCat">None</h2><p class="text-sm text-indigo-100 font-medium mt-1" id="kpiTopCatVal">Â£0.00</p></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="card p-6">
                        <div class="mb-6"><div class="flex justify-between items-center"><h3 class="font-bold text-slate-800">Income vs Expense</h3><span class="text-xs text-slate-400 font-medium">Last 6 Months</span></div><div class="flex gap-4 mt-2 text-sm font-bold"><span class="text-emerald-500"><i class="fas fa-arrow-down"></i> <span id="trendTotalIncome">Â£0</span></span><span class="text-rose-500"><i class="fas fa-arrow-up"></i> <span id="trendTotalExpense">Â£0</span></span></div></div>
                        <div class="h-64 w-full"><canvas id="trendChart"></canvas></div>
                    </div>
                    <div class="card p-6"><h3 class="font-bold text-slate-800 mb-6">Spending Breakdown</h3><div class="h-64 w-full flex justify-center"><canvas id="spendingChart"></canvas></div></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                    <div class="card p-6 col-span-1 lg:col-span-2"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-slate-800">Budget Limits</h3><button onclick="switchView('settings')" class="text-xs text-indigo-500 font-semibold hover:bg-indigo-50 px-3 py-1 rounded-full transition">Edit Limits</button></div><div id="budgetContainer" class="space-y-5"></div></div>
                    <div class="card p-6"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-slate-800">Savings Goals</h3><button onclick="openGoalModal()" class="w-8 h-8 bg-indigo-50 text-indigo-600 rounded-full hover:bg-indigo-100 transition"><i class="fas fa-plus"></i></button></div><ul id="goalList" class="space-y-4 max-h-64 overflow-y-auto custom-scroll pr-2"></ul></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="card p-6 h-fit" id="txFormCard">
                        <div class="flex justify-between items-center mb-6"><h3 class="font-bold text-slate-800" id="txFormTitle">Add Transaction</h3><button id="cancelEditTxBtn" onclick="cancelTxEdit()" class="hidden text-xs text-rose-500 hover:underline">Cancel Edit</button></div>
                        <form id="txForm" class="space-y-4">
                            <div class="grid grid-cols-2 gap-3 p-1 bg-slate-100 rounded-xl"><button type="button" onclick="setTxType('expense')" id="btn-expense" class="py-2.5 rounded-lg text-sm font-bold bg-white text-rose-600 shadow-sm transition-all">Expense</button><button type="button" onclick="setTxType('income')" id="btn-income" class="py-2.5 rounded-lg text-sm font-bold text-slate-500 transition-all">Income</button></div>
                            <input type="hidden" id="txType" value="expense"><input type="text" id="txDesc" placeholder="Description" class="input-box" required>
                            <div class="flex gap-3"><input type="number" id="txAmount" placeholder="0.00" step="0.01" class="input-box w-1/2" required><select id="txCategory" class="input-box w-1/2 cursor-pointer bg-white"></select></div>
                            <div class="space-y-3 pt-2">
                                <div id="debtLinkContainer" class="hidden"><label class="flex items-center gap-2 p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50"><input type="checkbox" id="isDebtPayment" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"><span class="text-sm font-medium text-slate-700">Pay off Debt?</span></label><div id="debtSelector" class="hidden mt-2"><select id="linkedDebtId" class="input-box bg-white text-slate-700"><option value="">Select Liability...</option></select></div></div>
                                <div id="roundUpContainer" class="hidden"><label class="flex items-center gap-2 p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50"><input type="checkbox" id="isRoundUp" class="w-4 h-4 text-emerald-600 rounded focus:ring-emerald-500"><div><span class="text-sm font-medium text-slate-700 block">Round Up?</span><span class="text-xs text-slate-400">Save the spare change</span></div></label><div id="roundUpSelector" class="hidden mt-2"><label class="text-xs font-bold text-slate-500 ml-1">Send change to Asset:</label><select id="roundUpTarget" class="input-box bg-white text-slate-700 mt-1"></select></div></div>
                            </div>
                            <button type="submit" id="submitBtn" class="w-full py-3.5 rounded-xl font-bold text-white bg-rose-500 hover:bg-rose-600 shadow-lg shadow-rose-200 transition-all">Log Expense</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2"><div class="card p-6"><h3 class="font-bold text-slate-800 mb-6">Transaction History</h3><div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead class="text-xs font-bold text-slate-400 uppercase border-b border-slate-100"><tr><th class="pb-3 pl-2">Description</th><th class="pb-3 text-right">Amount</th><th class="pb-3 text-right pr-2">Actions</th></tr></thead><tbody id="txTableBody" class="text-sm"></tbody></table><div id="listEmptyState" class="hidden py-8 text-center text-slate-400 text-sm">No transactions yet.</div></div></div></div>
                </div>
            </div>

            <div id="view-settings" class="view-section hidden">
                <div class="card p-8 max-w-3xl mx-auto space-y-10">
                    <div><h2 class="text-2xl font-bold text-slate-800">Configuration</h2></div>
                    <div class="border-b border-slate-100 pb-6 mb-6">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fas fa-cloud text-indigo-500"></i> Cloud Sync</h3>
                        <p class="text-xs text-slate-500 mb-3">Paste Google Apps Script URL:</p>
                        <div class="flex gap-2">
                            <form id="cloudForm" class="flex-1 flex gap-3">
                                <input type="text" id="cloudUrlInput" placeholder="https://script.google.com/..." class="input-box" required>
                                <button type="submit" class="px-6 bg-indigo-500 text-white rounded-xl font-bold">Connect</button>
                            </form>
                            <button onclick="disconnectCloud()" class="px-4 bg-rose-100 text-rose-600 rounded-xl font-bold hover:bg-rose-200 transition" title="Disconnect Cloud"><i class="fas fa-unlink"></i></button>
                        </div>
                        <div id="cloudMsg" class="mt-2 text-xs font-bold text-emerald-600 hidden">Cloud Connected!</div>
                    </div>
                    <div class="border-b border-slate-100 pb-6 mb-6"><button onclick="debugData()" class="text-indigo-600 hover:text-indigo-800 font-bold flex items-center gap-2"><i class="fas fa-bug"></i> ðŸ”§ Debug / Recover Data</button></div>
                    <div><h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fas fa-chart-line text-emerald-500"></i> Category Budgets</h3><form id="budgetForm" class="flex gap-3 mb-4"><select id="budgetCat" class="input-box w-1/2"></select><input type="number" id="budgetLimit" placeholder="Limit" class="input-box w-1/3" step="0.01" required><button type="submit" class="w-12 bg-emerald-500 text-white rounded-xl hover:bg-emerald-600"><i class="fas fa-plus"></i></button></form><ul id="budgetSettingsList" class="space-y-2"></ul></div>
                    <div class="border-t border-slate-100 pt-8" id="billFormContainer"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-800 flex items-center gap-2" id="billFormTitle"><i class="fas fa-calendar-check text-indigo-500"></i> Recurring Bills</h3><button onclick="cancelBillEdit()" id="cancelBillEditBtn" class="hidden text-xs text-rose-500 hover:underline">Cancel Edit</button></div><form id="billForm" class="flex gap-3 mb-4"><input type="number" id="billDay" placeholder="Day" class="input-box w-1/4" min="1" max="31" required><input type="text" id="billDesc" placeholder="Bill Name" class="input-box w-1/2" required><input type="number" id="billAmount" placeholder="Â£" class="input-box w-1/4" step="0.01" required><button type="submit" id="billSubmitBtn" class="w-12 bg-indigo-500 text-white rounded-xl hover:bg-indigo-600"><i class="fas fa-plus"></i></button></form><ul id="billList" class="space-y-2"></ul></div>
                    <div class="border-t border-slate-100 pt-8"><h3 class="font-bold text-slate-800 mb-4">Categories</h3><form id="catForm" class="flex gap-3 mb-4"><input type="text" id="newCatName" placeholder="New Category Name" class="input-box" required><button type="submit" class="px-6 bg-slate-800 text-white rounded-xl font-bold">Add</button></form><div class="flex flex-wrap gap-2" id="settingsCatList"></div></div>
                    <div class="border-t border-slate-100 pt-8"><button onclick="hardReset()" class="text-rose-500 font-bold hover:bg-rose-50 px-4 py-2 rounded-lg transition">Reset All Data</button></div>
                </div>
            </div>

            <div id="view-reports" class="view-section hidden"><div class="mb-8"><h2 class="text-2xl font-bold text-slate-800">Yearly Reports</h2></div><div class="card p-6"><table class="w-full text-left border-collapse"><thead><tr class="text-xs font-bold text-slate-500 uppercase border-b border-slate-200"><th class="py-4">Month</th><th class="py-4 text-right text-emerald-600">Income</th><th class="py-4 text-right text-rose-600">Expenses</th><th class="py-4 text-right text-indigo-600">Net</th><th class="py-4 text-right">Rate</th></tr></thead><tbody id="reportsTableBody" class="text-sm font-medium text-slate-700"></tbody></table></div></div>
            <div id="view-calendar" class="view-section hidden"><div class="flex justify-between items-end mb-8"><div><h2 class="text-2xl font-bold text-slate-800">Bills Calendar</h2><p class="text-slate-500 text-sm mt-1">Total: <span id="calTotalBills" class="font-bold text-indigo-600">Â£0.00</span></p></div><button onclick="switchView('settings')" class="text-sm bg-white border border-slate-200 px-4 py-2 rounded-lg font-semibold">Manage</button></div><div class="card p-6"><div class="calendar-grid mb-4"><div class="text-xs text-slate-400 font-bold text-center">Mon</div><div class="text-xs text-slate-400 font-bold text-center">Tue</div><div class="text-xs text-slate-400 font-bold text-center">Wed</div><div class="text-xs text-slate-400 font-bold text-center">Thu</div><div class="text-xs text-slate-400 font-bold text-center">Fri</div><div class="text-xs text-slate-400 font-bold text-center">Sat</div><div class="text-xs text-slate-400 font-bold text-center">Sun</div></div><div id="calendarGrid" class="calendar-grid"></div></div></div>
            <div id="view-wealth" class="view-section hidden"><div class="card bg-gradient-to-r from-slate-900 to-slate-800 text-white p-10 mb-8 relative overflow-hidden border-none shadow-2xl"><div class="relative z-10 flex flex-col md:flex-row justify-between items-end gap-6"><div><p class="text-slate-400 font-bold uppercase text-xs tracking-wider">Total Net Worth</p><h1 class="text-5xl md:text-6xl font-bold mt-2 tracking-tight" id="totalWealth">Â£0.00</h1><p class="text-sm text-slate-400 mt-2 flex gap-4"><span class="text-emerald-400"><i class="fas fa-arrow-up"></i> Assets: <span id="valAssets">Â£0</span></span><span class="text-rose-400"><i class="fas fa-arrow-down"></i> Debts: <span id="valDebt">Â£0</span></span></p></div><div class="text-right bg-white/10 p-4 rounded-xl backdrop-blur-sm border border-white/10"><p class="text-[10px] text-slate-300 uppercase font-bold tracking-wider mb-1">FIRE Progress</p><p class="text-2xl font-bold text-yellow-400" id="fireEstimate">...</p></div></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="space-y-6"><div class="card p-6"><div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4"><h3 class="font-bold text-slate-800">Assets</h3><button onclick="openWealthModal('asset')" class="text-xs bg-slate-800 text-white px-3 py-1.5 rounded-lg hover:bg-slate-700 transition">Add Asset</button></div><ul id="assetList" class="space-y-3 max-h-60 overflow-y-auto custom-scroll pr-2"></ul></div><div class="card p-6 border-l-4 border-rose-500"><div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4"><h3 class="font-bold text-slate-800">Liabilities</h3><button onclick="openWealthModal('debt')" class="text-xs bg-rose-600 text-white px-3 py-1.5 rounded-lg hover:bg-rose-700 transition">Add Debt</button></div><ul id="debtList" class="space-y-3 max-h-60 overflow-y-auto custom-scroll pr-2"></ul></div></div><div class="card p-6"><h3 class="font-bold text-slate-800 mb-6">Net Worth Structure</h3><div class="h-80 w-full flex justify-center"><canvas id="wealthChart"></canvas></div></div></div></div>

            <div id="wealthFormContainer" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50"><div class="card p-8 w-96 shadow-2xl scale-100"><h3 class="font-bold text-xl mb-6 text-slate-800" id="wealthFormTitle">Add Item</h3><form id="wealthForm" class="space-y-4"><input type="hidden" id="wealthType"><input type="text" id="wealthName" placeholder="Name" class="input-box" required><input type="number" id="wealthValue" placeholder="Value (Â£)" class="input-box" step="0.01" required><div id="assetTypeContainer"><label class="text-xs font-bold text-slate-500 uppercase">Category</label><select id="wealthCategory" class="input-box mt-1"><option value="Savings">Savings</option><option value="Investment">Investment</option><option value="Stock">Stock</option><option value="Crypto">Crypto</option><option value="Property">Property</option><option value="Pension">Pension</option></select></div><div class="flex gap-3 pt-4"><button type="button" onclick="closeWealthModal()" class="w-1/2 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">Cancel</button><button type="submit" class="w-1/2 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200">Save</button></div></form></div></div>
            <div id="goalFormContainer" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50"><div class="card p-8 w-96 shadow-2xl"><h3 class="font-bold text-xl mb-6 text-slate-800">Add Savings Goal</h3><form id="goalForm" class="space-y-4"><input type="text" id="goalName" placeholder="Goal Name" class="input-box" required><input type="number" id="goalTarget" placeholder="Target (Â£)" class="input-box" step="0.01" required><input type="number" id="goalCurrent" placeholder="Current (Â£)" class="input-box" step="0.01" required><div class="flex gap-3 pt-4"><button type="button" onclick="document.getElementById('goalFormContainer').classList.add('hidden')" class="w-1/2 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">Cancel</button><button type="submit" class="w-1/2 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200">Save</button></div></form></div></div>
        </div>
    </div>

    <script>
        Chart.register(ChartDataLabels);
        const defaultCategories = ['Housing', 'Food', 'Transport', 'Utilities', 'Entertainment', 'Health', 'Savings'];
        let db;
        try {
            const raw = localStorage.getItem('infinityDB');
            db = raw ? JSON.parse(raw) : null;
            if(!db || typeof db !== 'object') db = { categories: [...defaultCategories], transactions: {}, assets: [], debts: [], recurring: [], budgets: {}, goals: [], billLog: [] };
            if(!Array.isArray(db.assets)) db.assets = []; if(!Array.isArray(db.debts)) db.debts = [];
            db.assets.forEach(a => a.value = parseFloat(a.value || 0)); db.debts.forEach(d => d.value = parseFloat(d.value || 0));
            if(!db.recurring) db.recurring = []; if(!db.budgets) db.budgets = {}; if(!db.goals) db.goals = []; if(!db.billLog) db.billLog = [];
        } catch(e) { db = { categories: [...defaultCategories], transactions: {}, assets: [], debts: [], recurring: [], budgets: [], goals: [], billLog: [] }; }
        
        let cloudUrl = localStorage.getItem('infinityCloudUrl') || "";
        function updateCloudUI() {
            if(cloudUrl) {
                document.getElementById('cloudUrlInput').value = cloudUrl;
                document.getElementById('cloudStatus').innerHTML = '<i class="fas fa-cloud text-emerald-500"></i> Cloud Active';
                document.getElementById('cloudMsg').classList.remove('hidden');
                document.getElementById('manualSyncBtn').classList.remove('hidden');
                if(document.getElementById('mobileSyncBtn')) document.getElementById('mobileSyncBtn').classList.remove('hidden');
                loadFromCloud();
            } else {
                document.getElementById('cloudUrlInput').value = '';
                document.getElementById('cloudStatus').innerHTML = '<i class="fas fa-hdd text-slate-600"></i> Local Mode';
                document.getElementById('cloudMsg').classList.add('hidden');
                document.getElementById('manualSyncBtn').classList.add('hidden');
                if(document.getElementById('mobileSyncBtn')) document.getElementById('mobileSyncBtn').classList.add('hidden');
            }
        }
        updateCloudUI(); // Run on init

        let editingTxIndex = null, editingWealthIndex = null, editingWealthType = null, editingBillIndex = null, currentTxType = 'expense';
        const monthPicker = document.getElementById('monthPicker'); const today = new Date(); monthPicker.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        let trendChart = null, wealthChart = null, spendingChart = null;
        const fmt = (num) => parseFloat(num).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        function getCategoryColor(category) { const categoryColors = { 'Debt': '#ef4444', 'Liabilities': '#ef4444', 'Housing': '#3b82f6', 'Food': '#f59e0b', 'Transport': '#06b6d4', 'Utilities': '#eab308', 'Entertainment': '#8b5cf6', 'Health': '#10b981', 'Bills': '#6366f1', 'Shopping': '#ec4899', 'Education': '#f43f5e', 'Insurance': '#64748b', 'Other': '#9ca3af' }; if(categoryColors[category]) return categoryColors[category]; let hash = 0; for (let i = 0; i < category.length; i++) { hash = category.charCodeAt(i) + ((hash << 5) - hash); } const palette = ['#14b8a6', '#f97316', '#a855f7', '#d946ef', '#0ea5e9', '#84cc16']; return palette[Math.abs(hash) % palette.length]; }

        async function loadFromCloud() { if(!cloudUrl)return; document.getElementById('cloudLoader').classList.add('show'); try{ const res=await fetch(cloudUrl); const d=await res.json(); if(d&&d.categories){ db=d; db.assets.forEach(a=>a.value=parseFloat(a.value||0)); db.debts.forEach(d=>d.value=parseFloat(d.value||0)); localStorage.setItem('infinityDB',JSON.stringify(db)); renderAll(); } }catch(e){console.error(e);} document.getElementById('cloudLoader').classList.remove('show'); }
        async function saveToCloud() { if(!cloudUrl)return; document.getElementById('cloudLoader').classList.add('show'); try{ await fetch(cloudUrl,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(db)}); }catch(e){console.error(e);} document.getElementById('cloudLoader').classList.remove('show'); }
        function manualSync() { if(cloudUrl) { saveToCloud(); alert("Syncing to Cloud..."); setTimeout(loadFromCloud, 1000); } else { alert("Connect Cloud in Settings first."); } }
        function disconnectCloud() { cloudUrl = ""; localStorage.removeItem('infinityCloudUrl'); updateCloudUI(); alert("Disconnected from Cloud. You are now in Local Mode."); }

        function checkAutoBills() { try { const now = new Date(); const startDate = new Date('2025-12-26T00:00:00'); if (now < startDate) return; const currentDay = now.getDate(); const currentKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`; let addedBills = []; db.recurring.forEach(bill => { if(parseInt(bill.day) === currentDay) { const paymentId = `${bill.desc}-${currentKey}`; if(!db.billLog.includes(paymentId)) { if(!db.transactions[currentKey]) db.transactions[currentKey] = []; db.transactions[currentKey].push({ desc: bill.desc, amount: bill.amount, category: "Bills", type: "expense", isAuto: true }); db.billLog.push(paymentId); addedBills.push(bill.desc); } } }); if(addedBills.length > 0) { saveData(); const notify = document.getElementById('autoPayNotification'); document.getElementById('autoPayText').innerText = `Processed: ${addedBills.join(', ')}`; notify.classList.remove('hidden'); } } catch(e) {} }

        function saveData() { localStorage.setItem('infinityDB', JSON.stringify(db)); if(cloudUrl) saveToCloud(); renderAll(); }
        function debugData() { const raw = JSON.stringify(db, null, 2); const win = window.open("", "Debug", "width=600,height=600"); win.document.write("<pre>" + raw + "</pre>"); }
        function switchView(view) { document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden')); document.getElementById(`view-${view}`).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); document.getElementById(`nav-${view}`).classList.add('active'); cancelTxEdit(); closeWealthModal(); cancelBillEdit(); if(window.innerWidth < 768) toggleMobileMenu(); if(view === 'dashboard') { trendChart.resize(); spendingChart.resize(); populateDebtSelector(); populateRoundUpSelector(); } if(view === 'wealth') wealthChart.resize(); if(view === 'calendar') renderCalendar(); if(view === 'reports') renderReports(); }
        function toggleMobileMenu() { const s = document.getElementById('sidebar'); s.classList.toggle('hidden'); s.classList.toggle('flex'); s.classList.toggle('fixed'); s.classList.toggle('inset-0'); }
        
        function setTxType(type) { currentTxType = type; document.getElementById('txType').value = type; const btnExp = document.getElementById('btn-expense'); const btnInc = document.getElementById('btn-income'); const sub = document.getElementById('submitBtn'); const debtContainer = document.getElementById('debtLinkContainer'); const roundUpContainer = document.getElementById('roundUpContainer'); if (type === 'expense') { btnExp.className="py-2.5 rounded-lg text-sm font-bold bg-white text-rose-600 shadow-sm transition-all"; btnInc.className="py-2.5 rounded-lg text-sm font-bold text-slate-500 transition-all"; if(!editingTxIndex && editingTxIndex !== 0) sub.innerText="Log Expense"; sub.classList.remove('bg-emerald-500', 'hover:bg-emerald-600'); sub.classList.add('bg-rose-500', 'hover:bg-rose-600'); debtContainer.classList.remove('hidden'); roundUpContainer.classList.remove('hidden'); populateDebtSelector(); populateRoundUpSelector(); } else { btnExp.className="py-2.5 rounded-lg text-sm font-bold text-slate-500 transition-all"; btnInc.className="py-2.5 rounded-lg text-sm font-bold bg-white text-emerald-600 shadow-sm transition-all"; if(!editingTxIndex && editingTxIndex !== 0) sub.innerText="Log Income"; sub.classList.remove('bg-rose-500', 'hover:bg-rose-600'); sub.classList.add('bg-emerald-500', 'hover:bg-emerald-600'); debtContainer.classList.add('hidden'); roundUpContainer.classList.add('hidden'); } }
        document.getElementById('isDebtPayment').addEventListener('change', (e) => { const s = document.getElementById('debtSelector'); if(e.target.checked) s.classList.remove('hidden'); else s.classList.add('hidden'); });
        document.getElementById('isRoundUp').addEventListener('change', (e) => { const s = document.getElementById('roundUpSelector'); if(e.target.checked) s.classList.remove('hidden'); else s.classList.add('hidden'); });
        document.getElementById('cloudForm').addEventListener('submit', e => { e.preventDefault(); cloudUrl = document.getElementById('cloudUrlInput').value; localStorage.setItem('infinityCloudUrl', cloudUrl); alert("Connected!"); updateCloudUI(); saveToCloud(); });

        function populateDebtSelector() { const select = document.getElementById('linkedDebtId'); select.innerHTML = '<option value="">Select Liability to reduce...</option>'; if(db.debts.length === 0) { select.innerHTML = '<option value="">No Debts Found</option>'; } else { db.debts.forEach((d, index) => { const opt = document.createElement('option'); opt.value = index; opt.innerText = `${d.name} (Â£${fmt(d.value)})`; select.appendChild(opt); }); } }
        function populateRoundUpSelector() { const select = document.getElementById('roundUpTarget'); select.innerHTML = ''; const defaultOpt = document.createElement('option'); defaultOpt.value = 'Round up'; defaultOpt.innerText = 'Round up (Default)'; select.appendChild(defaultOpt); db.assets.forEach(asset => { if(asset.name !== 'Round up') { const opt = document.createElement('option'); opt.value = asset.name; opt.innerText = asset.name; select.appendChild(opt); } }); }

        function renderAll() { renderDropdowns(); renderDashboard(); renderWealth(); renderSettings(); renderCalendar(); }
        function renderDropdowns() { let optionsHTML = `<optgroup label="Categories">`; db.categories.forEach(c => { optionsHTML += `<option value="${c}">${c}</option>`; }); optionsHTML += `</optgroup>`; if(db.assets.length > 0) { optionsHTML += `<optgroup label="Link to Asset (Auto-Invest)">`; db.assets.forEach(a => { optionsHTML += `<option value="${a.name}">[Asset] ${a.name}</option>`; }); optionsHTML += `</optgroup>`; } document.getElementById('txCategory').innerHTML = optionsHTML; document.getElementById('budgetCat').innerHTML = optionsHTML; }

        function renderDashboard() {
            const key = monthPicker.value; const data = db.transactions[key] || [];
            let inc = 0, exp = 0; const cats = {};
            data.forEach(tx => { if (tx.type === 'income') inc += parseFloat(tx.amount); else { exp += parseFloat(tx.amount); cats[tx.category] = (cats[tx.category] || 0) + parseFloat(tx.amount); } });
            document.getElementById('kpiIncome').innerText = `Â£${fmt(inc)}`; document.getElementById('kpiExpense').innerText = `Â£${fmt(exp)}`; document.getElementById('kpiBalance').innerText = `Â£${fmt(inc - exp)}`;
            let topCat = "None"; let topVal = 0; for(const [c, v] of Object.entries(cats)) { if(v > topVal) { topVal = v; topCat = c; } }
            document.getElementById('kpiTopCat').innerText = topCat; document.getElementById('kpiTopCatVal').innerText = `Â£${fmt(topVal)}`;
            const budgetCont = document.getElementById('budgetContainer'); budgetCont.innerHTML = ''; Object.keys(db.budgets).forEach(cat => { const limit = db.budgets[cat]; const spent = cats[cat] || 0; const pct = Math.min((spent / limit) * 100, 100); let color = 'bg-emerald-500'; if(pct > 75) color = 'bg-yellow-400'; if(pct > 95) color = 'bg-rose-500'; budgetCont.innerHTML += `<div><div class="flex justify-between text-xs font-bold mb-1.5 text-slate-600"><span>${cat}</span><span>Â£${fmt(spent)} / Â£${fmt(limit)}</span></div><div class="progress-bg"><div class="progress-fill ${color}" style="width:${pct}%"></div></div></div>`; });
            if(Object.keys(db.budgets).length === 0) budgetCont.innerHTML = '<p class="text-sm text-slate-400 text-center py-4 bg-slate-50 rounded-xl">No budgets set.</p>';
            const goalList = document.getElementById('goalList'); goalList.innerHTML = ''; db.goals.forEach((g, i) => { const pct = Math.min((g.current / g.target) * 100, 100); goalList.innerHTML += `<div class="bg-slate-50 p-4 rounded-xl relative group border border-slate-100"><div class="flex justify-between text-xs font-bold mb-2 text-slate-600"><span>${g.name}</span><span>Â£${fmt(g.current)} / Â£${fmt(g.target)}</span></div><div class="progress-bg mb-1"><div class="progress-fill bg-indigo-500" style="width:${pct}%"></div></div><button onclick="deleteGoal(${i})" class="absolute top-3 right-3 text-slate-300 hover:text-rose-500 hidden group-hover:block transition"><i class="fas fa-times"></i></button></div>`; });
            if(db.goals.length === 0) goalList.innerHTML = '<p class="text-sm text-slate-400 text-center bg-slate-50 py-4 rounded-xl">No goals set.</p>';
            const tbody = document.getElementById('txTableBody'); tbody.innerHTML = ''; if (data.length === 0) document.getElementById('listEmptyState').classList.remove('hidden'); else { document.getElementById('listEmptyState').classList.add('hidden'); data.slice().reverse().forEach((tx, i) => { const realIndex = data.length - 1 - i; const autoBadge = tx.isAuto ? `<span class="badge-auto"><i class="fas fa-robot"></i> Auto</span>` : ''; const syncBadge = tx.isSync ? `<span class="badge-sync"><i class="fas fa-sync"></i> Asset</span>` : ''; tbody.innerHTML += `<tr class="border-b border-slate-50 hover:bg-slate-50 transition"><td class="py-3.5 pl-2"><div class="font-bold text-slate-700 flex items-center gap-2">${tx.desc} ${autoBadge} ${syncBadge}</div><div class="text-xs text-slate-400 font-medium">${tx.category}</div></td><td class="py-3.5 text-right font-bold ${tx.type === 'income' ? 'text-emerald-500' : 'text-slate-700'}">${tx.type === 'income' ? '+' : '-'}Â£${fmt(tx.amount)}</td><td class="py-3.5 text-right"><button onclick="editTx(${realIndex})" class="text-indigo-400 hover:text-indigo-600 transition px-2"><i class="fas fa-pen"></i></button><button onclick="deleteTx(${realIndex})" class="text-slate-300 hover:text-rose-500 transition px-2"><i class="fas fa-trash-alt"></i></button></td></tr>`; }); }
            updateTrendChart(); updateSpendingChart(cats);
        }

        function updateTrendChart(){const ctx=document.getElementById('trendChart').getContext('2d');const labels=[],incData=[],expData=[];let d=new Date();d.setMonth(d.getMonth()-5);let totalInc=0,totalExp=0;for(let i=0;i<6;i++){const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;labels.push(d.toLocaleString('default',{month:'short'}));const txs=db.transactions[key]||[];let inc=0,exp=0;txs.forEach(t=>t.type==='income'?inc+=parseFloat(t.amount):exp+=parseFloat(t.amount));incData.push(inc);expData.push(exp);totalInc+=inc;totalExp+=exp;d.setMonth(d.getMonth()+1);}document.getElementById('trendTotalIncome').innerText=`Â£${fmt(totalInc)}`;document.getElementById('trendTotalExpense').innerText=`Â£${fmt(totalExp)}`;if(trendChart)trendChart.destroy();trendChart=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:'Income',data:incData,backgroundColor:'#10b981',borderRadius:4},{label:'Expenses',data:expData,backgroundColor:'#f43f5e',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,layout:{padding:{top:20}},scales:{y:{display:false,grid:{display:false}},x:{grid:{display:false,drawBorder:false},ticks:{font:{family:"'Plus Jakarta Sans', sans-serif",size:11,weight:'600'},color:'#94a3b8'}}},plugins:{legend:{position:'top',align:'end',labels:{usePointStyle:true,boxWidth:8,font:{family:"'Plus Jakarta Sans', sans-serif",size:12}}},datalabels:{display:false}}}});}
        function updateSpendingChart(cats){const ctx=document.getElementById('spendingChart').getContext('2d');const labels=Object.keys(cats);const values=Object.values(cats);const backgroundColors=labels.map(label=>getCategoryColor(label));if(spendingChart)spendingChart.destroy();if(values.length>0){spendingChart=new Chart(ctx,{type:'doughnut',data:{labels:labels,datasets:[{data:values,backgroundColor:backgroundColors,borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'75%',plugins:{legend:{position:'right',labels:{usePointStyle:true,boxWidth:8,generateLabels:(chart)=>{const data=chart.data;if(data.labels.length&&data.datasets.length){return data.labels.map((label,i)=>{const value=data.datasets[0].data[i];const meta=chart.getDatasetMeta(0);const style=meta.controller.getStyle(i);return{text:`${label} (${fmt(value)})`,fillStyle:style.backgroundColor,strokeStyle:style.borderColor,lineWidth:style.borderWidth,hidden:isNaN(data.datasets[0].data[i])||meta.data[i].hidden,index:i};});}return[];}}},datalabels:{color:'#fff',backgroundColor:'rgba(0,0,0,0.5)',borderRadius:4,formatter:(value,ctx)=>{let sum=0;let dataArr=ctx.chart.data.datasets[0].data;dataArr.map(data=>{sum+=data;});return(value*100/sum)>5?`${(value*100/sum).toFixed(0)}%`:null;},font:{weight:'bold',size:10}}}}});}}
        function updateWealthChart(typeMap){const ctx=document.getElementById('wealthChart').getContext('2d');const keys=Object.keys(typeMap);const values=Object.values(typeMap);const displayLabels=keys.map((k,i)=>`${k}: Â£${fmt(values[i])}`);if(wealthChart)wealthChart.destroy();const colors=keys.map(l=>{if(l==='Savings')return'#3b82f6';if(l==='Pension')return'#f97316';if(l==='Investment')return'#15803d';if(l==='Stock')return'#86efac';if(l==='Crypto')return'#10b981';if(l==='Property')return'#14b8a6';if(l==='Liabilities')return'#ef4444';return'#94a3b8';});if(values.length>0){wealthChart=new Chart(ctx,{type:'doughnut',data:{labels:displayLabels,datasets:[{data:values,backgroundColor:colors,borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,layout:{padding:20},cutout:'70%',plugins:{legend:{position:'right',labels:{usePointStyle:true,font:{size:11,family:"'Plus Jakarta Sans', sans-serif"}}},datalabels:{color:'#fff',backgroundColor:'rgba(0,0,0,0.6)',borderRadius:4,formatter:(value,ctx)=>{let sum=0;ctx.chart.data.datasets[0].data.map(data=>{sum+=data;});return(value*100/sum)>5?`${(value*100/sum).toFixed(0)}%`:null;},font:{weight:'bold',size:11}}}}});}}
        function renderReports() { const tbody = document.getElementById('reportsTableBody'); tbody.innerHTML = ''; const months = Object.keys(db.transactions).sort().reverse(); months.forEach(m => { const txs = db.transactions[m]; let inc=0, exp=0; txs.forEach(t => t.type==='income' ? inc+=parseFloat(t.amount) : exp+=parseFloat(t.amount)); const net = inc - exp; const rate = inc > 0 ? Math.round((net/inc)*100) : 0; tbody.innerHTML += `<tr class="border-b border-slate-100 hover:bg-slate-50"><td class="py-4 font-bold text-slate-700">${m}</td><td class="py-4 text-right text-emerald-600 font-bold">Â£${fmt(inc)}</td><td class="py-4 text-right text-rose-600 font-bold">Â£${fmt(exp)}</td><td class="py-4 text-right text-indigo-600 font-bold">Â£${fmt(net)}</td><td class="py-4 text-right font-bold text-slate-500">${rate}%</td></tr>`; }); }
        function renderCalendar() { const grid = document.getElementById('calendarGrid'); grid.innerHTML = ''; const [y, m] = monthPicker.value.split('-').map(Number); const daysInMonth = new Date(y, m, 0).getDate(); const currentDate = new Date(); const currentDay = currentDate.getDate(); const isCurrentMonth = (y === currentDate.getFullYear() && (m - 1) === currentDate.getMonth()); let totalBills = 0; for(let i=1; i<=daysInMonth; i++) { let pills = ''; let billsToday = db.recurring.filter(b => parseInt(b.day) === i); if(i === daysInMonth) { const overflowBills = db.recurring.filter(b => parseInt(b.day) > daysInMonth); overflowBills.forEach(b => { b.isAdjusted = true; billsToday.push(b); }); } if(billsToday.length > 0) { billsToday.forEach(b => { totalBills += parseFloat(b.amount); const adjustedClass = b.isAdjusted ? 'adjusted' : ''; const label = b.isAdjusted ? '(Adj) ' : ''; pills += `<div class="bill-pill ${adjustedClass}">${label}${b.desc}: Â£${b.amount}</div>`; delete b.isAdjusted; }); } const todayClass = (isCurrentMonth && i === currentDay) ? 'today' : ''; grid.innerHTML += `<div class="cal-day ${todayClass}"><div class="text-xs font-bold ${todayClass ? 'text-amber-500' : 'text-slate-400'} mb-1">${i}</div><div class="flex flex-col gap-1 w-full overflow-hidden">${pills}</div></div>`; } document.getElementById('calTotalBills').innerText = `Â£${fmt(totalBills)}`; }
        function renderSettings() { const billList = document.getElementById('billList'); billList.innerHTML = ''; db.recurring.sort((a,b)=>a.day-b.day).forEach((b, i) => { billList.innerHTML += `<li class="flex justify-between items-center bg-white border border-slate-200 p-3 rounded-xl text-sm"><span><span class="bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded text-xs font-bold mr-2">Day ${b.day}</span> ${b.desc}</span><div class="flex gap-3"><span class="font-bold text-slate-700">Â£${fmt(b.amount)}</span><button onclick="editBill(${i})" class="text-indigo-400 hover:text-indigo-600 transition"><i class="fas fa-pen"></i></button><button onclick="deleteBill(${i})" class="text-slate-400 hover:text-rose-500 transition"><i class="fas fa-times"></i></button></div></li>`; }); const budList = document.getElementById('budgetSettingsList'); budList.innerHTML = ''; Object.keys(db.budgets).forEach(cat => { budList.innerHTML += `<li class="flex justify-between items-center bg-white border border-slate-200 p-3 rounded-xl text-sm"><span>${cat}</span><div class="flex gap-3"><span class="font-bold text-slate-700">Â£${fmt(db.budgets[cat])}</span><button onclick="deleteBudget('${cat}')" class="text-slate-400 hover:text-rose-500 transition"><i class="fas fa-times"></i></button></div></li>`; }); const catList = document.getElementById('settingsCatList'); catList.innerHTML = ''; db.categories.forEach(c => { catList.innerHTML += `<div class="px-3 py-1 bg-white border border-slate-200 rounded-full text-sm font-medium text-slate-600 flex items-center gap-2">${c} <button onclick="deleteCategory('${c}')" class="text-slate-400 hover:text-rose-500 transition"><i class="fas fa-times"></i></button></div>`; }); }
        
        // --- SUBMIT EVENTS ---
        document.getElementById('txForm').addEventListener('submit', e => { e.preventDefault(); const k=monthPicker.value; if(!db.transactions[k]) db.transactions[k]=[]; const amt = parseFloat(document.getElementById('txAmount').value); const desc = document.getElementById('txDesc').value; const cat = document.getElementById('txCategory').value; if(editingTxIndex !== null) { db.transactions[k][editingTxIndex] = { desc: desc, amount: amt, category: cat, type: currentTxType }; } else { let isAssetSync = false; const linkedAsset = db.assets.find(a => a.name === cat); if(currentTxType === 'expense' && linkedAsset) { linkedAsset.value = parseFloat(linkedAsset.value || 0) + amt; isAssetSync = true; saveData(); const notify = document.getElementById('assetSyncNotification'); const notifyText = document.getElementById('assetSyncText'); notify.classList.remove('hidden'); notifyText.innerText = `Added Â£${fmt(amt)} to ${linkedAsset.name}`; setTimeout(() => notify.classList.add('hidden'), 3000); } const isDebt = document.getElementById('isDebtPayment').checked; const debtIndex = document.getElementById('linkedDebtId').value; if(currentTxType === 'expense' && isDebt && debtIndex !== "") { if(db.debts[debtIndex]) { db.debts[debtIndex].value -= amt; if(db.debts[debtIndex].value < 0) db.debts[debtIndex].value = 0; } } const isRoundUp = document.getElementById('isRoundUp').checked; const roundUpTargetName = document.getElementById('roundUpTarget').value; if(currentTxType === 'expense' && isRoundUp && amt > 0) { const ceiling = Math.ceil(amt); let diff = ceiling - amt; if(diff > 0.001) { diff = parseFloat(diff.toFixed(2)); db.transactions[k].push({ desc: `Round Up (${desc})`, amount: diff, category: "Savings", type: "expense", isAuto: true }); let targetAsset = db.assets.find(a => a.name === roundUpTargetName); if(!targetAsset) { targetAsset = { name: roundUpTargetName, value: 0, type: 'Savings' }; db.assets.push(targetAsset); } targetAsset.value = parseFloat(targetAsset.value) + diff; } } db.transactions[k].push({ desc: desc, amount: amt, category: cat, type: currentTxType, isSync: isAssetSync }); } cancelTxEdit(); saveData(); });
        document.getElementById('wealthForm').addEventListener('submit', e => { e.preventDefault(); const t=document.getElementById('wealthType').value; const n=document.getElementById('wealthName').value; const v=parseFloat(document.getElementById('wealthValue').value); const c=document.getElementById('wealthCategory').value; if(editingWealthIndex !== null) { if(editingWealthType === 'asset') db.assets[editingWealthIndex] = {name:n, value:v, type:c}; else db.debts[editingWealthIndex] = {name:n, value:v}; } else { if(t==='asset') db.assets.push({name:n,value:v,type:c}); else db.debts.push({name:n,value:v}); } closeWealthModal(); saveData(); });
        document.getElementById('billForm').addEventListener('submit', e => { e.preventDefault(); const day = parseInt(document.getElementById('billDay').value); const desc = document.getElementById('billDesc').value; const amt = parseFloat(document.getElementById('billAmount').value); if(editingBillIndex !== null) { db.recurring[editingBillIndex] = { day: day, desc: desc, amount: amt }; } else { db.recurring.push({ day: day, desc: desc, amount: amt }); } cancelBillEdit(); saveData(); });
        document.getElementById('goalForm').addEventListener('submit', e => { e.preventDefault(); db.goals.push({ name: document.getElementById('goalName').value, target: parseFloat(document.getElementById('goalTarget').value), current: parseFloat(document.getElementById('goalCurrent').value) }); document.getElementById('goalFormContainer').classList.add('hidden'); document.getElementById('goalForm').reset(); saveData(); });
        document.getElementById('budgetForm').addEventListener('submit', e => { e.preventDefault(); db.budgets[document.getElementById('budgetCat').value] = parseFloat(document.getElementById('budgetLimit').value); document.getElementById('budgetLimit').value = ''; saveData(); });
        document.getElementById('catForm').addEventListener('submit', e => { e.preventDefault(); const c=document.getElementById('newCatName').value; if(c&&!db.categories.includes(c)){db.categories.push(c); saveData();} document.getElementById('newCatName').value=''; });
        
        function editTx(index) { const k=monthPicker.value; const tx=db.transactions[k][index]; if(!tx)return; document.getElementById('txDesc').value=tx.desc; document.getElementById('txAmount').value=tx.amount; document.getElementById('txCategory').value=tx.category; setTxType(tx.type); editingTxIndex=index; document.getElementById('txFormCard').classList.add('editing-mode'); document.getElementById('txFormTitle').innerText="Update Transaction"; document.getElementById('submitBtn').innerText="Update Transaction"; document.getElementById('cancelEditTxBtn').classList.remove('hidden'); document.getElementById('txFormCard').scrollIntoView({behavior:'smooth'}); }
        function cancelTxEdit() { editingTxIndex=null; document.getElementById('txForm').reset(); document.getElementById('txFormCard').classList.remove('editing-mode'); document.getElementById('txFormTitle').innerText="Add Transaction"; setTxType('expense'); document.getElementById('cancelEditTxBtn').classList.add('hidden'); }
        function editWealth(type, index) { const item=(type==='asset')?db.assets[index]:db.debts[index]; openWealthModal(type); document.getElementById('wealthName').value=item.name; document.getElementById('wealthValue').value=item.value; if(type==='asset')document.getElementById('wealthCategory').value=item.type; editingWealthIndex=index; editingWealthType=type; document.getElementById('wealthFormTitle').innerText=`Edit ${type==='asset'?'Asset':'Liability'}`; }
        function closeWealthModal() { document.getElementById('wealthFormContainer').classList.add('hidden'); document.getElementById('wealthForm').reset(); editingWealthIndex=null; editingWealthType=null; }
        function editBill(index) { const bill=db.recurring[index]; document.getElementById('billDay').value=bill.day; document.getElementById('billDesc').value=bill.desc; document.getElementById('billAmount').value=bill.amount; editingBillIndex=index; document.getElementById('billFormContainer').classList.add('editing-mode','p-4','rounded-xl'); document.getElementById('billFormTitle').innerText="Update Bill"; document.getElementById('billSubmitBtn').innerHTML='<i class="fas fa-check"></i>'; document.getElementById('cancelBillEditBtn').classList.remove('hidden'); }
        function cancelBillEdit() { editingBillIndex=null; document.getElementById('billForm').reset(); document.getElementById('billFormContainer').classList.remove('editing-mode','p-4','rounded-xl'); document.getElementById('billFormTitle').innerHTML='<i class="fas fa-calendar-check text-indigo-500"></i> Recurring Bills'; document.getElementById('billSubmitBtn').innerHTML='<i class="fas fa-plus"></i>'; document.getElementById('cancelBillEditBtn').classList.add('hidden'); }
        function openWealthModal(type) { document.getElementById('wealthFormContainer').classList.remove('hidden'); document.getElementById('wealthType').value = type; document.getElementById('wealthFormTitle').innerText = type === 'asset' ? 'Add Asset' : 'Add Debt'; if(type === 'debt') document.getElementById('assetTypeContainer').classList.add('hidden'); else document.getElementById('assetTypeContainer').classList.remove('hidden'); }
        function openGoalModal() { document.getElementById('goalFormContainer').classList.remove('hidden'); }
        window.deleteTx = (i) => { db.transactions[monthPicker.value].splice(i, 1); saveData(); };
        window.deleteWealth = (t, i) => { if(t==='asset') db.assets.splice(i, 1); else db.debts.splice(i, 1); saveData(); };
        window.deleteGoal = (i) => { db.goals.splice(i, 1); saveData(); };
        window.deleteBill = (i) => { db.recurring.splice(i, 1); saveData(); };
        window.deleteCategory = (c) => { if(confirm("Delete?")) { db.categories = db.categories.filter(cat => cat !== c); delete db.budgets[c]; saveData(); } };
        window.deleteBudget = (c) => { delete db.budgets[c]; saveData(); };
        window.hardReset = () => { if(confirm("DELETE ALL?")) { localStorage.removeItem('infinityDB'); location.reload(); } };
        window.exportData = () => { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db)); a.download = "infinity_backup.json"; a.click(); };
        window.exportToCSV = () => { let csv = "data:text/csv;charset=utf-8,Date,Description,Category,Amount,Type\n"; Object.keys(db.transactions).forEach(m => { db.transactions[m].forEach(tx => { csv += `${m},"${tx.desc}",${tx.category},${tx.amount},${tx.type}\n`; }); }); const a = document.createElement("a"); a.href = encodeURI(csv); a.download = "infinity_data.csv"; document.body.appendChild(a); a.click(); };
        window.importData = (input) => { const file = input.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const d = JSON.parse(e.target.result); if(d.categories) { localStorage.setItem('infinityDB', JSON.stringify(d)); alert("Restored!"); location.reload(); } } catch(err) { alert("Error"); } }; reader.readAsText(file); };

        monthPicker.addEventListener('change', renderDashboard);
        checkAutoBills();
        renderAll();
    </script>
</body>
</html>