<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Finance Portfolio</title>
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #1e293b; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); -webkit-tap-highlight-color: transparent; }
        .glass-header { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(226, 232, 240, 0.6); }
        .card { background: #ffffff; border-radius: 24px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03); border: 1px solid #f1f5f9; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .btn-press:active { transform: scale(0.96); opacity: 0.9; }
        .nav-item { padding: 14px 18px; border-radius: 16px; font-weight: 600; color: #94a3b8; display: flex; align-items: center; gap: 14px; transition: all 0.2s ease; cursor: pointer; }
        .nav-item.active { background-color: #4f46e5; color: white; box-shadow: 0 8px 20px -6px rgba(79, 70, 229, 0.4); }
        .input-box { width: 100%; padding: 14px; border: 1px solid #e2e8f0; border-radius: 16px; outline: none; transition: 0.2s; background: #f8fafc; font-size: 15px; font-weight: 500; }
        .input-box:focus { border-color: #4f46e5; background: white; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scroll::-webkit-scrollbar { display: none; } .no-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .privacy-blur { filter: blur(8px); transition: filter 0.3s ease; user-select: none; }
        .fab { position: fixed; bottom: 30px; right: 20px; width: 56px; height: 56px; background: #4f46e5; color: white; border-radius: 50%; box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.5); display: flex; align-items: center; justify-content: center; font-size: 24px; transition: transform 0.2s; z-index: 40; }
        .fab:active { transform: scale(0.9); }
        #cloudLoader { position: fixed; top: calc(env(safe-area-inset-top) + 10px); right: 20px; z-index: 100; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 8px 16px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); font-size: 12px; font-weight: 700; color: #4f46e5; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: translateY(-200%); opacity: 0; }
        #cloudLoader.show { transform: translateY(0); opacity: 1; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-day { min-height: 80px; border-radius: 12px; background: white; border: 1px solid #f1f5f9; padding: 4px; display: flex; flex-direction: column; gap: 2px; }
        .cal-day.today { border: 2px solid #f59e0b; background-color: #fffbeb; }
        .bill-pill { font-size: 9px; padding: 3px 6px; border-radius: 6px; background: #eff6ff; color: #1e40af; font-weight: 700; border-left: 2px solid #3b82f6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .bill-pill.adjusted { border-left-color: #f59e0b; background: #fff7ed; color: #9a3412; }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden bg-[#f8fafc]">

    <div id="cloudLoader"><i class="fas fa-circle-notch fa-spin"></i> Syncing...</div>

    <div id="sidebar" class="w-full md:w-80 bg-[#0f172a] flex flex-col justify-between z-20 hidden md:flex h-full fixed md:relative shadow-2xl">
        <div class="p-8">
            <div class="flex items-center gap-4 mb-12">
                <img src="icon.png" class="w-14 h-14 rounded-2xl shadow-lg shadow-indigo-600/30 object-cover" onerror="this.style.display='none'">
                <h1 class="font-bold text-xl text-white tracking-tight leading-tight">Finance<br>Portfolio</h1>
            </div>
            <div class="mb-10">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3 block pl-1">Timeline</label>
                <input type="month" id="monthPicker" class="w-full p-4 bg-slate-800/50 border border-slate-700 rounded-2xl font-bold text-white focus:border-indigo-500 cursor-pointer outline-none transition hover:bg-slate-800">
            </div>
            <nav class="space-y-3">
                <div onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item active"><i class="fas fa-chart-pie w-5"></i> Dashboard</div>
                <div onclick="switchView('reports')" id="nav-reports" class="nav-item"><i class="fas fa-chart-line w-5"></i> Reports</div>
                <div onclick="switchView('calendar')" id="nav-calendar" class="nav-item"><i class="fas fa-calendar-day w-5"></i> Calendar</div>
                <div onclick="switchView('wealth')" id="nav-wealth" class="nav-item"><i class="fas fa-vault w-5"></i> Net Worth</div>
                <div onclick="switchView('settings')" id="nav-settings" class="nav-item"><i class="fas fa-sliders w-5"></i> Settings</div>
            </nav>
        </div>
        <div class="p-6 bg-slate-900/80 backdrop-blur-sm border-t border-slate-800 space-y-3">
            <button onclick="togglePrivacy()" class="btn-press text-xs text-slate-400 hover:text-white font-bold flex items-center gap-2 mb-2 w-full p-2 rounded hover:bg-slate-800 transition"><i id="privacyIconDesktop" class="fas fa-eye"></i> Toggle Privacy</button>
            <div id="cloudStatus" class="text-[10px] font-bold text-slate-500 flex items-center gap-2 mb-2 uppercase tracking-wide pl-1"><i class="fas fa-hdd"></i> Local Mode</div>
            <button onclick="manualSync()" id="manualSyncBtn" class="btn-press text-xs text-white bg-indigo-600 font-bold flex items-center justify-center gap-2 w-full p-3 rounded-xl hover:bg-indigo-500 transition hidden shadow-lg shadow-indigo-900/20"><i class="fas fa-sync"></i> Sync Now</button>
            <div class="flex gap-2">
                <button onclick="exportData()" class="btn-press text-xs text-slate-400 hover:text-white font-medium flex items-center justify-center gap-2 flex-1 p-3 rounded-xl bg-slate-800 hover:bg-slate-700 transition"><i class="fas fa-download"></i> Backup</button>
                <label class="btn-press text-xs text-slate-400 hover:text-white font-medium flex items-center justify-center gap-2 flex-1 p-3 rounded-xl bg-slate-800 hover:bg-slate-700 transition cursor-pointer"><i class="fas fa-upload"></i> Restore<input type="file" class="hidden" onchange="importData(this)"></label>
            </div>
        </div>
    </div>

    <div class="flex-1 flex flex-col h-full overflow-hidden relative bg-[#f8fafc]">
        <div class="md:hidden glass-header px-5 py-4 sticky top-0 z-30 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="icon.png" class="w-10 h-10 rounded-xl shadow-md shadow-indigo-200 object-cover" onerror="this.style.display='none'">
                <h1 class="font-bold text-lg text-slate-800 tracking-tight">Portfolio</h1>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="togglePrivacy()" class="w-9 h-9 bg-slate-100 text-slate-600 rounded-full flex items-center justify-center active:scale-90 transition"><i id="privacyIconMobile" class="fas fa-eye text-sm"></i></button>
                <button onclick="manualSync()" class="w-9 h-9 bg-slate-100 text-indigo-600 rounded-full flex items-center justify-center hidden active:scale-90 transition" id="mobileSyncBtn"><i class="fas fa-sync text-sm"></i></button>
                <button onclick="toggleMobileMenu()" class="w-9 h-9 bg-slate-100 text-slate-600 rounded-full flex items-center justify-center active:scale-90 transition"><i class="fas fa-bars text-sm"></i></button>
            </div>
        </div>

        <button onclick="document.getElementById('txFormCard').scrollIntoView({behavior:'smooth'});" class="fab md:hidden shadow-xl shadow-indigo-500/40"><i class="fas fa-plus"></i></button>

        <div class="flex-1 overflow-y-auto no-scroll p-5 md:p-12 pb-32">
            
            <div id="view-dashboard" class="view-section fade-in">
                <div class="card p-6 mb-8 bg-white border border-slate-100">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                        <div class="flex-1 text-center md:text-left">
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">Earned in <span id="currentYearLabel">2025</span></p>
                            <h2 class="text-4xl font-extrabold text-emerald-600 tracking-tight privacy-target" id="ytdIncomeDisplay">£0.00</h2>
                        </div>
                        <div class="hidden md:block w-px h-12 bg-slate-100"></div>
                        <div class="block md:hidden w-full h-px bg-slate-100"></div>
                        <div class="flex-1 text-center md:text-right group cursor-pointer" onclick="editAnnualIncome()">
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1 flex justify-center md:justify-end gap-2 items-center">Annual Salary <i class="fas fa-pen text-[10px] text-slate-300 group-hover:text-indigo-500 transition"></i></p>
                            <h2 class="text-4xl font-extrabold text-slate-800 tracking-tight privacy-target hover:text-indigo-600 transition" id="annualSalaryDisplay">£0.00</h2>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="card p-6 border-b-4 border-emerald-500 md:border-b-0 md:border-l-4"><p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Income</p><h2 class="text-3xl font-bold text-slate-800 tracking-tight privacy-target" id="kpiIncome">£0.00</h2></div>
                    <div class="card p-6 border-b-4 border-rose-500 md:border-b-0 md:border-l-4"><p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Expenses</p><h2 class="text-3xl font-bold text-slate-800 tracking-tight privacy-target" id="kpiExpense">£0.00</h2></div>
                    <div class="card p-6 border-b-4 border-indigo-500 md:border-b-0 md:border-l-4"><p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Net Flow</p><h2 class="text-3xl font-bold text-slate-800 tracking-tight privacy-target" id="kpiBalance">£0.00</h2></div>
                    <div class="card p-6 bg-gradient-to-br from-indigo-600 to-violet-600 text-white border-none shadow-lg shadow-indigo-200"><p class="text-xs text-indigo-100 font-bold uppercase tracking-wider mb-1">Top Spend</p><h2 class="text-2xl font-bold mt-1 truncate" id="kpiTopCat">None</h2><p class="text-sm text-indigo-100 font-medium opacity-80 privacy-target" id="kpiTopCatVal">£0.00</p></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="card p-6"><div class="mb-6"><div class="flex justify-between items-center"><h3 class="font-bold text-lg text-slate-800">Analytics</h3><span class="px-3 py-1 bg-slate-100 rounded-full text-xs font-bold text-slate-500">6 Months</span></div><div class="flex gap-6 mt-3"><div><p class="text-[10px] text-slate-400 font-bold uppercase">Total In</p><p class="text-sm font-bold text-emerald-600 privacy-target" id="trendTotalIncome">£0</p></div><div><p class="text-[10px] text-slate-400 font-bold uppercase">Total Out</p><p class="text-sm font-bold text-rose-600 privacy-target" id="trendTotalExpense">£0</p></div></div></div><div class="h-64 w-full"><canvas id="trendChart"></canvas></div></div>
                    <div class="card p-6 flex flex-col items-center justify-center"><h3 class="font-bold text-lg text-slate-800 mb-6 w-full text-left">Breakdown</h3><div class="h-64 w-full flex justify-center"><canvas id="spendingChart"></canvas></div></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="card p-6 h-fit" id="txFormCard">
                        <div class="flex justify-between items-center mb-6"><h3 class="font-bold text-lg text-slate-800" id="txFormTitle">Log Item</h3><button id="cancelEditTxBtn" onclick="cancelTxEdit()" class="hidden text-xs text-rose-500 font-bold">Cancel</button></div>
                        <form id="txForm" class="space-y-5">
                            <div class="grid grid-cols-2 gap-2 p-1 bg-slate-100 rounded-2xl"><button type="button" onclick="setTxType('expense')" id="btn-expense" class="btn-press py-3 rounded-xl text-sm font-bold bg-white text-rose-600 shadow-sm transition-all">Expense</button><button type="button" onclick="setTxType('income')" id="btn-income" class="btn-press py-3 rounded-xl text-sm font-bold text-slate-400 transition-all">Income</button></div>
                            <input type="hidden" id="txType" value="expense"><input type="text" id="txDesc" placeholder="Description" class="input-box" required>
                            <div class="flex gap-3"><input type="number" id="txAmount" placeholder="0.00" step="0.01" class="input-box w-1/2" required><div class="relative w-1/2"><select id="txCategory" class="input-box w-full appearance-none bg-white cursor-pointer"></select><div class="absolute right-4 top-4 text-slate-400 pointer-events-none"><i class="fas fa-chevron-down text-xs"></i></div></div></div>
                            <div class="space-y-3 pt-1">
                                <div id="debtLinkContainer" class="hidden bg-slate-50 p-3 rounded-2xl border border-slate-100"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" id="isDebtPayment" class="w-5 h-5 text-indigo-600 rounded-md border-slate-300 focus:ring-indigo-500"><span class="text-sm font-bold text-slate-700">Is this a Debt Payment?</span></label><div id="debtSelector" class="hidden mt-3"><select id="linkedDebtId" class="input-box bg-white"><option value="">Select Liability...</option></select></div></div>
                                <div id="roundUpContainer" class="hidden bg-slate-50 p-3 rounded-2xl border border-slate-100"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" id="isRoundUp" class="w-5 h-5 text-emerald-600 rounded-md border-slate-300 focus:ring-emerald-500"><div><span class="text-sm font-bold text-slate-700 block">Auto Round-Up</span><span class="text-xs text-slate-400">Save the change</span></div></label><div id="roundUpSelector" class="hidden mt-3"><label class="text-[10px] font-bold text-slate-400 uppercase tracking-wide ml-1">Send to Asset</label><select id="roundUpTarget" class="input-box bg-white mt-1"></select></div></div>
                            </div>
                            <button type="submit" id="submitBtn" class="btn-press w-full py-4 rounded-2xl font-bold text-white bg-rose-600 hover:bg-rose-700 shadow-lg shadow-rose-200 transition-all text-base">Log Expense</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2"><div class="card p-6 min-h-[400px]"><h3 class="font-bold text-lg text-slate-800 mb-6">History</h3><div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead class="text-xs font-bold text-slate-400 uppercase border-b border-slate-100"><tr><th class="pb-3 pl-2">Item</th><th class="pb-3 text-right">Value</th><th class="pb-3 text-right pr-2">Edit</th></tr></thead><tbody id="txTableBody" class="text-sm font-medium"></tbody></table><div id="listEmptyState" class="hidden py-12 text-center text-slate-400 text-sm font-medium">No transactions this month.</div></div></div></div>
                </div>
            </div>

            <div id="view-reports" class="view-section hidden fade-in">
                <div class="mb-8"><h2 class="text-2xl font-bold text-slate-800">Monthly Reports</h2></div>
                <div class="card p-6 overflow-hidden">
                    <table class="w-full text-left border-collapse min-w-[500px]">
                        <thead><tr class="text-xs font-bold text-slate-400 uppercase border-b border-slate-100"><th class="py-4 pl-2">Month</th><th class="py-4 text-right text-emerald-600">In</th><th class="py-4 text-right text-rose-600">Out</th><th class="py-4 text-right text-indigo-600">Net</th><th class="py-4 text-right pr-2">Rate</th></tr></thead>
                        <tbody id="reportsTableBody" class="text-sm font-semibold text-slate-700"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-calendar" class="view-section hidden fade-in"><div class="flex justify-between items-end mb-8"><div><h2 class="text-2xl font-bold text-slate-800">Bill Calendar</h2><p class="text-slate-500 text-sm mt-1 font-medium">Total: <span id="calTotalBills" class="font-bold text-indigo-600">£0.00</span></p></div><button onclick="switchView('settings')" class="text-xs bg-white border border-slate-200 px-4 py-2 rounded-full font-bold shadow-sm">Manage</button></div><div class="card p-6"><div class="calendar-grid mb-4"><div class="text-[10px] text-slate-400 font-bold text-center uppercase tracking-wide">Mon</div><div class="text-[10px] text-slate-400 font-bold text-center uppercase tracking-wide">Tue</div><div class="text-[10px] text-slate-400 font-bold text-center uppercase tracking-wide">Wed</div><div class="text-[10px] text-slate-400 font-bold text-center uppercase tracking-wide">Thu</div><div class="text-[10px] text-slate-400 font-bold text-center uppercase tracking-wide">Fri</div><div class="text-[10px] text-slate-400 font-bold text-center uppercase tracking-wide">Sat</div><div class="text-[10px] text-slate-400 font-bold text-center uppercase tracking-wide">Sun</div></div><div id="calendarGrid" class="calendar-grid"></div></div></div>
            
            <div id="view-wealth" class="view-section hidden fade-in"><div class="card bg-gradient-to-r from-slate-900 to-slate-800 text-white p-8 md:p-10 mb-8 relative overflow-hidden border-none shadow-2xl"><div class="relative z-10 flex flex-col md:flex-row justify-between items-end gap-6"><div><p class="text-slate-400 font-bold uppercase text-[10px] tracking-widest mb-2">Net Worth</p><h1 class="text-5xl md:text-6xl font-extrabold tracking-tight privacy-target" id="totalWealth">£0.00</h1><div class="mt-4 flex gap-6 text-sm font-medium"><span class="text-emerald-400 flex items-center gap-2"><i class="fas fa-arrow-up"></i> <span class="privacy-target" id="valAssets">£0</span></span><span class="text-rose-400 flex items-center gap-2"><i class="fas fa-arrow-down"></i> <span class="privacy-target" id="valDebt">£0</span></span></div></div><div class="text-right bg-white/10 p-4 rounded-2xl backdrop-blur-md border border-white/10"><p class="text-[10px] text-slate-300 uppercase font-bold tracking-widest mb-1">FIRE Status</p><p class="text-2xl font-bold text-yellow-400" id="fireEstimate">...</p></div></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="space-y-6"><div class="card p-6"><div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4"><h3 class="font-bold text-lg text-slate-800">Assets</h3><button onclick="openWealthModal('asset')" class="text-xs bg-slate-900 text-white font-bold px-4 py-2 rounded-full hover:bg-slate-700 transition">Add</button></div><ul id="assetList" class="space-y-3 max-h-80 overflow-y-auto no-scroll pr-2"></ul></div><div class="card p-6 border-l-4 border-rose-500"><div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4"><h3 class="font-bold text-lg text-slate-800">Liabilities</h3><button onclick="openWealthModal('debt')" class="text-xs bg-rose-600 text-white font-bold px-4 py-2 rounded-full hover:bg-rose-700 transition">Add</button></div><ul id="debtList" class="space-y-3 max-h-80 overflow-y-auto no-scroll pr-2"></ul></div></div><div class="card p-6 flex flex-col items-center"><h3 class="font-bold text-lg text-slate-800 mb-6 w-full">Allocation</h3><div class="h-80 w-full flex justify-center"><canvas id="wealthChart"></canvas></div></div></div></div>

            <div id="view-settings" class="view-section hidden fade-in">
                <div class="card p-8 max-w-2xl mx-auto space-y-10">
                    <div><h2 class="text-2xl font-bold text-slate-800">Settings</h2></div>
                    <div class="bg-indigo-50/50 p-6 rounded-3xl border border-indigo-100"><h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fas fa-cloud text-indigo-600"></i> Cloud Sync</h3><p class="text-xs text-slate-500 mb-4">Link Google Apps Script to sync iPhone & Laptop.</p><div class="flex gap-2"><form id="cloudForm" class="flex-1 flex gap-2"><input type="text" id="cloudUrlInput" placeholder="https://script.google.com/..." class="input-box bg-white" required><button type="submit" class="btn-press px-6 bg-indigo-600 text-white rounded-2xl font-bold shadow-md shadow-indigo-200">Link</button></form><button onclick="disconnectCloud()" class="btn-press px-4 bg-white text-rose-500 border border-rose-100 rounded-2xl font-bold hover:bg-rose-50 transition" title="Disconnect"><i class="fas fa-unlink"></i></button></div><div id="cloudMsg" class="mt-3 text-xs font-bold text-emerald-600 flex items-center gap-2 hidden"><i class="fas fa-check-circle"></i> Sync Active</div></div>
                    <div class="border-b border-slate-100 pb-8"><button onclick="debugData()" class="text-indigo-600 font-bold text-sm flex items-center gap-2 hover:underline"><i class="fas fa-wrench"></i> Debug / Recover Data</button></div>
                    <div><h3 class="font-bold text-slate-800 mb-4">Budgets</h3><form id="budgetForm" class="flex gap-3 mb-4"><select id="budgetCat" class="input-box w-1/2"></select><input type="number" id="budgetLimit" placeholder="Limit" class="input-box w-1/3" step="0.01" required><button type="submit" class="btn-press w-14 bg-emerald-500 text-white rounded-2xl hover:bg-emerald-600 shadow-md shadow-emerald-200"><i class="fas fa-plus"></i></button></form><ul id="budgetSettingsList" class="space-y-3"></ul></div>
                    <div class="border-t border-slate-100 pt-8" id="billFormContainer"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-800">Recurring Bills</h3><button onclick="cancelBillEdit()" id="cancelBillEditBtn" class="hidden text-xs text-rose-500 font-bold">Cancel</button></div><form id="billForm" class="flex gap-3 mb-4"><input type="number" id="billDay" placeholder="Day" class="input-box w-20 text-center" min="1" max="31" required><input type="text" id="billDesc" placeholder="Bill Name" class="input-box flex-1" required><input type="number" id="billAmount" placeholder="£" class="input-box w-24" step="0.01" required><button type="submit" id="billSubmitBtn" class="btn-press w-14 bg-indigo-600 text-white rounded-2xl hover:bg-indigo-700 shadow-md shadow-indigo-200"><i class="fas fa-plus"></i></button></form><ul id="billList" class="space-y-3"></ul></div>
                    <div class="border-t border-slate-100 pt-8"><h3 class="font-bold text-slate-800 mb-4">Categories</h3><form id="catForm" class="flex gap-3 mb-6"><input type="text" id="newCatName" placeholder="New Category Name" class="input-box" required><button type="submit" class="btn-press px-6 bg-slate-800 text-white rounded-2xl font-bold">Add</button></form><div class="flex flex-wrap gap-2" id="settingsCatList"></div></div>
                    <div class="border-t border-slate-100 pt-8"><button onclick="hardReset()" class="text-rose-500 font-bold text-sm hover:bg-rose-50 px-4 py-2 rounded-xl transition w-full text-center">Reset All App Data</button></div>
                </div>
            </div>

            <div id="wealthFormContainer" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 transition-all"><div class="card p-8 w-full max-w-sm shadow-2xl scale-100"><h3 class="font-bold text-xl mb-6 text-slate-800" id="wealthFormTitle">Add Item</h3><form id="wealthForm" class="space-y-4"><input type="hidden" id="wealthType"><input type="text" id="wealthName" placeholder="Name" class="input-box" required><input type="number" id="wealthValue" placeholder="Value (£)" class="input-box" step="0.01" required><div id="assetTypeContainer"><label class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Category</label><div class="relative mt-1"><select id="wealthCategory" class="input-box appearance-none bg-white"><option value="Savings">Savings</option><option value="Investment">Investment</option><option value="Stock">Stock</option><option value="Crypto">Crypto</option><option value="Property">Property</option><option value="Pension">Pension</option></select><div class="absolute right-4 top-4 text-slate-400 pointer-events-none"><i class="fas fa-chevron-down text-xs"></i></div></div></div><div class="flex gap-3 pt-4"><button type="button" onclick="closeWealthModal()" class="w-1/2 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">Cancel</button><button type="submit" class="w-1/2 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200">Save</button></div></form></div></div>
            <div id="goalFormContainer" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-4"><div class="card p-8 w-full max-w-sm shadow-2xl"><h3 class="font-bold text-xl mb-6 text-slate-800">Add Savings Goal</h3><form id="goalForm" class="space-y-4"><input type="text" id="goalName" placeholder="Goal Name" class="input-box" required><input type="number" id="goalTarget" placeholder="Target Amount (£)" class="input-box" step="0.01" required><input type="number" id="goalCurrent" placeholder="Current Saved (£)" class="input-box" step="0.01" required><div class="flex gap-3 pt-4"><button type="button" onclick="document.getElementById('goalFormContainer').classList.add('hidden')" class="w-1/2 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">Cancel</button><button type="submit" class="w-1/2 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200">Save</button></div></form></div></div>
        </div>
    </div>

    <script>
        // 1. DATA RECOVERY
        function fixData() {
            let data = { categories: ['Housing', 'Food', 'Transport', 'Utilities', 'Entertainment', 'Health', 'Savings'], transactions: {}, assets: [], debts: [], recurring: [], budgets: {}, goals: [], billLog: [], annualIncome: 0 };
            try {
                const raw = localStorage.getItem('infinityDB');
                if (raw) {
                    const parsed = JSON.parse(raw);
                    if(parsed.categories) data = parsed;
                }
            } catch(e) { console.error("DB Reset"); }
            
            // Critical Fix: Transactions must be object
            if(Array.isArray(data.transactions)) data.transactions = {};
            // Array Fixes
            ['assets','debts','recurring','goals'].forEach(k => { if(!Array.isArray(data[k])) data[k] = []; });
            if(!data.budgets) data.budgets = {};
            
            localStorage.setItem('infinityDB', JSON.stringify(data));
            return data;
        }
        let db = fixData();
        Chart.register(ChartDataLabels);

        // 2. GLOBALS
        let cloudUrl = localStorage.getItem('infinityCloudUrl') || "";
        let privacyMode = localStorage.getItem('infinityPrivacy') === 'true';
        let editingTxIndex = null, editingWealthIndex = null, editingWealthType = null, editingBillIndex = null, currentTxType = 'expense';
        const monthPicker = document.getElementById('monthPicker'); 
        const today = new Date(); 
        monthPicker.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        let trendChart = null, wealthChart = null, spendingChart = null;
        const fmt = (num) => parseFloat(num).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        function getCategoryColor(c) { let h=0;for(let i=0;i<c.length;i++)h=c.charCodeAt(i)+((h<<5)-h);return ['#14b8a6','#f97316','#a855f7','#d946ef','#0ea5e9','#84cc16'][Math.abs(h)%6]; }

        // 3. CORE LOGIC
        function saveData() { localStorage.setItem('infinityDB', JSON.stringify(db)); if(cloudUrl) saveToCloud(); renderAll(); }
        function switchView(view) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById(`view-${view}`);
            if(target) target.classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const nav = document.getElementById(`nav-${view}`);
            if(nav) nav.classList.add('active');

            if(window.innerWidth < 768) toggleMobileMenu();
            if(view === 'dashboard') { try{ trendChart?.resize(); spendingChart?.resize(); }catch(e){} }
            if(view === 'wealth') { try{ wealthChart?.resize(); }catch(e){} }
            // Force re-renders with safety
            if(view === 'reports') try { renderReports(); } catch(e) { console.error(e); }
            if(view === 'calendar') try { renderCalendar(); } catch(e) { console.error(e); }
        }

        // 4. WRAPPED RENDERERS
        function renderReports() {
            try {
                const tbody = document.getElementById('reportsTableBody');
                if(!tbody) return;
                const months = Object.keys(db.transactions).sort().reverse();
                let html = '';
                if(months.length === 0) html = `<tr><td colspan="5" class="text-center py-12 text-slate-400">No records found.</td></tr>`;
                else {
                    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                    months.forEach(m => {
                        const txs = db.transactions[m] || [];
                        let inc=0, exp=0;
                        txs.forEach(t => { const v = parseFloat(t.amount)||0; if(t.type==='income') inc+=v; else exp+=v; });
                        const net = inc - exp;
                        const rate = inc > 0 ? Math.round((net/inc)*100) : 0;
                        const parts = m.split('-');
                        let dLabel = m;
                        if(parts.length===2) { dLabel = `${monthNames[parseInt(parts[1])-1] || parts[1]} ${parts[0]}`; }
                        html += `<tr class="border-b border-slate-50 hover:bg-slate-50"><td class="py-4 pl-2 font-bold">${dLabel}</td><td class="py-4 text-right text-emerald-600">£${fmt(inc)}</td><td class="py-4 text-right text-rose-600">£${fmt(exp)}</td><td class="py-4 text-right text-indigo-600">£${fmt(net)}</td><td class="py-4 text-right pr-2 text-slate-400">${rate}%</td></tr>`;
                    });
                }
                tbody.innerHTML = html;
            } catch(e) { console.error("Report Error", e); }
        }

        function renderCalendar() {
            try {
                const grid = document.getElementById('calendarGrid');
                if(!grid) return;
                grid.innerHTML = '';
                const [yStr, mStr] = monthPicker.value.split('-');
                const y = parseInt(yStr), m = parseInt(mStr);
                const firstDay = new Date(y, m-1, 1).getDay(); // 0=Sun
                let pad = firstDay === 0 ? 6 : firstDay - 1; // Mon start
                const days = new Date(y, m, 0).getDate();
                
                for(let i=0; i<pad; i++) grid.innerHTML += `<div class="cal-day bg-slate-50/50 border-transparent"></div>`;
                
                for(let i=1; i<=days; i++) {
                    let pills = '';
                    const bills = db.recurring.filter(b => parseInt(b.day) === i);
                    bills.forEach(b => { pills += `<div class="bill-pill">${b.desc}: £${b.amount}</div>`; });
                    grid.innerHTML += `<div class="cal-day"><div class="text-[10px] font-bold text-slate-400 mb-1">${i}</div><div class="flex flex-col gap-1 overflow-hidden">${pills}</div></div>`;
                }
                const total = db.recurring.reduce((sum, b) => sum + (parseFloat(b.amount)||0), 0);
                document.getElementById('calTotalBills').innerText = `£${fmt(total)}`;
            } catch(e) { console.error("Calendar Error", e); }
        }

        function renderWealth() {
            try {
                const al = document.getElementById('assetList'); al.innerHTML = '';
                let ta = 0; db.assets.forEach((a,i) => { ta+=parseFloat(a.value); al.innerHTML += `<li class="flex justify-between p-4 bg-slate-50 rounded-2xl mb-2"><span>${a.name}</span><span>£${fmt(a.value)} <button onclick="deleteWealth('asset',${i})" class="ml-2 text-rose-500"><i class="fas fa-times"></i></button></span></li>`; });
                const dl = document.getElementById('debtList'); dl.innerHTML = '';
                let td = 0; db.debts.forEach((d,i) => { td+=parseFloat(d.value); dl.innerHTML += `<li class="flex justify-between p-4 bg-slate-50 rounded-2xl mb-2"><span>${d.name}</span><span>£${fmt(d.value)} <button onclick="deleteWealth('debt',${i})" class="ml-2 text-rose-500"><i class="fas fa-times"></i></button></span></li>`; });
                document.getElementById('totalWealth').innerText = `£${fmt(ta-td)}`;
                document.getElementById('valAssets').innerText = `£${fmt(ta)}`;
                document.getElementById('valDebt').innerText = `£${fmt(td)}`;
                updateWealthChart({Assets: ta, Debts: td});
            } catch(e) { console.error("Wealth Error", e); }
        }

        function renderDashboard() {
            try {
                const k = monthPicker.value;
                const data = db.transactions[k] || [];
                let i=0, e=0, cats={};
                data.forEach(t => { const v=parseFloat(t.amount); if(t.type==='income') i+=v; else { e+=v; cats[t.category]=(cats[t.category]||0)+v; } });
                
                document.getElementById('kpiIncome').innerText = `£${fmt(i)}`;
                document.getElementById('kpiExpense').innerText = `£${fmt(e)}`;
                document.getElementById('kpiBalance').innerText = `£${fmt(i-e)}`;
                
                // History
                const tb = document.getElementById('txTableBody'); tb.innerHTML = '';
                if(data.length===0) document.getElementById('listEmptyState').classList.remove('hidden');
                else {
                    document.getElementById('listEmptyState').classList.add('hidden');
                    data.slice().reverse().forEach((tx, idx) => {
                        const realIdx = data.length - 1 - idx;
                        tb.innerHTML += `<tr class="border-b border-slate-50"><td class="py-4 pl-2 font-bold text-slate-700">${tx.desc}<div class="text-xs text-slate-400 font-normal">${tx.category}</div></td><td class="py-4 text-right font-bold ${tx.type==='income'?'text-emerald-500':'text-slate-700'}">${tx.type==='income'?'+':'-'}£${fmt(tx.amount)}</td><td class="py-4 text-right"><button onclick="deleteTx(${realIdx})" class="text-slate-300 hover:text-rose-500"><i class="fas fa-trash-alt"></i></button></td></tr>`;
                    });
                }
                
                // Salary
                const y = new Date().getFullYear();
                let ytd = 0;
                Object.keys(db.transactions).forEach(mk => { if(mk.startsWith(y)) db.transactions[mk].forEach(t => { if(t.type==='income') ytd+=parseFloat(t.amount); }); });
                document.getElementById('ytdIncomeDisplay').innerText = `£${fmt(ytd)}`;
                document.getElementById('annualSalaryDisplay').innerText = `£${fmt(db.annualIncome)}`;
                
                updateSpendingChart(cats);
            } catch(err) { console.error("Dash Error", err); }
        }

        // 5. HELPER FUNCTIONS
        function renderAll() {
            renderDashboard();
            try { renderReports(); } catch(e){}
            try { renderCalendar(); } catch(e){}
            try { renderWealth(); } catch(e){}
            try { renderSettings(); } catch(e){}
            try { renderDropdowns(); } catch(e){}
        }
        
        function renderSettings() { const l = document.getElementById('billList'); l.innerHTML=''; db.recurring.forEach((b,i) => l.innerHTML += `<li class="p-3 bg-slate-50 mb-2 rounded flex justify-between"><span>Day ${b.day}: ${b.desc}</span><span>£${b.amount} <button onclick="deleteBill(${i})" class="text-rose-500 ml-2">x</button></span></li>`); }
        function renderDropdowns() { const s = document.getElementById('txCategory'); s.innerHTML=''; db.categories.forEach(c => s.innerHTML+=`<option value="${c}">${c}</option>`); }
        
        function toggleMobileMenu() { document.getElementById('sidebar').classList.toggle('hidden'); document.getElementById('sidebar').classList.toggle('fixed'); document.getElementById('sidebar').classList.toggle('inset-0'); }
        function togglePrivacy() { privacyMode = !privacyMode; localStorage.setItem('infinityPrivacy', privacyMode); document.querySelectorAll('.privacy-target').forEach(e => e.classList.toggle('privacy-blur', privacyMode)); }
        
        // Forms
        document.getElementById('txForm').addEventListener('submit', e => { e.preventDefault(); const k=monthPicker.value; if(!db.transactions[k]) db.transactions[k]=[]; db.transactions[k].push({ desc: document.getElementById('txDesc').value, amount: parseFloat(document.getElementById('txAmount').value), category: document.getElementById('txCategory').value, type: currentTxType }); saveData(); document.getElementById('txForm').reset(); });
        document.getElementById('billForm').addEventListener('submit', e => { e.preventDefault(); db.recurring.push({ day: document.getElementById('billDay').value, desc: document.getElementById('billDesc').value, amount: document.getElementById('billAmount').value }); saveData(); document.getElementById('billForm').reset(); });
        document.getElementById('wealthForm').addEventListener('submit', e => { e.preventDefault(); const t=document.getElementById('wealthType').value; const item = { name: document.getElementById('wealthName').value, value: document.getElementById('wealthValue').value, type: document.getElementById('wealthCategory').value }; if(t==='asset') db.assets.push(item); else db.debts.push(item); closeWealthModal(); saveData(); });
        
        // Deletion
        window.deleteTx = (i) => { db.transactions[monthPicker.value].splice(i, 1); saveData(); };
        window.deleteBill = (i) => { db.recurring.splice(i, 1); saveData(); };
        window.deleteWealth = (t, i) => { if(t==='asset') db.assets.splice(i,1); else db.debts.splice(i,1); saveData(); };
        window.hardReset = () => { if(confirm("Delete everything?")) { localStorage.removeItem('infinityDB'); location.reload(); } };
        
        // UI Helpers
        function setTxType(t) { currentTxType = t; document.getElementById('btn-expense').className = t==='expense' ? 'btn-press py-3 rounded-xl text-sm font-bold bg-white text-rose-600 shadow-sm' : 'btn-press py-3 rounded-xl text-sm font-bold text-slate-400'; document.getElementById('btn-income').className = t==='income' ? 'btn-press py-3 rounded-xl text-sm font-bold bg-white text-emerald-600 shadow-sm' : 'btn-press py-3 rounded-xl text-sm font-bold text-slate-400'; }
        function openWealthModal(t) { document.getElementById('wealthFormContainer').classList.remove('hidden'); document.getElementById('wealthType').value=t; }
        function closeWealthModal() { document.getElementById('wealthFormContainer').classList.add('hidden'); }
        function editAnnualIncome() { const v=prompt("Annual Salary:", db.annualIncome); if(v) { db.annualIncome=parseFloat(v); saveData(); } }
        
        // Charts (Simplified)
        function updateSpendingChart(cats) { try { if(spendingChart) spendingChart.destroy(); const ctx=document.getElementById('spendingChart').getContext('2d'); spendingChart = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: Object.keys(cats).map(getCategoryColor) }] }, options: { plugins: { legend: { display: false } } } }); } catch(e){} }
        function updateWealthChart(d) { try { if(wealthChart) wealthChart.destroy(); const ctx=document.getElementById('wealthChart').getContext('2d'); wealthChart = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(d), datasets: [{ data: Object.values(d), backgroundColor: ['#10b981', '#f43f5e'] }] }, options: { plugins: { legend: { display: false } } } }); } catch(e){} }

        // Start
        monthPicker.addEventListener('change', renderAll);
        renderAll();
    </script>
</body>
</html>
