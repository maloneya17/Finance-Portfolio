<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Finance Portfolio</title>
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* CORE */
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #1e293b; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        
        /* INTERACTION FIXES */
        .glass-header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); pointer-events: none; }
        .glass-header * { pointer-events: auto; }
        
        /* UI */
        .card { background: #ffffff; border-radius: 24px; box-shadow: 0 4px 25px rgba(0, 0, 0, 0.03); border: 1px solid #f1f5f9; transition: transform 0.1s ease; }
        .btn-press:active { transform: scale(0.96); opacity: 0.9; }
        .input-box { width: 100%; padding: 14px 16px; border: 1px solid #e2e8f0; border-radius: 16px; outline: none; transition: 0.2s; background: #f8fafc; font-size: 15px; font-weight: 500; }
        .input-box:focus { border-color: #4f46e5; background: white; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.05); }
        .nav-item { padding: 12px 16px; border-radius: 14px; font-weight: 600; color: #94a3b8; display: flex; align-items: center; gap: 12px; transition: all 0.2s; cursor: pointer; }
        .nav-item.active { background-color: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); }
        .privacy-blur { filter: blur(8px); transition: filter 0.3s ease; user-select: none; }

        /* CHART CONTAINER FIX */
        .chart-container { position: relative; height: 250px; width: 100%; }

        /* CALENDAR & TABLES */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-day { min-height: 80px; border-radius: 12px; background: white; border: 1px solid #f1f5f9; padding: 4px; display: flex; flex-direction: column; gap: 4px; }
        .cal-day.today { border: 2px solid #f59e0b; background-color: #fffbeb; }
        .bill-pill { font-size: 9px; padding: 3px 6px; border-radius: 6px; background: #eff6ff; color: #1e40af; font-weight: 700; border-left: 2px solid #3b82f6; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .bill-pill.adjusted { border-left-color: #f59e0b; background: #fff7ed; color: #9a3412; }
        .clean-table th { font-size: 11px; letter-spacing: 0.05em; color: #94a3b8; padding-bottom: 12px; border-bottom: 1px solid #f1f5f9; text-transform: uppercase; }
        .clean-table td { padding: 14px 0; border-bottom: 1px solid #f8fafc; font-size: 14px; }

        /* LOADER */
        #cloudLoader { position: fixed; top: calc(env(safe-area-inset-top) + 10px); right: 20px; z-index: 100; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 8px 16px; border-radius: 50px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); font-size: 12px; font-weight: 700; color: #4f46e5; transition: 0.4s; transform: translateY(-200%); opacity: 0; pointer-events: none; }
        #cloudLoader.show { transform: translateY(0); opacity: 1; }
        .fab { position: fixed; bottom: 30px; right: 20px; width: 56px; height: 56px; background: #4f46e5; color: white; border-radius: 50%; box-shadow: 0 15px 30px -5px rgba(79, 70, 229, 0.4); display: flex; align-items: center; justify-content: center; font-size: 24px; transition: transform 0.2s; z-index: 40; }
        .fab:active { transform: scale(0.9); }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden bg-[#f8fafc]">

    <div id="cloudLoader"><i class="fas fa-circle-notch fa-spin"></i> Syncing...</div>

    <div id="sidebar" class="w-full md:w-80 bg-[#0f172a] flex flex-col justify-between z-50 hidden md:flex h-full fixed md:relative shadow-2xl">
        <div class="p-8">
            <div class="flex items-center gap-4 mb-12">
                <img src="icon.png" class="w-14 h-14 rounded-2xl shadow-lg shadow-indigo-600/30 object-cover bg-white" onerror="this.style.display='none'">
                <h1 class="font-bold text-xl text-white tracking-tight leading-tight">Finance<br>Portfolio</h1>
            </div>
            <div class="mb-10">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3 block pl-1">Timeline</label>
                <input type="month" id="monthPicker" class="w-full p-4 bg-slate-800/50 border border-slate-700 rounded-2xl font-bold text-white focus:border-indigo-500 cursor-pointer outline-none transition hover:bg-slate-800">
            </div>
            <nav class="space-y-3">
                <div onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item active"><i class="fas fa-chart-pie w-5"></i> Dashboard</div>
                <div onclick="switchView('reports')" id="nav-reports" class="nav-item"><i class="fas fa-chart-line w-5"></i> Reports</div>
                <div onclick="switchView('calendar')" id="nav-calendar" class="nav-item"><i class="fas fa-calendar-day w-5"></i> Calendar</div>
                <div onclick="switchView('wealth')" id="nav-wealth" class="nav-item"><i class="fas fa-vault w-5"></i> Net Worth</div>
                <div onclick="switchView('settings')" id="nav-settings" class="nav-item"><i class="fas fa-sliders w-5"></i> Settings</div>
            </nav>
        </div>
        <div class="p-6 bg-slate-900/80 backdrop-blur-sm border-t border-slate-800 space-y-3">
            <button onclick="togglePrivacy()" class="btn-press text-xs text-slate-400 hover:text-white font-bold flex items-center gap-2 mb-2 w-full p-2 rounded hover:bg-slate-800 transition"><i id="privacyIconDesktop" class="fas fa-eye"></i> Privacy Mode</button>
            <div id="cloudStatus" class="text-[10px] font-bold text-slate-500 flex items-center gap-2 mb-2 uppercase tracking-wide pl-1"><i class="fas fa-hdd"></i> Local Mode</div>
            <button onclick="manualSync()" id="manualSyncBtn" class="btn-press text-xs text-white bg-indigo-600 font-bold flex items-center justify-center gap-2 w-full p-3 rounded-xl hover:bg-indigo-500 transition hidden shadow-lg shadow-indigo-900/20"><i class="fas fa-sync"></i> Sync Now</button>
            <div class="flex gap-2">
                <button onclick="exportData()" class="btn-press text-xs text-slate-400 hover:text-white font-medium flex items-center justify-center gap-2 flex-1 p-3 rounded-xl bg-slate-800 hover:bg-slate-700 transition"><i class="fas fa-download"></i> Backup</button>
                <label class="btn-press text-xs text-slate-400 hover:text-white font-medium flex items-center justify-center gap-2 flex-1 p-3 rounded-xl bg-slate-800 hover:bg-slate-700 transition cursor-pointer"><i class="fas fa-upload"></i> Restore<input type="file" class="hidden" onchange="importData(this)"></label>
            </div>
        </div>
    </div>

    <div class="flex-1 flex flex-col h-full overflow-hidden relative bg-[#f8fafc]">
        
        <div class="md:hidden glass-header px-5 py-4 sticky top-0 z-30 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="icon.png" class="w-10 h-10 rounded-xl shadow-md shadow-indigo-200 object-cover bg-white" onerror="this.style.display='none'">
                <h1 class="font-bold text-lg text-slate-800 tracking-tight">Portfolio</h1>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="togglePrivacy()" class="w-9 h-9 bg-slate-100 text-slate-600 rounded-full flex items-center justify-center active:scale-90 transition"><i id="privacyIconMobile" class="fas fa-eye text-sm"></i></button>
                <button onclick="manualSync()" class="w-9 h-9 bg-slate-100 text-indigo-600 rounded-full flex items-center justify-center hidden active:scale-90 transition" id="mobileSyncBtn"><i class="fas fa-sync text-sm"></i></button>
                <button onclick="toggleMobileMenu()" class="w-9 h-9 bg-slate-100 text-slate-600 rounded-full flex items-center justify-center active:scale-90 transition"><i class="fas fa-bars text-sm"></i></button>
            </div>
        </div>

        <button onclick="document.getElementById('txFormCard').scrollIntoView({behavior:'smooth'});" class="fab md:hidden shadow-xl shadow-indigo-500/40"><i class="fas fa-plus"></i></button>

        <div class="flex-1 overflow-y-auto no-scroll p-5 md:p-12 pb-32">
            
            <div id="view-dashboard" class="view-section fade-in">
                <div class="card p-6 mb-8 bg-white border border-slate-100">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                        <div class="flex-1 text-center md:text-left">
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">Earned in <span id="currentYearLabel">2025</span></p>
                            <h2 class="text-4xl font-extrabold text-emerald-600 tracking-tight privacy-target" id="ytdIncomeDisplay">£0.00</h2>
                        </div>
                        <div class="hidden md:block w-px h-12 bg-slate-100"></div>
                        <div class="flex-1 text-center md:text-right group cursor-pointer" onclick="editAnnualIncome()">
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1 flex justify-center md:justify-end gap-2 items-center">
                                Annual Salary <i class="fas fa-pen text-[10px] text-slate-300 group-hover:text-indigo-500 transition"></i>
                            </p>
                            <h2 class="text-4xl font-extrabold text-slate-800 tracking-tight privacy-target hover:text-indigo-600 transition" id="annualSalaryDisplay">£0.00</h2>
                        </div>
                    </div>
                </div>

                <div id="notificationArea" class="space-y-3 mb-8">
                    <div id="autoPayNotification" class="hidden p-4 bg-white border-l-4 border-indigo-500 rounded-2xl flex items-center gap-4 shadow-sm"><div class="w-10 h-10 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600"><i class="fas fa-robot"></i></div><div><h4 class="font-bold text-slate-800 text-sm">Auto-Pilot</h4><p class="text-xs text-slate-500" id="autoPayText">Bills logged.</p></div></div>
                    <div id="assetSyncNotification" class="hidden p-4 bg-white border-l-4 border-emerald-500 rounded-2xl flex items-center gap-4 shadow-sm"><div class="w-10 h-10 bg-emerald-50 rounded-full flex items-center justify-center text-emerald-600"><i class="fas fa-sync"></i></div><div><h4 class="font-bold text-slate-800 text-sm">Asset Synced</h4><p class="text-xs text-slate-500" id="assetSyncText">Value updated.</p></div></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="card p-6 border-b-4 border-emerald-500 md:border-b-0 md:border-l-4"><p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Income</p><h2 class="text-3xl font-bold text-slate-800 tracking-tight privacy-target" id="kpiIncome">£0.00</h2></div>
                    <div class="card p-6 border-b-4 border-rose-500 md:border-b-0 md:border-l-4"><p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Expenses</p><h2 class="text-3xl font-bold text-slate-800 tracking-tight privacy-target" id="kpiExpense">£0.00</h2></div>
                    <div class="card p-6 border-b-4 border-indigo-500 md:border-b-0 md:border-l-4"><p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Net Flow</p><h2 class="text-3xl font-bold text-slate-800 tracking-tight privacy-target" id="kpiBalance">£0.00</h2></div>
                    <div class="card p-6 bg-gradient-to-br from-indigo-600 to-violet-600 text-white border-none shadow-lg shadow-indigo-200"><p class="text-xs text-indigo-100 font-bold uppercase tracking-wider mb-1">Top Spend</p><h2 class="text-2xl font-bold mt-1 truncate" id="kpiTopCat">None</h2><p class="text-sm text-indigo-100 font-medium opacity-80 privacy-target" id="kpiTopCatVal">£0.00</p></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="card p-6"><div class="mb-6"><div class="flex justify-between items-center"><h3 class="font-bold text-lg text-slate-800">Analytics</h3><span class="px-3 py-1 bg-slate-100 rounded-full text-xs font-bold text-slate-500">6 Months</span></div><div class="flex gap-6 mt-3"><div><p class="text-[10px] text-slate-400 font-bold uppercase">Total In</p><p class="text-sm font-bold text-emerald-600 privacy-target" id="trendTotalIncome">£0</p></div><div><p class="text-[10px] text-slate-400 font-bold uppercase">Total Out</p><p class="text-sm font-bold text-rose-600 privacy-target" id="trendTotalExpense">£0</p></div></div></div><div class="chart-container"><canvas id="trendChart"></canvas></div></div>
                    <div class="card p-6 flex flex-col items-center justify-center"><h3 class="font-bold text-lg text-slate-800 mb-6 w-full text-left">Breakdown</h3><div class="chart-container"><canvas id="spendingChart"></canvas></div></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="card p-6 h-fit" id="txFormCard">
                        <div class="flex justify-between items-center mb-6"><h3 class="font-bold text-lg text-slate-800" id="txFormTitle">Log Item</h3><button id="cancelEditTxBtn" onclick="cancelTxEdit()" class="hidden text-xs text-rose-500 font-bold">Cancel</button></div>
                        <form id="txForm" class="space-y-5">
                            <div class="grid grid-cols-2 gap-2 p-1 bg-slate-100 rounded-2xl"><button type="button" onclick="setTxType('expense')" id="btn-expense" class="btn-press py-3 rounded-xl text-sm font-bold bg-white text-rose-600 shadow-sm transition-all">Expense</button><button type="button" onclick="setTxType('income')" id="btn-income" class="btn-press py-3 rounded-xl text-sm font-bold text-slate-400 transition-all">Income</button></div>
                            <input type="hidden" id="txType" value="expense"><input type="text" id="txDesc" placeholder="Description" class="input-box" required>
                            <div class="flex gap-3"><input type="number" id="txAmount" placeholder="0.00" step="0.01" class="input-box w-1/2" required><div class="relative w-1/2"><select id="txCategory" class="input-box w-full appearance-none bg-white cursor-pointer"></select><div class="absolute right-4 top-4 text-slate-400 pointer-events-none"><i class="fas fa-chevron-down text-xs"></i></div></div></div>
                            <div class="space-y-3 pt-1">
                                <div id="debtLinkContainer" class="hidden bg-slate-50 p-3 rounded-2xl border border-slate-100"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" id="isDebtPayment" class="w-5 h-5 text-indigo-600 rounded-md border-slate-300 focus:ring-indigo-500"><span class="text-sm font-bold text-slate-700">Is this a Debt Payment?</span></label><div id="debtSelector" class="hidden mt-3"><select id="linkedDebtId" class="input-box bg-white"><option value="">Select Liability...</option></select></div></div>
                                <div id="roundUpContainer" class="hidden bg-slate-50 p-3 rounded-2xl border border-slate-100"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" id="isRoundUp" class="w-5 h-5 text-emerald-600 rounded-md border-slate-300 focus:ring-emerald-500"><div><span class="text-sm font-bold text-slate-700 block">Auto Round-Up</span><span class="text-xs text-slate-400">Save the change</span></div></label><div id="roundUpSelector" class="hidden mt-3"><label class="text-[10px] font-bold text-slate-400 uppercase tracking-wide ml-1">Send to Asset</label><select id="roundUpTarget" class="input-box bg-white mt-1"></select></div></div>
                            </div>
                            <button type="submit" id="submitBtn" class="btn-press w-full py-4 rounded-2xl font-bold text-white bg-rose-600 hover:bg-rose-700 shadow-lg shadow-rose-200 transition-all text-base">Log Expense</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="card p-6 min-h-[400px]">
                            <h3 class="font-bold text-lg text-slate-800 mb-6">History</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse clean-table"><thead class="uppercase"><tr><th>Item</th><th class="text-right">Value</th><th class="text-right">Edit</th></tr></thead><tbody id="txTableBody" class="font-medium"></tbody></table>
                                <div id="listEmptyState" class="hidden py-12 text-center text-slate-400 text-sm font-medium">No transactions this month.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-reports" class="view-section hidden fade-in">
                <div class="mb-8"><h2 class="text-2xl font-bold text-slate-800">Monthly Reports</h2></div>
                <div class="card p-6 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse clean-table min-w-[500px]">
                            <thead class="uppercase"><tr><th>Month</th><th class="text-right text-emerald-600">In</th><th class="text-right text-rose-600">Out</th><th class="text-right text-indigo-600">Net</th><th class="text-right">Rate</th></tr></thead>
                            <tbody id="reportsTableBody" class="font-semibold text-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-calendar" class="view-section hidden fade-in"><div class="flex justify-between items-end mb-8"><div><h2 class="text-2xl font-bold text-slate-800">Bill Calendar</h2><p class="text-slate-500 text-sm mt-1 font-medium">Total: <span id="calTotalBills" class="font-bold text-indigo-600">£0.00</span></p></div><button onclick="switchView('settings')" class="text-xs bg-white border border-slate-200 px-4 py-2 rounded-full font-bold shadow-sm">Manage</button></div><div class="card p-6"><div class="calendar-grid mb-4"><div class="text-[10px] text-slate-400 font-bold text-center uppercase tracking-wide">Mon</div><div class="text-[10px] text-slate-400 font-bold text-center uppercase tracking-wide">Tue</div><div class="text-[10px] text-slate-400 font-bold text-center uppercase tracking-wide">Wed</div><div class="text-[10px] text-slate-400 font-bold text-center uppercase tracking-wide">Thu</div><div class="text-[10px] text-slate-400 font-bold text-center uppercase tracking-wide">Fri</div><div class="text-[10px] text-slate-400 font-bold text-center uppercase tracking-wide">Sat</div><div class="text-[10px] text-slate-400 font-bold text-center uppercase tracking-wide">Sun</div></div><div id="calendarGrid" class="calendar-grid"></div></div></div>
            
            <div id="view-wealth" class="view-section hidden fade-in"><div class="card bg-gradient-to-r from-slate-900 to-slate-800 text-white p-8 md:p-10 mb-8 relative overflow-hidden border-none shadow-2xl"><div class="relative z-10 flex flex-col md:flex-row justify-between items-end gap-6"><div><p class="text-slate-400 font-bold uppercase text-[10px] tracking-widest mb-2">Net Worth</p><h1 class="text-5xl md:text-6xl font-extrabold tracking-tight privacy-target" id="totalWealth">£0.00</h1><div class="mt-4 flex gap-6 text-sm font-medium"><span class="text-emerald-400 flex items-center gap-2"><i class="fas fa-arrow-up"></i> <span class="privacy-target" id="valAssets">£0</span></span><span class="text-rose-400 flex items-center gap-2"><i class="fas fa-arrow-down"></i> <span class="privacy-target" id="valDebt">£0</span></span></div></div><div class="text-right bg-white/10 p-4 rounded-2xl backdrop-blur-md border border-white/10"><p class="text-[10px] text-slate-300 uppercase font-bold tracking-widest mb-1">FIRE Status</p><p class="text-2xl font-bold text-yellow-400" id="fireEstimate">...</p></div></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="space-y-6"><div class="card p-6"><div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4"><h3 class="font-bold text-lg text-slate-800">Assets</h3><button onclick="openWealthModal('asset')" class="text-xs bg-slate-900 text-white font-bold px-4 py-2 rounded-full hover:bg-slate-700 transition">Add</button></div><ul id="assetList" class="space-y-3 max-h-80 overflow-y-auto no-scroll pr-2"></ul></div><div class="card p-6 border-l-4 border-rose-500"><div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4"><h3 class="font-bold text-lg text-slate-800">Liabilities</h3><button onclick="openWealthModal('debt')" class="text-xs bg-rose-600 text-white font-bold px-4 py-2 rounded-full hover:bg-rose-700 transition">Add</button></div><ul id="debtList" class="space-y-3 max-h-80 overflow-y-auto no-scroll pr-2"></ul></div></div><div class="card p-6 flex flex-col items-center"><h3 class="font-bold text-lg text-slate-800 mb-6 w-full">Allocation</h3><div class="chart-container"><canvas id="wealthChart"></canvas></div></div></div></div>

            <div id="view-settings" class="view-section hidden fade-in">
                <div class="card p-8 max-w-2xl mx-auto space-y-10">
                    <div><h2 class="text-2xl font-bold text-slate-800">Settings</h2></div>
                    <div class="bg-indigo-50/50 p-6 rounded-3xl border border-indigo-100"><h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fas fa-cloud text-indigo-600"></i> Cloud Sync</h3><p class="text-xs text-slate-500 mb-4">Link Google Apps Script to sync iPhone & Laptop.</p><div class="flex gap-2"><form id="cloudForm" class="flex-1 flex gap-2"><input type="text" id="cloudUrlInput" placeholder="https://script.google.com/..." class="input-box bg-white" required><button type="submit" class="btn-press px-6 bg-indigo-600 text-white rounded-2xl font-bold shadow-md shadow-indigo-200">Link</button></form><button onclick="disconnectCloud()" class="btn-press px-4 bg-white text-rose-500 border border-rose-100 rounded-2xl font-bold hover:bg-rose-50 transition" title="Disconnect"><i class="fas fa-unlink"></i></button></div><div id="cloudMsg" class="mt-3 text-xs font-bold text-emerald-600 flex items-center gap-2 hidden"><i class="fas fa-check-circle"></i> Sync Active</div></div>
                    <div class="border-b border-slate-100 pb-8"><button onclick="debugData()" class="text-indigo-600 font-bold text-sm flex items-center gap-2 hover:underline"><i class="fas fa-wrench"></i> Debug / Recover Data</button></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div><h3 class="font-bold text-slate-800 mb-4">Budgets</h3><form id="budgetForm" class="flex gap-3 mb-4"><select id="budgetCat" class="input-box w-1/2"></select><input type="number" id="budgetLimit" placeholder="Limit" class="input-box w-1/3" step="0.01" required><button type="submit" class="btn-press w-14 bg-emerald-500 text-white rounded-2xl hover:bg-emerald-600 shadow-md shadow-emerald-200"><i class="fas fa-plus"></i></button></form><ul id="budgetSettingsList" class="space-y-3"></ul></div><div><h3 class="font-bold text-slate-800 mb-4">Goals</h3><button onclick="openGoalModal()" class="w-full py-3 bg-indigo-50 text-indigo-600 font-bold rounded-xl hover:bg-indigo-100 transition">Add New Goal</button><ul id="goalList" class="space-y-3 mt-4"></ul></div></div>
                    <div class="border-t border-slate-100 pt-8" id="billFormContainer"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-800">Recurring Bills</h3><button onclick="cancelBillEdit()" id="cancelBillEditBtn" class="hidden text-xs text-rose-500 font-bold">Cancel</button></div><form id="billForm" class="flex gap-3 mb-4"><input type="number" id="billDay" placeholder="Day" class="input-box w-20 text-center" min="1" max="31" required><input type="text" id="billDesc" placeholder="Bill Name" class="input-box flex-1" required><input type="number" id="billAmount" placeholder="£" class="input-box w-24" step="0.01" required><button type="submit" id="billSubmitBtn" class="btn-press w-14 bg-indigo-600 text-white rounded-2xl hover:bg-indigo-700 shadow-md shadow-indigo-200"><i class="fas fa-plus"></i></button></form><ul id="billList" class="space-y-3"></ul></div>
                    <div class="border-t border-slate-100 pt-8"><h3 class="font-bold text-slate-800 mb-4">Categories</h3><form id="catForm" class="flex gap-3 mb-6"><input type="text" id="newCatName" placeholder="New Category Name" class="input-box" required><button type="submit" class="btn-press px-6 bg-slate-800 text-white rounded-2xl font-bold">Add</button></form><div class="flex flex-wrap gap-2" id="settingsCatList"></div></div>
                    <div class="border-t border-slate-100 pt-8"><button onclick="hardReset()" class="text-rose-500 font-bold text-sm hover:bg-rose-50 px-4 py-2 rounded-xl transition w-full text-center">Reset All App Data</button></div>
                </div>
            </div>

            <div id="wealthFormContainer" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 transition-all"><div class="card p-8 w-full max-w-sm shadow-2xl scale-100"><h3 class="font-bold text-xl mb-6 text-slate-800" id="wealthFormTitle">Add Item</h3><form id="wealthForm" class="space-y-4"><input type="hidden" id="wealthType"><input type="text" id="wealthName" placeholder="Name" class="input-box" required><input type="number" id="wealthValue" placeholder="Value (£)" class="input-box" step="0.01" required><div id="assetTypeContainer"><label class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Category</label><div class="relative mt-1"><select id="wealthCategory" class="input-box appearance-none bg-white"><option value="Savings">Savings</option><option value="Investment">Investment</option><option value="Stock">Stock</option><option value="Crypto">Crypto</option><option value="Property">Property</option><option value="Pension">Pension</option></select><div class="absolute right-4 top-4 text-slate-400 pointer-events-none"><i class="fas fa-chevron-down text-xs"></i></div></div></div><div class="flex gap-3 pt-4"><button type="button" onclick="closeWealthModal()" class="w-1/2 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">Cancel</button><button type="submit" class="w-1/2 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200">Save</button></div></form></div></div>
            <div id="goalFormContainer" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-4"><div class="card p-8 w-full max-w-sm shadow-2xl"><h3 class="font-bold text-xl mb-6 text-slate-800">Add Savings Goal</h3><form id="goalForm" class="space-y-4"><input type="text" id="goalName" placeholder="Goal Name" class="input-box" required><input type="number" id="goalTarget" placeholder="Target Amount (£)" class="input-box" step="0.01" required><input type="number" id="goalCurrent" placeholder="Current Saved (£)" class="input-box" step="0.01" required><div class="flex gap-3 pt-4"><button type="button" onclick="document.getElementById('goalFormContainer').classList.add('hidden')" class="w-1/2 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">Cancel</button><button type="submit" class="w-1/2 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200">Save</button></div></form></div></div>
        </div>
    </div>

    <script>
        // 1. DATA FIXER (Preserves old data but fixes format)
        function fixData() {
            let data = { categories: ['Housing', 'Food', 'Transport', 'Utilities', 'Entertainment', 'Health', 'Savings', 'Debt'], transactions: {}, assets: [], debts: [], recurring: [], budgets: {}, goals: [], billLog: [], annualIncome: 0 };
            try { const raw = localStorage.getItem('infinityDB'); if(raw) { const p = JSON.parse(raw); if(p.categories) data = p; } } catch(e){}
            if(Array.isArray(data.transactions)) data.transactions = {}; // Fix array/object mismatch
            ['assets','debts','recurring','goals','categories'].forEach(k=>{if(!Array.isArray(data[k])) data[k]=[];});
            if(!data.budgets) data.budgets={};
            localStorage.setItem('infinityDB', JSON.stringify(data));
            return data;
        }
        let db = fixData();
        Chart.register(ChartDataLabels);

        let cloudUrl = localStorage.getItem('infinityCloudUrl') || "";
        let privacyMode = localStorage.getItem('infinityPrivacy') === 'true';
        let editingTxIndex = null, editingWealthIndex = null, editingWealthType = null, editingBillIndex = null, currentTxType = 'expense';
        const monthPicker = document.getElementById('monthPicker'); 
        const today = new Date(); 
        monthPicker.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        let trendChart = null, wealthChart = null, spendingChart = null;
        
        // --- MATH HELPERS ---
        const fmt = (num) => parseFloat(num).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        function compactFmt(num) { return Intl.NumberFormat('en-GB', { notation: "compact", maximumFractionDigits: 1 }).format(num); }
        function math(v) { return parseFloat(Number(v).toFixed(2)); } // Fix floating point errors

        function getCategoryColor(c) {
            const map = { 'Debt':'#ef4444', 'Liabilities':'#ef4444', 'Loans':'#ef4444', 'Housing':'#3b82f6', 'Food':'#f59e0b', 'Transport':'#06b6d4', 'Utilities':'#eab308', 'Entertainment':'#8b5cf6', 'Health':'#10b981', 'Savings':'#6366f1' };
            if(map[c]) return map[c];
            let h=0;for(let i=0;i<c.length;i++)h=c.charCodeAt(i)+((h<<5)-h);return ['#14b8a6','#f97316','#d946ef','#0ea5e9','#84cc16'][Math.abs(h)%5];
        }

        function saveData() { localStorage.setItem('infinityDB', JSON.stringify(db)); if(cloudUrl) saveToCloud(); renderAll(); }
        
        function switchView(view) { 
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden')); 
            document.getElementById(`view-${view}`).classList.remove('hidden'); 
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); 
            document.getElementById(`nav-${view}`).classList.add('active'); 
            if(window.innerWidth < 768) toggleMobileMenu(); 
            
            if(view==='dashboard') { setTimeout(() => { if(trendChart) trendChart.resize(); if(spendingChart) spendingChart.resize(); }, 50); }
            if(view==='wealth') { renderWealth(); setTimeout(() => { if(wealthChart) wealthChart.resize(); }, 50); }
            if(view==='reports') renderReports();
            if(view==='calendar') renderCalendar();
            if(view==='settings') renderSettings();
        }

        function renderReports() {
            const tbody = document.getElementById('reportsTableBody'); if(!tbody) return;
            const months = Object.keys(db.transactions).sort().reverse();
            let html = '';
            if (months.length === 0) html = `<tr><td colspan="5" class="text-center py-12 text-slate-400">No records found.</td></tr>`;
            else {
                const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                months.forEach(m => {
                    const txs = db.transactions[m] || [];
                    let inc=0, exp=0;
                    txs.forEach(t => { const v = math(t.amount)||0; if(t.type==='income') inc+=v; else exp+=v; });
                    const net = inc - exp;
                    const rate = inc > 0 ? Math.round((net/inc)*100) : 0;
                    const parts = m.split('-'); 
                    let dLabel = m;
                    if(parts.length===2) { dLabel = `${monthNames[parseInt(parts[1])-1] || parts[1]} ${parts[0]}`; }
                    html += `<tr class="hover:bg-slate-50 transition"><td class="font-bold text-slate-700">${dLabel}</td><td class="text-right text-emerald-600 font-bold">£${fmt(inc)}</td><td class="text-right text-rose-600 font-bold">£${fmt(exp)}</td><td class="text-right text-indigo-600 font-bold">£${fmt(net)}</td><td class="text-right pr-2 text-slate-400">${rate}%</td></tr>`;
                });
            }
            tbody.innerHTML = html;
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid'); if(!grid) return;
            grid.innerHTML = '';
            const [yStr, mStr] = monthPicker.value.split('-');
            const y = parseInt(yStr), m = parseInt(mStr);
            const firstDay = new Date(y, m-1, 1).getDay();
            let pad = firstDay === 0 ? 6 : firstDay - 1;
            const daysInMonth = new Date(y, m, 0).getDate();
            const now = new Date();
            const currentDay = now.getDate();
            
            for(let i=0; i<pad; i++) grid.innerHTML += `<div class="cal-day bg-slate-50/50 border-transparent"></div>`;
            for(let i=1; i<=daysInMonth; i++) {
                let pills = '';
                let bills = db.recurring.filter(b => parseInt(b.day, 10) === i);
                if(i === daysInMonth) {
                    const overflow = db.recurring.filter(b => parseInt(b.day, 10) > daysInMonth);
                    overflow.forEach(b => { b.adj = true; bills.push(b); });
                }
                
                bills.forEach(b => { pills += `<div class="bill-pill ${b.adj?'adjusted':''}">${b.adj?'(Adj) ':''}${b.desc}: £${Math.round(b.amount)}</div>`; delete b.adj; });
                const isToday = (now.getMonth()+1 === m && now.getFullYear() === y && i === currentDay);
                grid.innerHTML += `<div class="cal-day ${isToday?'today':''}"><div class="text-[10px] font-bold ${isToday?'text-amber-500':'text-slate-400'} mb-1">${i}</div><div class="flex flex-col gap-1 overflow-hidden">${pills}</div></div>`;
            }
            const total = db.recurring.reduce((sum, b) => sum + (math(b.amount)||0), 0);
            document.getElementById('calTotalBills').innerText = `£${fmt(total)}`;
        }

        function renderWealth() {
            const al = document.getElementById('assetList'); al.innerHTML = ''; let ta=0;
            db.assets.forEach((a,i) => { ta+=math(a.value); al.innerHTML += `<li class="flex justify-between p-4 bg-slate-50 rounded-2xl mb-2 border border-slate-100"><span>${a.name} <span class="text-xs text-slate-400">(${a.type})</span></span><div class="flex gap-3"><span class="font-bold text-slate-700">£${fmt(a.value)}</span><button onclick="editWealth('asset',${i})" class="text-indigo-400"><i class="fas fa-pen"></i></button><button onclick="deleteWealth('asset',${i})" class="text-rose-500"><i class="fas fa-times"></i></button></div></li>`; });
            const dl = document.getElementById('debtList'); dl.innerHTML = ''; let td=0;
            db.debts.forEach((d,i) => { td+=math(d.value); dl.innerHTML += `<li class="flex justify-between p-4 bg-slate-50 rounded-2xl mb-2 border border-slate-100"><span>${d.name}</span><div class="flex gap-3"><span class="font-bold text-rose-600">£${fmt(d.value)}</span><button onclick="editWealth('debt',${i})" class="text-indigo-400"><i class="fas fa-pen"></i></button><button onclick="deleteWealth('debt',${i})" class="text-rose-500"><i class="fas fa-times"></i></button></div></li>`; });
            document.getElementById('totalWealth').innerText = `£${fmt(ta-td)}`;
            document.getElementById('valAssets').innerText = `£${fmt(ta)}`; document.getElementById('valDebt').innerText = `£${fmt(td)}`;
            const exp = math(document.getElementById('kpiExpense').innerText.replace(/[^0-9.]/g,'')) || 0;
            const pct = (exp*300) > 0 ? ((ta-td)/(exp*300))*100 : 0;
            document.getElementById('fireEstimate').innerText = `${pct.toFixed(1)}%`;
            const types = {}; db.assets.forEach(a => types[a.type] = (types[a.type]||0)+math(a.value)); if(td>0) types['Debt'] = td;
            updateWealthChart(types);
        }

        function renderDashboard() {
            const k = monthPicker.value; const d = db.transactions[k] || []; let i=0, e=0, c={};
            d.forEach(t => { const v=math(t.amount); if(t.type==='income') i+=v; else { e+=v; c[t.category]=(c[t.category]||0)+v; } });
            animateValue(document.getElementById('kpiIncome'), 0, i, 1000); animateValue(document.getElementById('kpiExpense'), 0, e, 1000); animateValue(document.getElementById('kpiBalance'), 0, i-e, 1000);
            let tc="None", tv=0; for(const [k,v] of Object.entries(c)){if(v>tv){tv=v;tc=k;}} document.getElementById('kpiTopCat').innerText=tc; animateValue(document.getElementById('kpiTopCatVal'),0,tv,1000);
            
            const tb = document.getElementById('txTableBody'); tb.innerHTML = '';
            if(d.length===0) document.getElementById('listEmptyState').classList.remove('hidden');
            else { document.getElementById('listEmptyState').classList.add('hidden'); d.slice().reverse().forEach((tx, idx) => { const realIdx = d.length - 1 - idx; tb.innerHTML += `<tr class="hover:bg-slate-50 transition"><td class="font-bold text-slate-700">${tx.desc}<div class="text-xs text-slate-400 font-normal">${tx.category}</div></td><td class="text-right font-bold ${tx.type==='income'?'text-emerald-500':'text-slate-700'} privacy-target">${tx.type==='income'?'+':'-'}£${fmt(tx.amount)}</td><td class="text-right"><button onclick="editTx(${realIdx})" class="text-indigo-400 px-2"><i class="fas fa-pen"></i></button><button onclick="deleteTx(${realIdx})" class="text-rose-500 px-2"><i class="fas fa-trash-alt"></i></button></td></tr>`; }); }
            
            const cy = new Date().getFullYear(); let ytd = 0;
            Object.keys(db.transactions).forEach(mk => { if(mk.startsWith(cy)) db.transactions[mk].forEach(t => { if(t.type==='income') ytd+=math(t.amount); }); });
            document.getElementById('currentYearLabel').innerText = `${cy}`;
            animateValue(document.getElementById('ytdIncomeDisplay'), 0, ytd, 1500);
            animateValue(document.getElementById('annualSalaryDisplay'), 0, db.annualIncome, 1000);
            
            updateTrendChart(); updateSpendingChart(c); updatePrivacyUI();
        }

        // UTILS
        function renderSettings() { const l=document.getElementById('billList'); l.innerHTML=''; db.recurring.forEach((b,i)=>l.innerHTML+=`<li class="flex justify-between p-3 bg-slate-50 rounded-xl mb-2 text-sm border border-slate-100"><span>Day ${b.day}: ${b.desc}</span><span>£${b.amount} <button onclick="deleteBill(${i})" class="text-rose-500 ml-2">x</button></span></li>`); 
            const gl = document.getElementById('goalList'); gl.innerHTML = ''; db.goals.forEach((g,i) => { const p = Math.min((g.current/g.target)*100, 100); gl.innerHTML += `<div class="bg-slate-50 p-3 rounded-xl mb-2 border border-slate-100"><div class="flex justify-between text-xs font-bold mb-1"><span>${g.name}</span><span>£${fmt(g.current)} / £${fmt(g.target)} <button onclick="deleteGoal(${i})" class="text-rose-500 ml-2">x</button></span></div><div class="h-2 bg-slate-200 rounded-full"><div class="h-full bg-emerald-500 rounded-full" style="width:${p}%"></div></div></div>`; });
        }
        function toggleMobileMenu() { const s = document.getElementById('sidebar'); s.classList.toggle('hidden'); s.classList.toggle('flex'); s.classList.toggle('fixed'); s.classList.toggle('inset-0'); }
        function updatePrivacyUI() { document.querySelectorAll('.privacy-target').forEach(e => e.classList.toggle('privacy-blur', privacyMode)); }
        function animateValue(obj, start, end, duration) { if(privacyMode){obj.innerText=`£${fmt(end)}`; return;} let startTimestamp = null; const step = (timestamp) => { if (!startTimestamp) startTimestamp = timestamp; const progress = Math.min((timestamp - startTimestamp) / duration, 1); obj.innerText = `£${fmt(start + progress * (end - start))}`; if (progress < 1) window.requestAnimationFrame(step); }; window.requestAnimationFrame(step); }
        function manualSync() { if(cloudUrl) { saveToCloud(); setTimeout(loadFromCloud, 1000); } else { alert("Connect Cloud in Settings first."); } }
        function disconnectCloud() { cloudUrl = ""; localStorage.removeItem('infinityCloudUrl'); updateCloudUI(); alert("Disconnected from Cloud."); }
        function checkAutoBills() { try { const now = new Date(); const todayNum = now.getDate(); const currentKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`; const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate(); const isLastDay = (todayNum === daysInMonth); db.recurring.forEach(b => { const billDay = parseInt(b.day, 10); let shouldPay = false; if (billDay === todayNum) shouldPay = true; if (isLastDay && billDay > todayNum) shouldPay = true; if(shouldPay) { const pid = `${b.desc}-${currentKey}`; if(!db.billLog.includes(pid)) { if(!db.transactions[currentKey]) db.transactions[currentKey] = []; db.transactions[currentKey].push({ desc: b.desc, amount: b.amount, category: "Bills", type: "expense", isAuto: true }); db.billLog.push(pid); } } }); saveData(); } catch(e) {} }
        function updateCloudUI() { if(cloudUrl) { document.getElementById('cloudUrlInput').value = cloudUrl; document.getElementById('cloudStatus').innerHTML = '<i class="fas fa-cloud text-emerald-500"></i> Cloud Active'; document.getElementById('cloudMsg').classList.remove('hidden'); document.getElementById('manualSyncBtn').classList.remove('hidden'); if(document.getElementById('mobileSyncBtn')) document.getElementById('mobileSyncBtn').classList.remove('hidden'); loadFromCloud(); } else { document.getElementById('cloudUrlInput').value = ''; document.getElementById('cloudStatus').innerHTML = '<i class="fas fa-hdd text-slate-500"></i> Local Mode'; document.getElementById('cloudMsg').classList.add('hidden'); document.getElementById('manualSyncBtn').classList.add('hidden'); if(document.getElementById('mobileSyncBtn')) document.getElementById('mobileSyncBtn').classList.add('hidden'); } }

        document.getElementById('txForm').addEventListener('submit', e => { e.preventDefault(); const k=monthPicker.value; if(!db.transactions[k]) db.transactions[k]=[]; const t = { desc: document.getElementById('txDesc').value, amount: parseFloat(document.getElementById('txAmount').value), category: document.getElementById('txCategory').value, type: currentTxType }; if(editingTxIndex!==null) db.transactions[k][editingTxIndex]=t; else db.transactions[k].push(t); saveData(); cancelTxEdit(); });
        document.getElementById('billForm').addEventListener('submit', e => { e.preventDefault(); db.recurring.push({ day: document.getElementById('billDay').value, desc: document.getElementById('billDesc').value, amount: document.getElementById('billAmount').value }); saveData(); document.getElementById('billForm').reset(); renderSettings(); });
        document.getElementById('wealthForm').addEventListener('submit', e => { e.preventDefault(); const t=document.getElementById('wealthType').value; const o={name:document.getElementById('wealthName').value, value:document.getElementById('wealthValue').value, type:document.getElementById('wealthCategory').value}; if(t==='asset') db.assets.push(o); else db.debts.push(o); saveData(); closeWealthModal(); });
        document.getElementById('goalForm').addEventListener('submit', e => { e.preventDefault(); db.goals.push({ name: document.getElementById('goalName').value, target: document.getElementById('goalTarget').value, current: document.getElementById('goalCurrent').value }); saveData(); document.getElementById('goalFormContainer').classList.add('hidden'); renderSettings(); });
        document.getElementById('catForm').addEventListener('submit', e => { e.preventDefault(); db.categories.push(document.getElementById('newCatName').value); saveData(); });
        document.getElementById('budgetForm').addEventListener('submit', e => { e.preventDefault(); db.budgets[document.getElementById('budgetCat').value] = parseFloat(document.getElementById('budgetLimit').value); saveData(); });
        document.getElementById('cloudForm').addEventListener('submit', e => { e.preventDefault(); cloudUrl = document.getElementById('cloudUrlInput').value; localStorage.setItem('infinityCloudUrl', cloudUrl); alert("Connected!"); updateCloudUI(); saveToCloud(); });

        function editAnnualIncome() { const v=prompt("Annual Salary:", db.annualIncome); if(v) { db.annualIncome=parseFloat(v); saveData(); } }
        function editTx(i) { const t=db.transactions[monthPicker.value][i]; document.getElementById('txDesc').value=t.desc; document.getElementById('txAmount').value=t.amount; document.getElementById('txCategory').value=t.category; setTxType(t.type); editingTxIndex=i; document.getElementById('txFormTitle').innerText="Edit"; document.getElementById('cancelEditTxBtn').classList.remove('hidden'); document.getElementById('txFormCard').scrollIntoView({behavior:'smooth'}); }
        function cancelTxEdit() { document.getElementById('txForm').reset(); editingTxIndex=null; document.getElementById('txFormTitle').innerText="Log Item"; document.getElementById('cancelEditTxBtn').classList.add('hidden'); }
        window.deleteTx = (i) => { db.transactions[monthPicker.value].splice(i,1); saveData(); };
        window.deleteBill = (i) => { db.recurring.splice(i,1); saveData(); renderSettings(); };
        window.deleteWealth = (t,i) => { if(t==='asset') db.assets.splice(i,1); else db.debts.splice(i,1); saveData(); };
        window.deleteGoal = (i) => { db.goals.splice(i,1); saveData(); renderSettings(); };
        window.hardReset = () => { if(confirm("Reset everything?")) { localStorage.removeItem('infinityDB'); location.reload(); } };
        function setTxType(t) { currentTxType = t; document.getElementById('btn-expense').className = t==='expense' ? 'btn-press py-3 rounded-xl text-sm font-bold bg-white text-rose-600 shadow-sm transition-all' : 'btn-press py-3 rounded-xl text-sm font-bold text-slate-400 transition-all'; document.getElementById('btn-income').className = t==='income' ? 'btn-press py-3 rounded-xl text-sm font-bold bg-white text-emerald-600 shadow-sm transition-all' : 'btn-press py-3 rounded-xl text-sm font-bold text-slate-400 transition-all'; if(t==='expense'){document.getElementById('debtLinkContainer').classList.remove('hidden');document.getElementById('roundUpContainer').classList.remove('hidden');}else{document.getElementById('debtLinkContainer').classList.add('hidden');document.getElementById('roundUpContainer').classList.add('hidden');} }
        function openWealthModal(t) { document.getElementById('wealthFormContainer').classList.remove('hidden'); document.getElementById('wealthType').value=t; }
        function closeWealthModal() { document.getElementById('wealthFormContainer').classList.add('hidden'); }
        function openGoalModal() { document.getElementById('goalFormContainer').classList.remove('hidden'); }
        
        // GRAPHS
        function updateSpendingChart(cats){ try{ const ctx=document.getElementById('spendingChart').getContext('2d'); if(spendingChart) spendingChart.destroy(); if(Object.keys(cats).length>0){ spendingChart=new Chart(ctx,{type:'doughnut',data:{labels:Object.keys(cats),datasets:[{data:Object.values(cats),backgroundColor:Object.keys(cats).map(getCategoryColor),borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'70%',plugins:{legend:{display:false},datalabels:{color:'#fff',formatter:(val,ctx)=>{return ctx.chart.data.labels[ctx.dataIndex];}}}}}); } }catch(e){} }
        function updateWealthChart(data){ try{ const ctx=document.getElementById('wealthChart').getContext('2d'); if(wealthChart) wealthChart.destroy(); if(Object.keys(data).length>0){ wealthChart=new Chart(ctx,{type:'doughnut',data:{labels:Object.keys(data),datasets:[{data:Object.values(data),backgroundColor:Object.keys(data).map(getCategoryColor),borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'70%',plugins:{legend:{display:false},datalabels:{color:'#fff',formatter:(val,ctx)=>{return compactFmt(val)}}}}}); } }catch(e){} }
        function updateTrendChart(){ try{ const ctx=document.getElementById('trendChart').getContext('2d'); const l=[],id=[],ed=[]; let d=new Date(); d.setMonth(d.getMonth()-5); for(let i=0;i<6;i++){ const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; l.push(d.toLocaleString('default',{month:'short'})); const t=db.transactions[k]||[]; let inC=0,exC=0; t.forEach(x=>{if(x.type==='income')inC+=math(x.amount);else exC+=math(x.amount)}); id.push(inC); ed.push(exC); d.setMonth(d.getMonth()+1); } if(trendChart) trendChart.destroy(); trendChart=new Chart(ctx,{type:'bar',data:{labels:l,datasets:[{label:'In',data:id,backgroundColor:'#10b981',borderRadius:4,barThickness:12},{label:'Out',data:ed,backgroundColor:'#f43f5e',borderRadius:4,barThickness:12}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{grid:{display:false}},y:{grid:{display:false},ticks:{callback:function(val){return compactFmt(val)}}}},plugins:{legend:{display:false},datalabels:{display:false}}}}); }catch(e){} }

        monthPicker.addEventListener('change', renderAll);
        checkAutoBills();
        renderAll();
    </script>
</body>
</html>
