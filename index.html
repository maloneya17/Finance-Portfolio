<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Dashboard</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* CORE LAYOUT */
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 260px; background-color: #0f172a; color: white; display: flex; flex-direction: column; padding: 24px; flex-shrink: 0; }
        #main-content { flex-grow: 1; overflow-y: auto; padding: 32px; background-color: #f1f5f9; }

        /* UI ELEMENTS */
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; font-weight: 600; color: #94a3b8; cursor: pointer; transition: 0.2s; margin-bottom: 4px; }
        .nav-item:hover { background-color: #1e293b; color: white; }
        .nav-item.active { background-color: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .input-std { width: 100%; padding: 10px 14px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; outline: none; transition: 0.2s; }
        .input-std:focus { border-color: #4f46e5; ring: 2px solid #e0e7ff; }
        .chart-container { position: relative; height: 260px; width: 100%; }
        .hidden { display: none !important; }
        .progress-bar-bg { background-color: #f1f5f9; border-radius: 999px; height: 8px; width: 100%; overflow: hidden; }
        .progress-bar-fill { height: 100%; border-radius: 999px; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div>
            <div class="flex items-center gap-3 mb-10">
                <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center shadow-lg"><i class="fas fa-wallet text-white"></i></div>
                <h1 class="font-bold text-lg leading-tight">Finance<br>Portfolio</h1>
            </div>
            <div class="mb-8">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 block">Timeline</label>
                <input type="month" id="monthPicker" class="w-full p-2 bg-slate-800 border border-slate-700 rounded-lg font-bold text-white text-sm outline-none">
            </div>
            <nav>
                <div onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item active"><i class="fas fa-chart-pie w-5"></i> Dashboard</div>
                <div onclick="switchView('reports')" id="nav-reports" class="nav-item"><i class="fas fa-chart-line w-5"></i> Reports</div>
                <div onclick="switchView('settings')" id="nav-settings" class="nav-item"><i class="fas fa-sliders-h w-5"></i> Settings</div>
            </nav>
        </div>
        <div class="mt-auto pt-6 border-t border-slate-800">
            <button onclick="manualSync()" class="w-full py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-bold text-xs transition mb-2">Sync Cloud</button>
            <div id="syncStatus" class="text-[10px] text-center text-slate-500">Local Mode</div>
        </div>
    </div>

    <div id="main-content">
        
        <div id="view-dashboard" class="view-section">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                <div class="card bg-slate-900 text-white col-span-1 md:col-span-2 lg:col-span-2 relative overflow-hidden group cursor-pointer" onclick="editAnnualIncome()">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fas fa-edit text-6xl"></i></div>
                    <p class="text-xs text-slate-400 font-bold uppercase mb-1">Annual Income Target</p>
                    <h2 class="text-3xl font-extrabold" id="kpiSalary">£0.00</h2>
                    <div class="mt-4 flex gap-4 text-xs font-medium text-slate-400">
                        <span><i class="fas fa-calendar-check text-emerald-400"></i> YTD: <span id="kpiYTD" class="text-white">£0</span></span>
                        <span><i class="fas fa-clock text-indigo-400"></i> Avg: <span id="kpiAvg" class="text-white">£0</span></span>
                    </div>
                </div>
                <div class="card border-l-4 border-emerald-500"><p class="text-xs text-slate-400 font-bold uppercase">Income (Month)</p><h3 class="text-2xl font-bold text-emerald-600 mt-1" id="kpiInc">£0.00</h3></div>
                <div class="card border-l-4 border-rose-500"><p class="text-xs text-slate-400 font-bold uppercase">Expenses (Month)</p><h3 class="text-2xl font-bold text-rose-600 mt-1" id="kpiExp">£0.00</h3></div>
                <div class="card border-l-4 border-violet-500 md:col-span-2 lg:col-span-1"><p class="text-xs text-slate-400 font-bold uppercase">Top Spending</p><h3 class="text-xl font-bold text-violet-600 mt-1 truncate" id="kpiMaxCat">N/A</h3><p class="text-xs text-slate-500 font-medium mt-1" id="kpiMaxVal">£0.00</p></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="card lg:col-span-2"><h3 class="font-bold text-slate-800 mb-4">Cash Flow (6 Months)</h3><div class="chart-container"><canvas id="chartTrend"></canvas></div></div>
                <div class="card"><h3 class="font-bold text-slate-800 mb-4">Spending Breakdown</h3><div class="chart-container"><canvas id="chartSpend"></canvas></div></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="card h-fit">
                    <h3 class="font-bold text-lg mb-4 text-slate-800">Add Transaction</h3>
                    <form id="formTx" class="space-y-4">
                        <div class="grid grid-cols-2 gap-2 p-1 bg-slate-100 rounded-lg">
                            <button type="button" onclick="setTxType('expense')" id="btnExp" class="py-2 rounded-md text-sm font-bold bg-white text-rose-600 shadow-sm transition">Expense</button>
                            <button type="button" onclick="setTxType('income')" id="btnInc" class="py-2 rounded-md text-sm font-bold text-slate-400 transition">Income</button>
                        </div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Description</label><input type="text" id="txDesc" placeholder="e.g. Grocery Shop" class="input-std mt-1" required></div>
                        <div class="flex gap-3">
                            <div class="w-1/2"><label class="text-[10px] font-bold text-slate-400 uppercase">Amount</label><input type="number" id="txAmt" placeholder="0.00" step="0.01" class="input-std mt-1" required></div>
                            <div class="w-1/2"><label class="text-[10px] font-bold text-slate-400 uppercase">Category</label><select id="txCat" class="input-std mt-1 bg-white cursor-pointer" onchange="checkNewCategory(this)"></select></div>
                        </div>
                        <button type="submit" class="w-full py-3 bg-slate-900 hover:bg-slate-800 text-white rounded-lg font-bold text-sm shadow-md transition mt-2">Add Transaction</button>
                    </form>
                </div>
                <div class="card lg:col-span-2 min-h-[400px]">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg text-slate-800">Recent Transactions</h3><span class="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded">This Month</span></div>
                    <div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead><tr class="text-xs text-slate-400 uppercase border-b border-slate-100"><th class="py-2 font-bold pl-2">Description</th><th class="py-2 font-bold text-right">Amount</th><th class="py-2 font-bold text-right pr-2">Action</th></tr></thead><tbody id="listTx" class="text-sm"></tbody></table><div id="emptyState" class="hidden py-12 text-center"><p class="text-slate-400 font-medium text-sm">No transactions yet.</p></div></div>
                </div>
            </div>
        </div>

        <div id="view-reports" class="view-section hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <h2 class="text-2xl font-extrabold text-slate-800">Yearly Analytics</h2>
                <div class="flex gap-2 bg-white p-1 rounded-lg shadow-sm border border-slate-200">
                    <select id="reportYearSelect" class="bg-transparent font-bold text-sm text-slate-700 px-3 py-1 outline-none cursor-pointer" onchange="renderReports()"></select>
                    <button onclick="downloadCSV()" class="bg-slate-800 hover:bg-slate-700 text-white text-xs font-bold px-3 py-1 rounded-md transition"><i class="fas fa-file-csv mr-1"></i> Export Data</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="card border-t-4 border-emerald-500 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div><p class="text-xs font-bold text-slate-400 uppercase tracking-wide">Total Income</p><h3 class="text-2xl font-bold text-emerald-600 mt-1" id="rptInc">£0.00</h3></div>
                        <div class="p-2 bg-emerald-50 rounded-lg text-emerald-500"><i class="fas fa-arrow-down"></i></div>
                    </div>
                </div>
                <div class="card border-t-4 border-rose-500 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div><p class="text-xs font-bold text-slate-400 uppercase tracking-wide">Total Expenses</p><h3 class="text-2xl font-bold text-rose-600 mt-1" id="rptExp">£0.00</h3></div>
                        <div class="p-2 bg-rose-50 rounded-lg text-rose-500"><i class="fas fa-arrow-up"></i></div>
                    </div>
                </div>
                <div class="card border-t-4 border-indigo-500 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div><p class="text-xs font-bold text-slate-400 uppercase tracking-wide">Net Savings</p><h3 class="text-2xl font-bold text-indigo-600 mt-1" id="rptSav">£0.00</h3></div>
                        <div class="p-2 bg-indigo-50 rounded-lg text-indigo-500"><i class="fas fa-piggy-bank"></i></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="card lg:col-span-2">
                    <h3 class="font-bold text-lg text-slate-800 mb-4">Income vs Expense Trend</h3>
                    <div class="chart-container">
                        <canvas id="chartYearly"></canvas>
                    </div>
                </div>
                <div class="card bg-slate-900 text-white flex flex-col justify-center">
                    <div class="mb-4">
                        <div class="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center mb-3"><i class="fas fa-lightbulb text-white"></i></div>
                        <h3 class="text-lg font-bold">Spending Insight</h3>
                        <p class="text-sm text-slate-400 mt-1">Based on your activity this year.</p>
                    </div>
                    <div class="p-4 bg-white/10 rounded-lg border border-white/10">
                        <p class="text-xs font-bold uppercase text-slate-400 tracking-wide mb-1">Status</p>
                        <p class="font-medium text-sm leading-relaxed" id="rptInsightText">Loading insight...</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="card lg:col-span-2">
                    <h3 class="font-bold text-lg text-slate-800 mb-6">Monthly Breakdown</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="text-xs text-slate-400 uppercase border-b border-slate-100">
                                    <th class="py-3 pl-2 font-bold">Month</th>
                                    <th class="py-3 font-bold text-right text-emerald-600">Income</th>
                                    <th class="py-3 font-bold text-right text-rose-600">Expense</th>
                                    <th class="py-3 font-bold text-right text-indigo-600 pr-2">Net</th>
                                </tr>
                            </thead>
                            <tbody id="rptMonthTable" class="text-sm font-medium text-slate-600"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card h-fit">
                    <h3 class="font-bold text-lg text-slate-800 mb-6">Top Spending Categories</h3>
                    <div id="rptCatList" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <div id="view-settings" class="view-section hidden">
            <h2 class="text-2xl font-bold mb-6">Settings</h2>
            <div class="card max-w-md">
                <h3 class="font-bold mb-4">Cloud Sync</h3>
                <form id="formCloud" class="flex gap-2"><input type="text" id="cloudInput" placeholder="Google App URL..." class="input-std"><button class="bg-indigo-600 text-white px-4 rounded-lg font-bold text-xs">Save</button></form>
            </div>
            <div class="mt-8"><button onclick="resetData()" class="text-rose-500 font-bold text-sm">Reset All Data</button></div>
        </div>
    </div>

    <script>
        // --- REGISTER PLUGINS ---
        Chart.register(ChartDataLabels);

        // INIT
        const DEFAULTS = { categories: ['Housing', 'Food', 'Transport', 'Utilities', 'Entertainment', 'Health', 'Savings', 'Debt'], transactions: {}, annualIncome: 0 };
        let db = JSON.parse(localStorage.getItem('infinityDB')) || DEFAULTS;
        if(Array.isArray(db.transactions)) db.transactions = {}; 
        
        let currentTxType = 'expense';
        let trendChart, spendingChart, yearlyChart;
        const monthPicker = document.getElementById('monthPicker');
        
        const math = (v) => parseFloat(Number(v || 0).toFixed(2));
        const fmt = (n) => parseFloat(n).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const save = () => { localStorage.setItem('infinityDB', JSON.stringify(db)); render(); };
        
        const getCatColor = (c) => {
            if(c === 'Debt') return '#ef4444';
            const map = { 'Housing': '#3b82f6', 'Food': '#f59e0b', 'Transport': '#06b6d4', 'Utilities': '#eab308', 'Entertainment': '#8b5cf6', 'Health': '#10b981', 'Savings': '#6366f1' };
            if(map[c]) return map[c];
            let hash = 0;
            for (let i = 0; i < c.length; i++) hash = c.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${45 + (Math.abs(hash) % 255)}, 75%, 55%)`;
        };

        // --- DASHBOARD RENDER ---
        function render() {
            const key = monthPicker.value;
            const data = db.transactions[key] || [];
            let inc = 0, exp = 0, cats = {};
            const list = document.getElementById('listTx');
            list.innerHTML = '';

            data.forEach((t, i) => {
                const val = math(t.amount);
                if(t.type === 'income') inc += val; else { exp += val; cats[t.category] = (cats[t.category] || 0) + val; }
                const colorClass = t.type === 'income' ? 'text-emerald-600' : 'text-rose-600';
                list.insertAdjacentHTML('afterbegin', `<tr class="border-b border-slate-50 hover:bg-slate-50 transition"><td class="py-3 pl-2"><div class="font-bold text-slate-700">${t.desc}</div><div class="text-[10px] text-slate-400 font-bold uppercase tracking-wide">${t.category}</div></td><td class="text-right font-bold ${colorClass}">£${fmt(val)}</td><td class="text-right pr-2"><button onclick="delTx(${i})" class="text-slate-300 hover:text-rose-500 transition px-2"><i class="fas fa-trash-alt"></i></button></td></tr>`);
            });

            document.getElementById('emptyState').classList.toggle('hidden', data.length > 0);
            document.getElementById('kpiInc').innerText = `£${fmt(inc)}`;
            document.getElementById('kpiExp').innerText = `£${fmt(exp)}`;
            document.getElementById('kpiSalary').innerText = `£${fmt(db.annualIncome)}`;
            
            const year = key.split('-')[0];
            let ytd = 0;
            Object.keys(db.transactions).forEach(k => { if(k.startsWith(year)) db.transactions[k].forEach(t => { if(t.type === 'income') ytd += math(t.amount); }); });
            document.getElementById('kpiYTD').innerText = `£${fmt(ytd)}`;
            document.getElementById('kpiAvg').innerText = `£${fmt(ytd / (new Date().getMonth() + 1))}`;

            let maxCat = 'N/A'; let maxVal = 0;
            for(const [c, v] of Object.entries(cats)) { if(v > maxVal) { maxVal = v; maxCat = c; } }
            document.getElementById('kpiMaxCat').innerText = maxCat;
            document.getElementById('kpiMaxVal').innerText = `£${fmt(maxVal)}`;

            renderDropdowns();
            updateCharts(cats);
        }

        function renderDropdowns() {
            const select = document.getElementById('txCat');
            const currentVal = select.value;
            select.innerHTML = '';
            db.categories.forEach(c => { select.innerHTML += `<option value="${c}">${c}</option>`; });
            select.innerHTML += `<option value="ADD_NEW_CAT" class="font-bold text-indigo-600">+ Add New...</option>`;
            if(db.categories.includes(currentVal)) select.value = currentVal;
        }
        function checkNewCategory(select) { if(select.value === 'ADD_NEW_CAT') { const newCat = prompt("Enter new Category Name:"); if(newCat && newCat.trim() !== "") { db.categories.push(newCat.trim()); save(); renderDropdowns(); select.value = newCat.trim(); } else { select.value = db.categories[0]; } } }

        function updateCharts(cats) {
            Chart.defaults.font.family = "'Inter', sans-serif";
            const ctxSpend = document.getElementById('chartSpend').getContext('2d');
            if(spendingChart) spendingChart.destroy();
            spendingChart = new Chart(ctxSpend, {
                type: 'doughnut', plugins: [ChartDataLabels],
                data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: Object.keys(cats).map(getCatColor), borderWidth: 2, borderColor: '#ffffff', hoverOffset: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 8, font: { size: 10 } } }, datalabels: { color: '#ffffff', font: { weight: 'bold', size: 11 }, formatter: (value, ctx) => { let sum = 0; ctx.chart.data.datasets[0].data.map(data => sum += data); let pct = (value * 100 / sum); if(pct < 5) return null; return pct.toFixed(0) + "%"; }, textShadowColor: 'rgba(0, 0, 0, 0.5)', textShadowBlur: 4 } } }
            });

            const ctxTrend = document.getElementById('chartTrend').getContext('2d');
            if(trendChart) trendChart.destroy();
            const labels = [], dInc = [], dExp = [];
            let d = new Date(); d.setMonth(d.getMonth() - 5);
            for(let i=0; i<6; i++) {
                const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                labels.push(d.toLocaleString('default', { month: 'short' }));
                const txs = db.transactions[k] || [];
                let _i = 0, _e = 0;
                txs.forEach(t => { if(t.type==='income') _i+=t.amount; else _e+=t.amount; });
                dInc.push(_i); dExp.push(_e);
                d.setMonth(d.getMonth() + 1);
            }
            const totalInc = dInc.reduce((a,b)=>a+b, 0);
            const totalExp = dExp.reduce((a,b)=>a+b, 0);
            trendChart = new Chart(ctxTrend, {
                type: 'bar', plugins: [ChartDataLabels],
                data: { labels: labels, datasets: [ { label: 'Income', data: dInc, backgroundColor: '#10b981', borderRadius: 6, barThickness: 16 }, { label: 'Expenses', data: dExp, backgroundColor: '#f43f5e', borderRadius: 6, barThickness: 16 } ] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { grid: { color: '#f1f5f9' }, ticks: { callback: v => (v >= 1000 ? v/1000 + 'k' : v) } } }, plugins: { legend: { display: false }, datalabels: { display: false } } },
                plugins: [{ id: 'customTotals', afterDraw: (chart) => { const { ctx, chartArea: {top, left} } = chart; ctx.save(); ctx.font = "bold 12px Inter"; ctx.textAlign = 'left'; ctx.fillStyle = '#059669'; ctx.fillText(`Inc: £${fmt(totalInc)}`, left + 5, top + 15); ctx.fillStyle = '#e11d48'; ctx.fillText(`Exp: £${fmt(totalExp)}`, left + 5, top + 32); ctx.restore(); } }]
            });
        }

        // --- REPORTS LOGIC ---
        function renderReports() {
            // 1. Get Years
            const years = new Set([new Date().getFullYear()]);
            Object.keys(db.transactions).forEach(k => years.add(parseInt(k.split('-')[0])));
            const yearList = Array.from(years).sort((a,b) => b - a);
            
            const sel = document.getElementById('reportYearSelect');
            if(sel.options.length === 0 || sel.options.length !== yearList.length) {
                const savedVal = sel.value;
                sel.innerHTML = '';
                yearList.forEach(y => sel.innerHTML += `<option value="${y}">${y}</option>`);
                if(yearList.includes(parseInt(savedVal))) sel.value = savedVal;
            }

            const targetYear = sel.value;
            let annInc = 0, annExp = 0, annCat = {};
            const monthTable = document.getElementById('rptMonthTable');
            monthTable.innerHTML = '';

            // Arrays for Line Chart
            const chLabels = [];
            const chIncData = [];
            const chExpData = [];

            // 2. Iterate Months 01-12
            for(let m=1; m<=12; m++) {
                const mk = `${targetYear}-${String(m).padStart(2,'0')}`;
                const txs = db.transactions[mk] || [];
                let mInc = 0, mExp = 0;

                txs.forEach(t => {
                    const v = math(t.amount);
                    if(t.type === 'income') { mInc += v; annInc += v; }
                    else { mExp += v; annExp += v; annCat[t.category] = (annCat[t.category] || 0) + v; }
                });

                // Add to Chart Data
                chLabels.push(new Date(targetYear, m-1).toLocaleString('default', { month: 'short' }));
                chIncData.push(mInc);
                chExpData.push(mExp);

                // Row for Table
                if(mInc > 0 || mExp > 0) {
                    const monthName = new Date(targetYear, m-1).toLocaleString('default', { month: 'long' });
                    const net = mInc - mExp;
                    const netColor = net >= 0 ? 'text-indigo-600' : 'text-rose-600';
                    monthTable.innerHTML += `<tr class="border-b border-slate-50 hover:bg-slate-50"><td class="py-3 pl-2 font-medium">${monthName}</td><td class="text-right text-emerald-600">£${fmt(mInc)}</td><td class="text-right text-rose-600">£${fmt(mExp)}</td><td class="text-right pr-2 font-bold ${netColor}">£${fmt(net)}</td></tr>`;
                }
            }
            if(monthTable.innerHTML === '') monthTable.innerHTML = `<tr><td colspan="4" class="py-8 text-center text-slate-400 text-xs">No data for ${targetYear}</td></tr>`;

            // 3. Update Cards
            document.getElementById('rptInc').innerText = `£${fmt(annInc)}`;
            document.getElementById('rptExp').innerText = `£${fmt(annExp)}`;
            document.getElementById('rptSav').innerText = `£${fmt(annInc - annExp)}`;

            // 4. Update Category List
            const catList = document.getElementById('rptCatList');
            catList.innerHTML = '';
            const sortedCats = Object.entries(annCat).sort(([,a], [,b]) => b - a);
            
            if(sortedCats.length === 0) {
                catList.innerHTML = `<p class="text-slate-400 text-xs text-center py-4">No spending data yet.</p>`;
            } else {
                const maxVal = sortedCats[0][1];
                sortedCats.forEach(([cat, val]) => {
                    const pct = (val / maxVal) * 100;
                    const color = getCatColor(cat);
                    catList.innerHTML += `
                    <div>
                        <div class="flex justify-between text-xs font-bold mb-1">
                            <span class="text-slate-700">${cat}</span>
                            <span class="text-slate-500">£${fmt(val)}</span>
                        </div>
                        <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${pct}%; background-color:${color}"></div></div>
                    </div>`;
                });
            }

            // 5. Render Yearly Line Chart
            const ctxYear = document.getElementById('chartYearly').getContext('2d');
            if(yearlyChart) yearlyChart.destroy();
            yearlyChart = new Chart(ctxYear, {
                type: 'line',
                data: {
                    labels: chLabels,
                    datasets: [
                        { label: 'Income', data: chIncData, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.4, fill: true, pointRadius: 3 },
                        { label: 'Expense', data: chExpData, borderColor: '#f43f5e', backgroundColor: 'rgba(244, 63, 94, 0.1)', tension: 0.4, fill: true, pointRadius: 3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' }, datalabels: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } }
                }
            });

            // 6. Generate "Spending Insight"
            const activeMonths = chExpData.filter(v => v > 0);
            const rptText = document.getElementById('rptInsightText');
            
            if(activeMonths.length < 2) {
                rptText.innerText = "Not enough data yet. Keep adding transactions to unlock insights!";
            } else {
                const lastMonthVal = activeMonths[activeMonths.length - 1];
                const prevMonths = activeMonths.slice(0, activeMonths.length - 1);
                const avg = prevMonths.reduce((a,b)=>a+b, 0) / prevMonths.length;
                
                if(lastMonthVal > avg) {
                    const pct = ((lastMonthVal - avg) / avg * 100).toFixed(0);
                    rptText.innerHTML = `⚠️ Your recent spending is <span class="text-orange-400 font-bold">${pct}% higher</span> than your monthly average (£${fmt(avg)}). Try to reduce discretionary spending next month.`;
                } else {
                    const pct = ((avg - lastMonthVal) / avg * 100).toFixed(0);
                    rptText.innerHTML = `✅ Great job! Your recent spending is <span class="text-emerald-400 font-bold">${pct}% lower</span> than your monthly average (£${fmt(avg)}). Keep saving!`;
                }
            }
        }

        function downloadCSV() {
            const rows = [['Date', 'Description', 'Category', 'Type', 'Amount']];
            Object.keys(db.transactions).forEach(dateKey => {
                db.transactions[dateKey].forEach(t => {
                    rows.push([dateKey, t.desc, t.category, t.type, t.amount]);
                });
            });
            const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "finance_portfolio_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // UTILS
        function setTxType(type) { currentTxType = type; document.getElementById('btnExp').className = type === 'expense' ? "flex-1 py-2 bg-rose-100 text-rose-600 rounded-lg font-bold text-sm transition" : "flex-1 py-2 text-slate-400 hover:bg-slate-50 rounded-lg font-bold text-sm transition"; document.getElementById('btnInc').className = type === 'income' ? "flex-1 py-2 bg-emerald-100 text-emerald-600 rounded-lg font-bold text-sm transition" : "flex-1 py-2 text-slate-400 hover:bg-slate-50 rounded-lg font-bold text-sm transition"; }
        document.getElementById('formTx').addEventListener('submit', e => { e.preventDefault(); const k = monthPicker.value; if(!db.transactions[k]) db.transactions[k] = []; db.transactions[k].push({ desc: document.getElementById('txDesc').value, amount: math(document.getElementById('txAmt').value), category: document.getElementById('txCat').value, type: currentTxType }); document.getElementById('txDesc').value = ''; document.getElementById('txAmt').value = ''; save(); });
        
        window.switchView = (id) => { 
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden')); 
            document.getElementById(`view-${id}`).classList.remove('hidden'); 
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active')); 
            document.getElementById(`nav-${id}`).classList.add('active'); 
            if(id === 'reports') renderReports(); // Trigger Report Render
        };
        window.delTx = (i) => { if(confirm("Delete this transaction?")) { db.transactions[monthPicker.value].splice(i, 1); save(); } };
        window.editAnnualIncome = () => { const v = prompt("Enter Annual Salary Target (£):", db.annualIncome); if(v) { db.annualIncome = math(v); save(); } };
        window.resetData = () => { if(confirm("Reset all data?")) { localStorage.removeItem('infinityDB'); location.reload(); } };
        window.manualSync = () => alert("Cloud Sync logic preserved but hidden for UI focus.");

        const now = new Date();
        monthPicker.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        monthPicker.addEventListener('change', render);
        render();
    </script>
</body>
</html>
